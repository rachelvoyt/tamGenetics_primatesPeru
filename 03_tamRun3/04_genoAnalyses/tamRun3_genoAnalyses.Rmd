---
title: "tamRun3_genoAnalyses"
author: "Rachel Voyt"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(janitor)
library(related) # (install from tar.gz file); pairwise relatedness
```

# 1 Overview

This pipeline is for the analysis of genotypes acquired via
GTscorePipeline_tamRun3.Rmd, including comparisons to metadata and
investigation of mismatches.

# 2 Data

## 2.1 Metadata

Below is the metadata for samples included in tamRun3. I've also included columns to indicate whether samples were included in either of the two previous runs (tamRun1 and tamRun2) so that we can compare genotypes when possible.

```{r}
# tamGenetics_run1
md_tamRun1 <- read.csv("./../../00_tamRun1_optimization/metadata_run1.csv") %>%
  select(c(sampleID, animalID, sampleType)) %>%
  distinct() %>%
  na.omit() %>%
  group_by(animalID, sampleType) %>%
  summarise(tamRun1 = toString(sampleID)) %>%
  ungroup()

# tamGenetics_run2
md_tamRun2 <- read.csv("./../../01_run2_fecalHairBlood/03_run2GTscore/metadata_tamRun2.csv") %>%
  filter(included_inRun == "yes") %>%
  select(c(sampleID, animalID, sampleType)) %>%
  distinct() %>%
  na.omit() %>%
  group_by(animalID, sampleType) %>%
  summarise(tamRun2 = toString(sampleID)) %>%
  ungroup()

# tamGenetics_run3 (current run)
md_tamRun3 <- read.csv("./../03_run3GTscore/tamRun3_metadata_12Jan2022.csv") %>%
  mutate(sampleID = gsub("_","\\.", sampleID)) %>%
  #mutate(sampleFile = paste0(sampleID, ".fastq")) %>%
  #unite(pcr1, pcr1Plate, pcr1Row, sep = "-", remove = T) %>%
  #unite(pcr1, pcr1, pcr1Col, sep = "", remove = T) %>%
  merge(., md_tamRun1, by = c("animalID", "sampleType"), all.x = T) %>%
  merge(., md_tamRun2, by = c("animalID", "sampleType"), all.x = T)
```

## 2.2 Genotypes

Genotypes and metadata are below. Note that genotypes were only called
for loci with at least 10x coverage.

Genotypes from tamRun3

```{r}
genos_fullSet <- read.table("./../03_run3GTscore/fullSet_polyGenResults_singleSNP.txt", header = T)
```

# 3 Species assignments

For all samples, including chimeric blood samples, we should expect 100% congruence with metadata.

Things to keep in mind:

-   all SPECIESID loci are in primer pool 2

## 3.1 Assign species to genotypes

Species key:

```{r}
speciesKey <- read.csv("speciesSNP_key_14Dec2022.csv")
```

Species assignments:

```{r}
genos_species <- genos_fullSet %>%
  rownames_to_column("Locus") %>%
  filter(str_detect(Locus, "SPECIES")) %>%
  mutate(Locus = sub('[_][^_]+$', '', Locus)) %>%
  mutate(across(everything(), as.character)) %>%
  pivot_longer(!Locus,
               names_to = "sampleID",
               values_to = "genotype") %>%
  left_join(speciesKey, by = c("Locus", "genotype")) %>%
  mutate(species = coalesce(species, genotype)) %>%
  select(c(Locus, sampleID, species)) %>%
  pivot_wider(names_from = sampleID,
              values_from = species) %>%
  column_to_rownames("Locus") %>%
  t() %>%
  as.data.frame() %>%
  mutate(totalGenos_sp = (rowSums(. == "LWED") + rowSums(. == "SIMP"))) %>%
  mutate(propGenos_sp = (totalGenos_sp/12)) %>%
  mutate(propLWED = (rowSums(. == "LWED")/totalGenos_sp)) %>%
  mutate(propSIMP = (rowSums(. == "SIMP")/totalGenos_sp)) %>%
  mutate(propMismatch_species = (1 - abs(propLWED - propSIMP))) %>%
  mutate(speciesAssigned = ifelse(propLWED == 1, "LWED", ifelse(propSIMP == 1, "SIMP", NA))) %>%
  rownames_to_column("sampleID") %>%
  relocate(c(speciesAssigned, totalGenos_sp, propMismatch_species, propLWED, propSIMP, propGenos_sp), .after = sampleID)
```

## 3.2 Metadata comparison

316 out of 438 samples were assigned a species. After comparing with metadata, we see that we have 17 mismatches total.

```{r}
# How many assignments were made?
length(na.omit(genos_species$speciesAssigned))

# Check (mis)matches
genos_species_md <- md_tamRun3 %>%
  select(c(sampleID, animalID, species, sampleType, tamRun1, tamRun2)) %>%
  merge(., genos_species, by = "sampleID") %>%
  mutate(mdMatch_sp = ifelse(species == speciesAssigned,"TRUE", "FALSE")) %>%
  relocate(animalID, .after = sampleID) %>%
  relocate(mdMatch_sp, .after = animalID)

# Extract samples with mismatches
genos_species_mismatch <- genos_species_md %>%
  filter(mdMatch_sp == "FALSE")
```

# 4 Sex assignments

Things to keep in mind: \* We have 12 SEXID total, with 4 SIMP-specific
and 2 LWED-specific

-   7 SEXID loci are in primer pool 2:
    -   197 SIMP
    -   198 SIMP
    -   200
    -   203 SIMP
    -   218 SIMP
    -   219
    -   222
-   5 SEXID loci are in primer pool 3:
    -   195 LWED
    -   205
    -   208 LWED
    -   209
    -   215

## 4.1 Assign sex to genotypes

Sex key:

```{r}
sexKey <- read.csv("sexSNP_key_8Dec2022.csv") %>%
  na.omit() %>%
  unique()
```

Sex assignments:

```{r}
genos_sex <- genos_fullSet %>%
  rownames_to_column("Locus") %>%
  filter(str_detect(Locus, "SEXID")) %>%
  mutate(Locus = sub('[_][^_]+$', '', Locus)) %>%
  mutate(across(everything(), as.character)) %>%
  pivot_longer(!Locus,
               names_to = "sampleID",
               values_to = "genotype") %>%
  left_join(sexKey, by = c("Locus", "genotype")) %>%
  mutate(sex = coalesce(sex, genotype)) %>%
  select(c(Locus, sampleID, sex)) %>%
  pivot_wider(names_from = sampleID,
              values_from = sex) %>%
  column_to_rownames("Locus") %>%
  t() %>%
  as.data.frame() %>%
  mutate(totalGenos_sex = (rowSums(. == "F") + rowSums(. == "M"))) %>%
  mutate(propGenos_sex = (totalGenos_sex/12)) %>%
  mutate(propF = (rowSums(. == "F")/totalGenos_sex)) %>%
  mutate(propM = (rowSums(. == "M")/totalGenos_sex)) %>%
  mutate(propMismatch_sex = (1 - abs(propF - propM))) %>%
  mutate(sexAssigned = ifelse(propF == 1, "F", ifelse(propM == 1, "M", NA))) %>%
  rownames_to_column("sampleID") %>%
  relocate(c(sexAssigned, totalGenos_sex, propMismatch_sex, propF, propM, propGenos_sex), .after = sampleID) %>%
  relocate(c(SEXID_SIMP_197, SEXID_SIMP_198, SEXID_200, SEXID_SIMP_203, SEXID_SIMP_218, SEXID_219, SEXID_222), .after = propGenos_sex)
```

## 4.2 Metadata comparisons

237 out of 438 samples were assigned a sex. For mismatches, we're pulling sex assignment mismatches among hair samples only, since chimerism in blood is likely to result in mismatches if the individual is part of a F/M twin pair.

Among hair samples, we have 9 mismatches total. Some things to note:

-   5 of these only have one genotype called out of 12
-   for those with more than 1 SEXID genotype called, all sex
    assignments were in 100% agreement

```{r}
# How many assignments were made?
length(na.omit(genos_sex$sexAssigned))

# Check (mis)matches
genos_sex_md <- md_tamRun3 %>%
  select(c(sampleID, sex, sampleType)) %>%
  merge(., genos_sex, by = "sampleID") %>%
  mutate(mdMatch_sex = ifelse(sex == sexAssigned,"TRUE", "FALSE")) %>%
  relocate(mdMatch_sex, .after = sampleID)

# Extract samples with mismatches
genos_sex_mismatch <- genos_sex_md %>%
  filter(mdMatch_sex == "FALSE")

# Extract samples with mismatches - hair samples only for now
genos_sex_mismatch_hair <- genos_sex_mismatch %>%
  filter(sampleType == "hair")
```

# 5 Investigating mismatches

## 5.1 Species mismatches

Of the 17 mismatches, we have 8 hair samples, 1 PCR1 (-), and 8 blood samples. Note that the negative controls shouldn't have any genotypes at all; these are part of a separate troubleshooting analysis.

```{r}
# Hair sample mismatches
sum(str_count(genos_species_mismatch$sampleType, "hair"))

# Blood sample mismatches
sum(str_count(genos_species_mismatch$sampleType, "blood"))
```

Are any animalIDs mismatched in both hair and blood samples? -- yes, we have one pair

```{r}
genos_species_mismatch %>%
  get_dupes(animalID)
```

#########IGNORE ALL BELOW#########

First let's make a dataframe combining samples with mismatched species
and/or sex assignments:

```{r}
# Combine samples with species and/or sex mismatches
speciesSex_mismatches <- merge(genos_species_md, genos_sex_md, by = c("sampleID", "sampleType")) %>%
  relocate(c(mdMatch_sp, mdMatch_sex), .after = sampleID) %>%
  filter(if_any(starts_with("mdMatch"), ~ . == "FALSE"))

speciesSex_mismatches_hair <- speciesSex_mismatches %>%
  filter(sampleType == "hair")
```

## 5.1 Split primer pools

In primer pool 2, we have:

-   all SPECIESID loci
-   6 LWED-specific loci
-   no SIMP-specific loci

In primer pool 3, we have:

-   no SPECIESID loci
-   26 LWED-specific loci
-   all SIMP-specific loci

For hair samples with mismatches, let's take a closer look at the genotypes from loci in primer pool 2 vs. primer pool 3

```{r}
pp2 <- read.table("p2_combined_primerProbeFile.txt", header = T) %>%
  mutate(Locus = sub('[.][^.]+$', '', Locus)) %>%
  mutate(primerPool = "pool2") %>%
  select(c(Locus, primerPool))
pp3 <- read.table("p3_combined_primerProbeFile.txt", header = T) %>%
  mutate(Locus = sub('[.][^.]+$', '', Locus)) %>%
  mutate(primerPool = "pool3") %>%
  select(c(Locus, primerPool))
splitPools <- rbind(pp2, pp3) %>%
  mutate(Locus = str_replace(Locus, 'SEXID_195', 'SEXID_LWED_195')) %>%
  mutate(Locus = str_replace(Locus, 'SEXID_197', 'SEXID_SIMP_197')) %>%
  mutate(Locus = str_replace(Locus, 'SEXID_198', 'SEXID_SIMP_198')) %>%
  mutate(Locus = str_replace(Locus, 'SEXID_203', 'SEXID_SIMP_203')) %>%
  mutate(Locus = str_replace(Locus, 'SEXID_208', 'SEXID_LWED_208')) %>%
  mutate(Locus = str_replace(Locus, 'SEXID_211', 'SEXID_LWED_211')) %>%
  mutate(Locus = str_replace(Locus, 'SEXID_218', 'SEXID_SIMP_218'))

genos_mismatches_hair <- genos_fullSet %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("sampleID") %>%
  filter(sampleID %in% speciesSex_mismatches_hair$sampleID) %>%
  column_to_rownames("sampleID") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Locus") %>%
  mutate(Locus = sub('[_][^_]+$', '', Locus)) %>%
  merge(., splitPools, by = "Locus") %>%
  relocate(primerPool, .after = "Locus")
```


