---
title: "tamGenetics_ot2InputFiles"
author: "Rachel Voyt"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1 Overview

This document is for the creation of input files for the tamGenetics OT2 protocols, incuding:

1. PCR1 setup
2. 1:20 dilutions
3. PCR2 setup
4. Bead cleanups

# 2 Packages

```{r}
library(tidyverse)
library(readxl)
```

# 3 Static input values

## 3.1 Labware, pipettes, & tipracks

```{r}
# Labware
deepwellPlate <- "vwr_96_wellplate_1000ul"
nestPlate <- "nest_96_wellplate_100ul_pcr_full_skirt"
basePlate <- "denvillewithaxygenbase_96_wellplate_200ul"
tuberack <- "opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap"
reservoir_12well <- "nest_12_reservoir_15ml"
magblock <- "magnetic_module_gen2"

# Pipettes
s20 <- "p20_single_gen2"
m20 <- "p20_multi_gen2"
s300 <- "p300_single_gen2"
m300 <- "p300_multi_gen2"

# Tipracks
tiprack_p20 <- "opentrons_96_tiprack_300ul"
tiprack_p20f <- "opentrons_96_filtertiprack_20ul"
tiprack_p300 <- "opentrons_96_tiprack_300ul"
tiprack_p300f <- "opentrons_96_filtertiprack_200ul"
```

## 3.2 Well values

```{r}
# Row values
rowValues_plate <- rep(LETTERS[1:8], times = 12)
rowValues_tuberack <- rep(LETTERS[1:4], times = 6)

# Column values
colValues_plate <- rep(1:12, times = 8) %>%
  sort() %>%
  as.character()
colValues_tuberack <- rep(1:6, times = 4) %>%
  sort() %>%
  as.character()

# Well values
wellValues_plate <- str_c(rowValues_plate, colValues_plate)
wellValues_tuberack <- str_c(rowValues_tuberack, colValues_tuberack)
```

## 3.3 csv headers

```{r}
transferHeaders <- c("ot2set",
                 "reagent",
                 "source_labware",
                 "source_slot",
                 "source_well",
                 "asp_height",
                 "dest_labware",
                 "dest_slot",
                 "dest_well",
                 "transfer_volume")
```

# 4 OT2 input for PRIMER protocols

## 4.1 Primer rehydration (200 uM)

### 4.1.1 Data

```{r}
plateSpecs_p56 <- read_excel("./primers/02_rehydrationPooling/plateSpecs_tamGenetics_primerPlates5,6.xlsx") %>%
  as.data.frame() %>%
  rename_with(make.names)
```

### 4.1.2 OT2 csv

```{r}
ot2csv_p56Rehydrate <- plateSpecs_p56 %>%
  arrange(Plate.Name, Well.Position) %>%
  mutate(source_labware = "nest_12_reservoir_15ml",
         source_slot = case_when(
           Plate.Name == "tamGenetics_primersPlate5" ~ 2,
           Plate.Name == "tamGenetics_primersPlate6" ~ 5
         ),
         source_well = c(rep("A1", 70), rep("A2", 70)),
         asp_height = 1,
         dest_labware = "vwr_96_wellplate_1000ul",
         dest_slot = case_when(
           Plate.Name == "tamGenetics_primersPlate5" ~ 3,
           Plate.Name == "tamGenetics_primersPlate6" ~ 6),
         transfer_volume = round(5*nmoles, 1)) %>%
  mutate(dest_well = gsub("0", "", Well.Position)) %>%
  mutate(destRow = str_sub(dest_well, 1, 1),
         destCol = str_sub(dest_well, 2, length(dest_well))) %>%
  arrange(dest_slot, destCol, destRow) %>%
  select(c("source_labware", "source_slot", "source_well", "asp_height", "dest_labware", "dest_slot", "dest_well", "transfer_volume"))

write.csv(ot2csv_p56Rehydrate, "./robotProtocols/inputFiles/tamGenetics_primerRehydration200uM_primerPlates5,6.csv", row.names = F)
```

## 4.2 Primer dilutions & pooling (post-opt2)

### 4.2.1 Data

```{r}
# Primer pool splits
primerPool_splitsOriginal <- read.csv("./primers/03_lociChoices/primerPool_splits.csv")

primerPool2 <- primerPool_splitsOriginal %>%
  filter(primerPool == 2)

primerPool3 <- primerPool_splitsOriginal %>%
  filter(primerPool == 3)

# Primer list post-optimization 2
primers_postOpt2 <- read.csv("./primers/03_lociChoices/tamGenetics_primerList_v3.csv")

# Dilution plate post-optimization 2
dilutionPlate <- read.csv("./primers/03_lociChoices/tamGenetics_primerList_v3_toDilute.csv")
```

### 4.2.2 Primer dilutions

#### Add primers, then water

SKIP adding water; do this manually instead.

```{r}
# Add primers to dilution plate
primers_toDilutionPlate <- dilutionPlate %>%
  select(-plate) %>%
  mutate(source_slot = case_when(originalPlate == 1 ~ 2,
                                 originalPlate == 2 ~ 5,
                                 originalPlate == 5 ~ 5,
                                 originalPlate == 6 ~ 8)) %>%
  dplyr::rename("plate" = "originalPlate",
                "source_well" = "originalWell",
                "dest_well" = "dilutionPlate_well",
                "transfer_volume" = "ulPrimer_toAdd") %>%
  mutate(dest_slot = 11,
         source_labware = "vwr_96_wellplate_1000ul",
         dest_labware = "nest_96_wellplate_100ul_pcr_full_skirt",
         transfer_volume = 10) %>%
  select(c("plate", "source_labware", "source_slot", "source_well", "dest_labware", "dest_slot", "dest_well", "transfer_volume", "bp3index"))

# Add water to dilution plate
#water_forDilutions <- dilutionPlate %>%
#  select(-plate) %>%
#  dplyr::rename("plate" = "originalPlate",
#                "transfer_volume" = "ulWater_toAdd",
#                "dest_well" = "dilutionPlate_well") %>%
#  mutate(source_slot = 11) %>%
#  mutate(source_well = "A12") %>%
#  mutate(dest_slot = 11) %>%
#  mutate(source_labware = "denvillewithaxygenbase_96_wellplate_200ul") %>%
#  mutate(dest_labware = "denvillewithaxygenbase_96_wellplate_200ul") %>%
#  select(c("plate", "source_labware", "source_slot", "source_well", "dest_labware", "dest_slot", "dest_well", "transfer_volume", "bp3index"))
```

#### Separate by plates

Create separate primer adding instructions based on plates present on the OT2 deck - will need to do two rounds, one with plates 1, 2, 3 and one with plates 4, 5, 6.

```{r}
# Plates 1, 2, 3
primers_toDilutionPlate_plates123 <- primers_toDilutionPlate %>%
  filter(plate %in% c("1", "2", "3")) #%>%
#  mutate(plate = ifelse(source_well == "A12", "dilution", plate)) %>%
#  dplyr::rename("source_well" = "source_well") %>%
#  mutate(plate = gsub("dilution", "dilution123", plate))

# Plates 4, 5, 6 (primers that go into primer pool 3)
primers_toDilutionPlate_plates456 <- primers_toDilutionPlate %>%
  filter(plate %in% c("4", "5", "6")) #%>%
#  mutate(plate = ifelse(source_well == "A12", "dilution", plate)) %>%
#  dplyr::rename("source_well" = "source_well") %>%
#  mutate(plate = gsub("dilution", "dilution456", plate))
```

#### Add diluted primers to pools

```{r}
vol_primer_toPool <- 4

dilutedPrimers_toPool_plates123 <- primers_toDilutionPlate_plates123 %>%
  mutate(
    plate = "dilutionPlate",
    source_labware = dest_labware,
    source_slot = dest_slot,
    source_well = dest_well,
    dest_labware = "opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap",
    dest_slot = 3,
    dest_well = case_when(
      bp3index %in% primerPool2$bp3Index ~ "B1",
      bp3index %in% primerPool3$bp3Index ~ "C1"
      ),
    transfer_volume = vol_primer_toPool
    ) %>%
  select(c("plate", "source_labware", "source_slot", "source_well", "dest_labware", "dest_slot", "dest_well", "transfer_volume", "bp3index"))

dilutedPrimers_toPool_plates456 <- primers_toDilutionPlate_plates456 %>%
  mutate(
    plate = "dilutionPlate",
    source_labware = dest_labware,
    source_slot = dest_slot,
    source_well = dest_well,
    dest_labware = "opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap",
    dest_slot = 3,
    dest_well = case_when(
      bp3index %in% primerPool2$bp3Index ~ "B1",
      bp3index %in% primerPool3$bp3Index ~ "C1"
      ),
    transfer_volume = vol_primer_toPool
    ) %>%
  select(c("plate", "source_labware", "source_slot", "source_well", "dest_labware", "dest_slot", "dest_well", "transfer_volume", "bp3index"))
```

#### Combine steps: Dilute primers & add to pools

```{r}
dilutedPrimers_plates123_forOT2 <- rbind(primers_toDilutionPlate_plates123, dilutedPrimers_toPool_plates123)

dilutedPrimers_plates456_forOT2 <- rbind(primers_toDilutionPlate_plates456, dilutedPrimers_toPool_plates456)
```

### 4.2.3 Split pools

#### Transfer info

```{r}
# Plates 1, 2, 3
ot2_plates123d <- primers_postOpt2 %>%
  # Add non-diluted primers
  filter(is.na(action)) %>%
  filter(plate %in% c("1", "2", "3")) %>%
  select(c("plate", "Well.Position", "bp3index")) %>%
  dplyr::rename("source_well" = "Well.Position") %>%
  mutate(
    col = substr(source_well, 1, 1),
    row = substr(source_well, 2, nchar(source_well))
    ) %>%
  arrange(plate, as.numeric(row), col) %>%
  mutate(
    source_labware = "vwr_96_wellplate_1000ul",
    source_slot = case_when(
      plate == "1" ~ 2,
      plate == "2" ~ 5,
      plate == "3" ~ 8
      ),
    dest_labware = "opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap",
    dest_slot = 3,
    dest_well = case_when(
      bp3index %in% primerPool2$bp3Index ~ "B1",
      bp3index %in% primerPool3$bp3Index ~ "C1"
      ),
    transfer_volume = vol_primer_toPool
    ) %>%
  select(c("plate", "source_labware", "source_slot", "source_well", "dest_labware", "dest_slot", "dest_well", "transfer_volume", "bp3index")) %>%
  # Dilute & add diluted primers
  rbind(., dilutedPrimers_plates123_forOT2) %>%
  mutate(
    ot2set = "set1_plates123"
  ) %>%
  relocate(ot2set)

# Plates 4, 5, 6
ot2_plates456d <- primers_postOpt2 %>%
  # Add non-diluted primers
  filter(is.na(action)) %>%
  filter(plate %in% c("4", "5", "6")) %>%
  select(c("plate", "Well.Position", "bp3index")) %>%
  dplyr::rename("source_well" = "Well.Position") %>%
  mutate(
    col = substr(source_well, 1, 1),
    row = substr(source_well, 2, nchar(source_well))
    ) %>%
  arrange(plate, as.numeric(row), col) %>%
  mutate(
    source_labware = "vwr_96_wellplate_1000ul",
    source_slot = case_when(
      plate == "4" ~ 2,
      plate == "5" ~ 5,
      plate == "6" ~ 8
      ),
    dest_labware = "opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap",
    dest_slot = 3,
    dest_well = case_when(
      bp3index %in% primerPool2$bp3Index ~ "B1",
      bp3index %in% primerPool3$bp3Index ~ "C1"
      ),
    transfer_volume = vol_primer_toPool
    ) %>%
  select(c("plate", "source_labware", "source_slot", "source_well", "dest_labware", "dest_slot", "dest_well", "transfer_volume", "bp3index")) %>%
  # Dilute & add diluted primers
  rbind(., dilutedPrimers_plates456_forOT2) %>%
  mutate(
    ot2set = "set2_plates456"
  ) %>%
  relocate(ot2set)

# All plates together
splitPools_ot2 <- rbind(ot2_plates123d, ot2_plates456d)
```

#### Pool volumes: split pools initial

```{r}
# Volumes added to split pool tubes
ot2_plates123d_primersOnly <- ot2_plates123d %>%
  filter(transfer_volume == vol_primer_toPool)

ot2_plates456d_primersOnly <- ot2_plates456d %>%
  filter(transfer_volume == vol_primer_toPool)

# Pool 2
pool2_plates123d <- ot2_plates123d_primersOnly %>%
  filter(dest_well == "B1")
pool2_plates456d <- ot2_plates456d_primersOnly %>%
  filter(dest_well == "B1")

vol_pool2_initial <- sum(as.numeric(pool2_plates123d$transfer_volume)) + sum(as.numeric(pool2_plates456d$transfer_volume))

# Pool 3
pool3_plates123d <- ot2_plates123d_primersOnly %>%
  filter(dest_well == "C1")
pool3_plates456d <- ot2_plates456d_primersOnly %>%
  filter(dest_well == "C1")

vol_pool3_initial <- sum(as.numeric(pool3_plates123d$transfer_volume)) + sum(as.numeric(pool3_plates456d$transfer_volume))
```

#### uM per oligo: split pools initial

c1v1=c2v2
c2=c1v1/v2

```{r}
uM_pool2_initial <- (200*vol_primer_toPool)/vol_pool2_initial
uM_pool3_initial <- (200*vol_primer_toPool)/vol_pool3_initial
```

#### Match uM split pools

Primer pool 2 currently has a slightly higher concentration per oligo; adjust to match pool 3.

##### Water to add

c1v1 = c2v2
v2 = c1v1/c2
water = v2 - v1

```{r}
water_forPool2_initial <- ((uM_pool2_initial*vol_pool2_initial)/uM_pool3_initial) - vol_pool2_initial
```

##### Transfer info

```{r}
uM_splitPoolAdjust_ot2 <- data.frame(
  plate = "water_finalPools",
  source_labware = "opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap",
  source_slot = 3,
  source_well = "A6",
  dest_labware = "opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap",
  dest_slot = 3,
  dest_well = "B1",
  transfer_volume = water_forPool2_initial,
  bp3index = NA)
```

##### Pool volumes: post-concentration match

```{r}
vol_pool2_postConcMatch <- vol_pool2_initial + water_forPool2_initial
vol_pool3_postConcMatch <- vol_pool3_initial
```

##### uM per oligo: post-concentration match

```{r}
uM_pool2_postConcMatch <- (200*vol_primer_toPool)/vol_pool2_postConcMatch
uM_pool3_postConcMatch <- uM_pool3_initial
```

### 4.2.4 Primer pool 1

#### Transfer info

Transfer 350 ul from each split primer pool.

```{r}
vol_pool2_forPool1 <- 350
vol_pool3_forPool1 <- 350

primerPool1_ot2 <- data.frame(
  plate = rep("water_finalPools", 2),
  source_labware = rep("opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap", 2),
  source_slot = rep(3, 2),
  source_well = c("B1", "C1"),
  dest_labware = rep("opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap", 2),
  dest_slot = rep(3, 2),
  dest_well = rep("A1", 2),
  transfer_volume = c(vol_pool2_forPool1, vol_pool3_forPool1),
  bp3index = rep(NA, 2))
```

##### Pool volumes: post-pool1

```{r}
vol_pool1_postPool1 <- sum(as.numeric(primerPool1_ot2$transfer_volume))
vol_pool2_postPool1 <- vol_pool2_postConcMatch - vol_pool2_forPool1
vol_pool3_postPool1 <- vol_pool3_postConcMatch - vol_pool3_forPool1
```

##### uM per oligo: pool 1

Since each split pool is now at the same concentration per oligo, combining them results in a pool with the same concentration per oligo. HOWEVER, since the same oligos aren't present in both pools, the concentration per split pool 2 oligos and split pool 3 oligos will actually decrease since the total volume is increasing. 

Keeping this in mind, the concentration per oligo in primer pool 1 can be calculated as follows, using either of the split pools for the starting concentration/volume (since they're both the same):

c1v1 = c2v2
c2 = c1v1/v2

```{r}
uM_pool1_initial <- (uM_pool2_postConcMatch*vol_pool2_forPool1)/vol_pool1_postPool1
```

### 4.2.5 Create SDZ & LA lab aliquots

#### Transfer info

```{r}
sdzLA_subsets_ot2 <- data.frame(
  plate = rep("water_finalPools", 3),
  source_labware = rep("opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap", 3),
  source_slot = rep(3, 3),
  source_well = c("A1", "B1", "C1"),
  dest_labware = rep("opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap", 3),
  dest_slot = rep(3, 3),
  dest_well = c("A2", "B2", "C2"),
  transfer_volume = c(vol_pool1_postPool1/2, vol_pool2_postPool1/2, vol_pool3_postPool1/2),
  bp3index = rep(NA, 3))
```

#### Pool volumes: post-aliquots

```{r}
vol_pool1_sdzLA <- vol_pool1_postPool1/2
vol_pool2_sdzLA <- vol_pool2_postPool1/2
vol_pool3_sdzLA <- vol_pool3_postPool1/2
```

### 4.2.6 Adjust to 0.25 uM per oligo

#### Water to add

v2 = c1v1/c2
water = v2 - v1 = c1v1/c2 - v1

```{r}
# water to add to each aliquot of pool
water_forPool1 <- ((uM_pool1_initial*vol_pool1_sdzLA)/0.25) - vol_pool1_sdzLA
water_forPool2 <- ((uM_pool2_postConcMatch*vol_pool2_sdzLA)/0.25) - vol_pool2_sdzLA
water_forPool3 <- ((uM_pool3_postConcMatch*vol_pool3_sdzLA)/0.25) - vol_pool3_sdzLA
```

#### Transfer info

```{r}
uM_finalAdjust_ot2 <- data.frame(
  plate = rep("water_finalPools", 6),
  source_labware = rep("opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap", 6),
  source_slot = rep(3, 6),
  source_well = c("A6", "A6", "B5", "B6", "C5", "C6"),
  dest_labware = rep("opentrons_24_tuberack_eppendorf_1.5ml_safelock_snapcap", 6),
  dest_slot = rep(3, 6),
  dest_well = c("A1", "A2", "B1", "B2", "C1", "C2"),
  transfer_volume = c(water_forPool1, water_forPool1, water_forPool2, water_forPool2, water_forPool3, water_forPool3),
  bp3index = rep(NA, 6)) %>%
  mutate(transfer_volume = round(transfer_volume, 1))
```

### 4.2.6 Full OT2 input (OLD)

Combine dilutions, split primer pools, primer pool 1 creation, SDZ/laLab subsets, and uM adjustments:

```{r, include=FALSE}
ot2_final_plusPlates <- rbind(splitPools_ot2, uM_splitPoolAdjust_ot2, primerPool1_ot2, sdzLA_subsets_ot2, uM_finalAdjust_ot2) %>%
  mutate(transfer_volume = round(as.numeric(transfer_volume), digits = 1)) %>%
  select(-bp3index) %>%
  mutate(plate = case_when(plate == 1 ~ "primerPlate1",
                           plate == 2 ~ "primerPlate2",
                           plate == 3 ~ "primerPlate3",
                           plate == 4 ~ "primerPlate4",
                           plate == 5 ~ "primerPlate5",
                           plate == 6 ~ "primerPlate6",
                           plate == "dilution123" ~ "dilution123",
                           plate == "dilution456" ~ "dilution456",
                           plate == "water_finalPools" ~ "water_finalPools")) %>%
  mutate(asp_height_mm = 1) %>%
  relocate("asp_height_mm", .after = "source_well") %>%
  mutate(ot2set = case_when(plate %in% c("primerPlate1",
                                         "primerPlate2",
                                         "primerPlate3",
                                         "dilution123")
                            ~ "plates123", 
                            plate %in% c("primerPlate4",
                                         "primerPlate5",
                                         "primerPlate6",
                                         "dilution456",
                                         "water_finalPools")
                            ~ "plates456")) %>%
  relocate(ot2set)
  

ot2_final_noSet_noPlates <- ot2_final_plusPlates %>%
  select(-ot2set, -plate)
```

Export

```{r, include=FALSE}
# comma-separated string with end-of-line delimiter
ot2_string <- format_delim(ot2_final_plusPlates,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_primerDilutionsPooling_postOpt2_string.txt")

ot2_string

sink()

# csv file
write.csv(ot2_final_plusPlates, "./robotProtocols/inputFiles/tamGenetics_primerDilutionsPooling_postOpt2_forOT2.csv", row.names = F)
```

### 4.2.7 Full OT2 input (NO P300)

```{r}
ot2_final_splitPoolsOnly <- splitPools_ot2 %>%
  mutate(transfer_volume = round(as.numeric(transfer_volume), digits = 1)) %>%
  select(-bp3index) %>%
  mutate(
    asp_height = 1
    ) %>%
  relocate("asp_height", .after = "source_well")
```

Export

```{r}
# comma-separated string with end-of-line delimiter
ot2_string <- format_delim(ot2_final_splitPoolsOnly,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_primerPoolingOnly_postOpt2_string.txt")

ot2_string

sink()

# csv file
write.csv(ot2_final_splitPoolsOnly, "./robotProtocols/inputFiles/tamGenetics_primerPoolingOnly_postOpt2_forOT2.csv", row.names = F)
```

## 4.3 Indexing primer plates

```{r}
indexPrimers <- read_excel("./primers/01_primerOrders/indexingAdapters_illumina.xlsx") %>%
  as.data.frame() %>%
  rename("well" = "Well Position",
         "name" = "Name",
         "sequence" = "Sequence")

indexPrimers_i5List <- indexPrimers %>%
  filter(str_detect(name, "S"))
indexPrimers_i7List <- indexPrimers %>%
  filter(str_detect(name, "N"))

indexPrimers_setA <- data.frame(
  transferID = 1:96,
  i5 = rep(c("S502",
             "S503",
             "S505",
             "S506",
             "S507",
             "S508",
             "S510",
             "S511"), 12),
  i7 = c(rep("N701", 8),
         rep("N702", 8),
         rep("N703", 8),
         rep("N704", 8),
         rep("N705", 8),
         rep("N706", 8),
         rep("N707", 8),
         rep("N710", 8),
         rep("N711", 8),
         rep("N712", 8),
         rep("N714", 8),
         rep("N715", 8))
  ) %>%
  mutate(
    indexCombo = str_c(i5, "_", i7),
    dest_well = wellValues_plate
  )

indexPrimers_setB <- data.frame(
  transferID = 1:96,
  i5 = rep(c("S502",
             "S503",
             "S505",
             "S506",
             "S507",
             "S508",
             "S510",
             "S511"), 12),
  i7 = c(rep("N716", 8),
         rep("N718", 8),
         rep("N719", 8),
         rep("N720", 8),
         rep("N721", 8),
         rep("N722", 8),
         rep("N723", 8),
         rep("N724", 8),
         rep("N726", 8),
         rep("N727", 8),
         rep("N728", 8),
         rep("N729", 8))
  ) %>%
  mutate(
    indexCombo = str_c(i5, "_", i7),
    dest_well = wellValues_plate
  )

indexPrimers_setC <- data.frame(
  transferID = 1:96,
  i5 = rep(c("S513",
             "S515",
             "S516",
             "S517",
             "S518",
             "S520",
             "S521",
             "S522"), 12),
  i7 = c(rep("N701", 8),
         rep("N702", 8),
         rep("N703", 8),
         rep("N704", 8),
         rep("N705", 8),
         rep("N706", 8),
         rep("N707", 8),
         rep("N710", 8),
         rep("N711", 8),
         rep("N712", 8),
         rep("N714", 8),
         rep("N715", 8))
  ) %>%
  mutate(
    indexCombo = str_c(i5, "_", i7),
    dest_well = wellValues_plate
  )

indexPrimers_setD <- data.frame(
  transferID = 1:96,
  i5 = rep(c("S513",
             "S515",
             "S516",
             "S517",
             "S518",
             "S520",
             "S521",
             "S522"), 12),
  i7 = c(rep("N716", 8),
         rep("N718", 8),
         rep("N719", 8),
         rep("N720", 8),
         rep("N721", 8),
         rep("N722", 8),
         rep("N723", 8),
         rep("N724", 8),
         rep("N726", 8),
         rep("N727", 8),
         rep("N728", 8),
         rep("N729", 8))
  ) %>%
  mutate(
    indexCombo = str_c(i5, "_", i7),
    dest_well = wellValues_plate
  )
```

### Check combos

```{r}
indexPrimers_combosAll <- apply(expand.grid(indexPrimers_i5List[, "name"], indexPrimers_i7List[, "name"]), 1, paste, collapse = "_") %>%
  as.data.frame() %>%
  rename("indexCombo" = ".") %>%
  mutate(
    i5 = str_sub(indexCombo, 1, 4),
    i7 = str_sub(indexCombo, 6, -1)
  )
length(unique(indexPrimers_combosAll$indexCombo)) # 468 unique combos

indexPrimers_combosSetABCD <- rbind(indexPrimers_setA,
                                indexPrimers_setB,
                                indexPrimers_setC,
                                indexPrimers_setD)
length(unique(indexPrimers_combosSetABCD$indexCombo)) # 384 unique set combos

indexPrimers_combosCustom <- indexPrimers_combosAll %>%
  filter(!indexCombo %in% indexPrimers_combosSetABCD$indexCombo)
length(unique(indexPrimers_combosCustom$indexCombo)) # 84 unique custom combos
```

### Create index plates

#### Individual plates

```{r}
# set source wells
indexPlates_sourceWells <- data.frame(
  name = c(indexPrimers_combosAll[, c("i5")], indexPrimers_combosAll[, c("i7")])
) %>%
  merge(., indexPrimers[, c("name", "well")], by = "name") %>%
  rename("source_well" = "well") %>%
  distinct()

# set A
indexPlate_setA_i5 <- indexPrimers_setA %>%
  select(c("i5", "dest_well")) %>%
  rename("name" = "i5")
indexPlate_setA_i7 <- indexPrimers_setA %>%
  select(c("i7", "dest_well")) %>%
  rename("name" = "i7")

indexPlate_setA <- rbind(indexPlate_setA_i5,
                         indexPlate_setA_i7) %>%
  merge(., indexPlates_sourceWells, by = "name", all.x = T) %>%
  mutate(
    ot2set = "indexSetA",
    dest_slot = 2
  ) %>%
  arrange(name, str_sub(dest_well, 1, 1), as.numeric(str_sub(dest_well, 2, -1)))

# set B
indexPlate_setB_i5 <- indexPrimers_setB %>%
  select(c("i5", "dest_well")) %>%
  rename("name" = "i5")
indexPlate_setB_i7 <- indexPrimers_setB %>%
  select(c("i7", "dest_well")) %>%
  rename("name" = "i7")

indexPlate_setB <- rbind(indexPlate_setB_i5,
                         indexPlate_setB_i7) %>%
  merge(., indexPlates_sourceWells, by = "name", all.x = T) %>%
  mutate(
    ot2set = "indexSetB",
    dest_slot = 3
  ) %>%
  arrange(name, str_sub(dest_well, 1, 1), as.numeric(str_sub(dest_well, 2, -1)))

# set C
indexPlate_setC_i5 <- indexPrimers_setC %>%
  select(c("i5", "dest_well")) %>%
  rename("name" = "i5")
indexPlate_setC_i7 <- indexPrimers_setC %>%
  select(c("i7", "dest_well")) %>%
  rename("name" = "i7")

indexPlate_setC <- rbind(indexPlate_setC_i5,
                         indexPlate_setC_i7) %>%
  merge(., indexPlates_sourceWells, by = "name", all.x = T) %>%
  mutate(
    ot2set = "indexSetC",
    dest_slot = 5
  ) %>%
  arrange(name, str_sub(dest_well, 1, 1), as.numeric(str_sub(dest_well, 2, -1)))

# set D
indexPlate_setD_i5 <- indexPrimers_setD %>%
  select(c("i5", "dest_well")) %>%
  rename("name" = "i5")
indexPlate_setD_i7 <- indexPrimers_setD %>%
  select(c("i7", "dest_well")) %>%
  rename("name" = "i7")

indexPlate_setD <- rbind(indexPlate_setD_i5,
                         indexPlate_setD_i7) %>%
  merge(., indexPlates_sourceWells, by = "name", all.x = T) %>%
  mutate(
    ot2set = "indexSetD",
    dest_slot = 6
  ) %>%
  arrange(name, str_sub(dest_well, 1, 1), as.numeric(str_sub(dest_well, 2, -1)))

# set E (custom)
indexPrimers_setE <- indexPrimers_combosCustom %>%
  mutate(
    transferID = row_number(),
    i5 = str_sub(indexCombo, 1, 4),
    i7= str_sub(indexCombo, 6, -1),
    dest_well = wellValues_plate[1:length(transferID)]
  ) %>%
  relocate(indexCombo, .after = i7)

indexPlate_setE_i5 <- indexPrimers_setE %>%
  select(c("i5", "dest_well")) %>%
  rename("name" = "i5")
indexPlate_setE_i7 <- indexPrimers_setE %>%
  select(c("i7", "dest_well")) %>%
  rename("name" = "i7")

indexPlate_setE <- rbind(indexPlate_setE_i5,
                         indexPlate_setE_i7) %>%
  merge(., indexPlates_sourceWells, by = "name", all.x = T) %>%
  mutate(
    ot2set = "indexSetE",
    dest_slot = 9
  ) %>%
  arrange(name, str_sub(dest_well, 1, 1), as.numeric(str_sub(dest_well, 2, -1)))
```

#### Full transfer info

```{r}
indexPlates_transferInfo <- rbind(
  indexPlate_setA,
  indexPlate_setB,
  indexPlate_setC,
  indexPlate_setD,
  indexPlate_setE
) %>%
  mutate(
    ot2set = ot2set,
    reagent = name,
    source_labware = deepwellPlate,
    source_slot = 1,
    source_well = source_well,
    asp_height = 1,
    dest_labware = nestPlate,
    dest_slot = dest_slot,
    dest_well = dest_well,
    transfer_volume = 5
  ) %>%
  select(c("ot2set", "reagent", "source_labware", "source_slot", "source_well", "asp_height", "dest_labware", "dest_slot", "dest_well", "transfer_volume"))
```

Export

```{r}
# comma-separated string with end-of-line delimiter
indexPlates_transferInfo_string <- format_delim(indexPlates_transferInfo,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/illuminaIndexPlates_setsABCDE_string.txt")

indexPlates_transferInfo_string

sink()

# csv file
write.csv(indexPlates_transferInfo, "./robotProtocols/inputFiles/illuminaIndexPlates_setsABCDE.csv", row.names = F)
```

Export minus set A

```{r}
indexPlates_transferInfo_setsBCDE <- indexPlates_transferInfo %>%
  filter(ot2set != "indexSetA")

# comma-separated string with end-of-line delimiter
indexPlates_transferInfo_setsBCDE_string <- format_delim(indexPlates_transferInfo_setsBCDE,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/illuminaIndexPlates_setsBCDE_string.txt")

indexPlates_transferInfo_setsBCDE_string

sink()

# csv file
write.csv(indexPlates_transferInfo, "./robotProtocols/inputFiles/illuminaIndexPlates_setsBCDE.csv", row.names = F)
```

Export set E only

```{r}
indexPlates_transferInfo_setE <- indexPlates_transferInfo %>%
  filter(ot2set == "indexSetE") %>%
  mutate(dest_slot = 2) %>%
  arrange(str_sub(reagent, 1, 1),
          as.numeric(str_sub(dest_well, 2, -1)),
          str_sub(dest_well, 1, 1))

# comma-separated string with end-of-line delimiter
indexPlates_transferInfo_setE_string <- format_delim(indexPlates_transferInfo_setE,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/indexPlates_transferInfo_setE_string.txt")

indexPlates_transferInfo_setE_string

sink()

# csv file
write.csv(indexPlates_transferInfo, "./robotProtocols/inputFiles/indexPlates_transferInfo_setE.csv", row.names = F)
```


# 5 OT2 input for SAMPLES 

## 5.1 Extraction data

### Xtn master lists (27 July 2023)

```{r}
xtnsBlood_27July2023 <- read.csv("./extractions/tamGenetics_xtnsBlood_master_updated27July2023.csv")
xtnsFecal_27July2023 <- read.csv("./extractions/tamGenetics_xtnsFecal_master_updated27July2023.csv")
xtnsHair_27July2023 <- read.csv("./extractions/tamGenetics_xtnsHair_master_updated27July2023.csv")

xtnsAll_27July2023 <- rbind(xtnsBlood_27July2023,
                            xtnsFecal_27July2023,
                            xtnsHair_27July2023)
```

### Xtns to SKIP

#### Xtn records
```{r}
xtns_toSkip_xtnRecords27July2023 <- xtnsAll_27July2023 %>%
  filter(xtnRemaining != "yes") %>%
  select(c("animalID", "xtnID", "xtnRemaining"))
```

#### tamRun3 records

```{r}
xtns_toSkip_tamRun3Records <- md_tamRun3 %>%
  filter(str_detect(pcr1Notes_p12, "OUT")) %>%
  mutate(
    xtnID = case_when(
      str_detect(xtnUsed_p12, "-") ~ str_c(sampleType, "_p", str_sub(xtnUsed_p12, 1, 1), ".", str_sub(xtnUsed_p12, 3, length(xtnUsed_p12)), "_", tolower(str_sub(pcr1Notes_p12, 1, 2))),
      .default = str_c(sampleType, "_t", xtnUsed_p12, "_", tolower(str_sub(pcr1Notes_p12, 1, 2)))
      ),
    xtnRemaining = "no"
    ) %>%
  select(c("animalID", "xtnID", "xtnRemaining"))
```

#### On-site xtn & bead checks

```{r}
# xtn checks
xtns_toSkip_onsiteChecks <- data.frame(
  xtnID = c(
            # p1e1
            "blood_p1.A5_e1",
            "blood_p1.C6_e1",
            "blood_p1.E6_e1",
            "blood_p1.A7_e1",
            "blood_p1.F8_e1",
            "blood_p1.A11_e1",
            "blood_p1.A12_e1",
            # p1e2
            "blood_p1.F11_e2",
            # p2e1
            "blood_p2.A1_e1",
            "blood_p2.H1_e1",
            "blood_p2.A5_e1",
            "blood_p2.G7_e1",
            "blood_p2.H7_e1",
            "blood_p2.A8_e1",
            "blood_p2.A9_e1",
            "blood_p2.D11_e1",
            "blood_p2.C12_e1",
            # p2e2 (none)
            # blood xtn tubes
            "blood_t505_e2",
            # fecal xtn tubes
            "fecal_t9_e1",
            # p3e1
            "hair_p3.B1_e1",
            "hair_p3.D1_e1",
            "hair_p3.A2_e1",
            "hair_p3.B2_e1",
            "hair_p3.D2_e1",
            "hair_p3.G2_e1",
            "hair_p3.H2_e1",
            "hair_p3.A5_e1",
            "hair_p3.F6_e1",
            "hair_p3.E7_e1",
            "hair_p3.F7_e1",
            "hair_p3.G7_e1",
            "hair_p3.H7_e1",
            "hair_p3.A9_e1",
            "hair_p3.B9_e1",
            "hair_p3.C9_e1",
            "hair_p3.D9_e1",
            "hair_p3.E9_e1",
            "hair_p3.F9_e1",
            "hair_p3.H9_e1",
            "hair_p3.A11_e1",
            "hair_p3.A12_e1",
            "hair_p3.B12_e1",
            "hair_p3.C12_e1",
            "hair_p3.G12_e1",
            # p3e2
            "hair_p3.C9_e2",
            "hair_p3.A11_e2",
            "hair_p3.B12_e2",
            # p4e1
            "hair_p4.C1_e1",
            "hair_p4.H2_e1",
            "hair_p4.F3_e1",
            "hair_p4.A5_e1",
            "hair_p4.B5_e1",
            "hair_p4.H5_e1",
            "hair_p4.G8_e1",
            # p4e2
            "hair_p4.A1_e2",
            "hair_p4.H1_e2",
            # hair xtn tubes
            "hair_t6_e1",
            "hair_t6_e2",
            "hair_tx15A_e1",
            "hair_tx25A_e1",
            "hair_tx20A_e1",
            "hair_tx48A_e1",
            "hair_tx73A_e1",
            "hair_tx105A_e1"
            )) %>%
  merge(., xtnsAll_27July2023[, c("animalID", "xtnID")], by = "xtnID", all.x = T) %>%
  mutate(xtnRemaining = "no") %>%
  select(c("animalID", "xtnID", "xtnRemaining"))

# bead checks
xtnPlate_beadChecks <- data.frame(
  xtnLoc = rep(c("p1", "p2", "p3", "p4"), 2),
  eltn = c(rep("e1", 4), rep("e2", 4))
  ) %>%
  mutate(
    xtnPlate_beadsPresent = case_when(
      xtnLoc == "p1" & eltn == "e1" ~ "yes",
      xtnLoc == "p1" & eltn == "e2" ~ "yes",
      xtnLoc == "p2" & eltn == "e1" ~ "yes",
      xtnLoc == "p2" & eltn == "e2" ~ "yes",
      xtnLoc == "p3" & eltn == "e1" ~ "yes",
      xtnLoc == "p3" & eltn == "e2" ~ "yes",
      xtnLoc == "p4" & eltn == "e1" ~ "no",
      xtnLoc == "p4" & eltn == "e2" ~ "no")
) %>%
  arrange(xtnLoc)
```

#### Out after 30x3

```{r}
xtns_toSkip_post30x3 <- data.frame(
  xtnID = c(
            "fecal_t6_e1",
            "hair_p4.H8_e1",
            "hair_tx105A_e1",
            "hair_t23_e1"
            )) %>%
  merge(., xtnsAll_27July2023[, c("animalID", "xtnID")], by = "xtnID", all.x = T) %>%
  mutate(xtnRemaining = "no") %>%
  select(c("animalID", "xtnID", "xtnRemaining"))
```

#### All xtns to skip

```{r}
xtns_toSkip <- rbind(xtns_toSkip_xtnRecords27July2023,
                     xtns_toSkip_tamRun3Records,
                     xtns_toSkip_onsiteChecks,
                     xtns_toSkip_post30x3) %>%
  arrange(xtnID) %>%
  unique()
```

#### Update xtn records

Update 'xtnRemaining' and add 'xtnPlate_beadsPresent'. 

There were two tamTiger xtn plates, but the original xtn records don't specify which sample is on which plate - I was able to find this info in past lab notebooks; update this info here as well.

I'm also updating the entry for hair_tx47A/55A - both these extractions were an option for this animalID's hair sample, but I chose 47A for the spot in previous runs. 

Found hair_t6_e1 w/volume remaining - also updating here

```{r}
xtnsBlood_updated <- xtnsBlood_27July2023 %>%
  mutate(
    xtnRemaining = case_when(
      xtnID %in% xtns_toSkip$xtnID ~ "no",
      .default = xtnRemaining
      )) %>%
  merge(., xtnPlate_beadChecks[, c("xtnLoc", "eltn", "xtnPlate_beadsPresent")], by = c("xtnLoc", "eltn"), all.x = T) %>%
  relocate(xtnPlate_beadsPresent, .before = xtnNotes) %>%
  relocate(c("xtnLoc", "eltn"), .after = xtnID)

xtnsFecal_updated <- xtnsFecal_27July2023 %>%
  mutate(xtnRemaining = case_when(
    xtnID %in% xtns_toSkip$xtnID ~ "no",
    .default = xtnRemaining
  )) %>%
  merge(., xtnPlate_beadChecks[, c("xtnLoc", "eltn", "xtnPlate_beadsPresent")], by = c("xtnLoc", "eltn"), all.x = T) %>%
  relocate(xtnPlate_beadsPresent, .before = xtnNotes) %>%
  relocate(c("xtnLoc", "eltn"), .after = xtnID)

xtnsHair_updated <- xtnsHair_27July2023 %>%
  mutate(xtnRemaining = case_when(
    xtnID %in% xtns_toSkip$xtnID ~ "no",
    .default = xtnRemaining
  )) %>%
  merge(., xtnPlate_beadChecks[, c("xtnLoc", "eltn", "xtnPlate_beadsPresent")], by = c("xtnLoc", "eltn"), all.x = T) %>%
  relocate(xtnPlate_beadsPresent, .before = xtnNotes) %>%
  relocate(c("xtnLoc", "eltn"), .after = xtnID) %>%
  mutate(
    xtnRemaining = case_when(
      xtnID == "hair_t6_e1" ~ "yes",
      .default = xtnRemaining
    ),
    xtnLoc = case_when(
      (xtnLoc == "ptamTiger" & lysisLoc %in% c("t53", "t54")) ~ "ptamTiger1",
      (xtnLoc == "ptamTiger" & lysisLoc %in% c("t55", "t56")) ~ "ptamTiger2",
      xtnLoc == "tx47A;55A" ~ "tx47A",
      xtnLoc == "tx47B;55B" ~ "tx47B",
      .default = xtnLoc
    ),
    xtnID = case_when(
      xtnLoc == "ptamTiger1" ~ gsub("ptamTiger", "ptamTiger1", xtnID),
      xtnLoc == "ptamTiger2" ~ gsub("ptamTiger", "ptamTiger2", xtnID),
      xtnLoc == "tx47A" ~ "hair_tx47A_e1",
      xtnLoc == "tx47B" ~ "hair_tx47B_e2",
      .default = xtnID
    ),
    xtnNotes = case_when(
      str_detect(xtnLoc, "tx47") ~ "originally had both tx47 and tx55 in this spot; may need to check that capture date is correct (all other metadata should be fine)",
      .default = xtnNotes
    )
  )

xtnsAll_updated <- rbind(xtnsBlood_updated, xtnsFecal_updated, xtnsHair_updated)

# Export
write.csv(xtnsAll_updated, "./extractions/tamGenetics_xtnsAll_updated_postOnsiteChecks_post30x3.csv", row.names = F)
```

### Xtns REMAINING by animalID

```{r}
xtnsRemaining_byAnimalID <- xtnsAll_updated %>%
  filter(xtnRemaining == "yes") %>%
  mutate(sampleType_animalID = str_c(sampleType, "_", animalID)) %>%
  group_by(sampleType_animalID) %>%
  summarise_all(~ toString(unique(.))) %>%
  select(c("sampleType_animalID", "xtnID")) %>%
  separate(xtnID, c("xtnID.1", "xtnID.2", "xtnID.3", "xtnID.4"), ",")
```

### Xtns to ADJUST

```{r}
xtns_toAdjust <- xtnsAll_updated %>%
  filter(str_detect(xtnNotes, "dilute")) %>%
  select(c("animalID", "xtnID", "xtnNotes"))
```

## 5.2 PCR1

### 5.2.1 30x3

#### Xtns

Add negatives & reformat xtn list

```{r}
# Original 30x3 sample list
bfh_samples <- read.csv("./01_run2_fecalHairBlood/03_run2GTscore/metadata_tamRun2.csv") %>%
  filter(str_detect(pcr1Description, "again|blood")) %>%
  filter(!is.na(sampleType)) %>%
  mutate(xtnTube = gsub("\\s+", "", xtnTube))

# Select negatives from original xtn lists (will replace if depleted later)
bfh_negsBlood <- xtnsAll_27July2023 %>%
  filter(animalID %in% c("xtnNeg_p1.C4","xtnNeg_p2.C4")) %>%
  filter(eltn == "e1") %>%
  mutate(sampleType = str_c("blood_", sampleType)) %>%
  select(c("sampleType", "animalID", "xtnID"))
bfh_negsFecal <- data.frame(
  sampleType = c("fecal_pcr1Neg1", "fecal_pcr1Neg2"),
  animalID = c("pcr1Neg1", "pcr1Neg2"),
  xtnID = c("tH2O.1", "tH2O.2"))
bfh_negsHair <- xtnsAll_27July2023 %>%
  filter(animalID %in% c("xtnNeg_p3.C4","xtnNeg_p4.C4")) %>%
  filter(eltn == "e1") %>%
  mutate(sampleType = str_c("hair_", sampleType)) %>%
  select(c("sampleType", "animalID", "xtnID"))

bfh_negsAll <- rbind(bfh_negsBlood, bfh_negsFecal, bfh_negsHair) %>%
  rename("xtnTube" = "xtnID") %>%
  mutate(
    sampleType_animalID = case_when(
      str_detect(sampleType, "pcr1Neg") ~ sampleType,
      .default = str_c(sampleType, "_", str_sub(animalID, start = 8, end = -1))
      )
    ) %>%
  select(c("sampleType", "animalID", "xtnTube", "sampleType_animalID"))

# Add negs to 30x3 xtn list & reformat
bfh_xtns <- bfh_samples %>%
  select(c("sampleType", "animalID", "xtnTube")) %>%
  mutate(
    sampleType_animalID = str_c(sampleType, "_", animalID),
    xtnTube = case_when(
      sampleType == "fecal" ~ gsub("F", "", xtnTube),
      .default = xtnTube
      )
  ) %>%
  filter(duplicated(sampleType_animalID) == F) %>%
  rbind(., bfh_negsAll) %>%
  mutate(
    xtnID = case_when(
      str_detect(sampleType, "fecal_pcr1Neg") ~ xtnTube,
      sampleType == "fecal_pcr1Neg2" ~ "tH2O.2",
      str_detect(xtnTube, "Neg") ~ str_c(gsub("_.*", "", sampleType), "_", xtnTube),
      str_detect(xtnTube, "-") ~ str_c(sampleType, "_p", str_sub(xtnTube, 1, 1), ".", str_sub(xtnTube, 3, length(xtnTube)), "_e1"),
      str_detect(xtnTube, "A") ~ str_c(sampleType, "_tx", xtnTube, "_e1"),
      .default = str_c(sampleType, "_t", xtnTube, "_e1")
      ),
    xtnRemaining = case_when(
      xtnID %in% xtns_toSkip$xtnID ~ "no",
      .default = "yes"
      )
    ) %>%
  select(c("sampleType_animalID", "sampleType", "xtnID", "xtnRemaining")) %>%
  # replace "SKIP" xtns
  merge(., xtnsRemaining_byAnimalID, by = "sampleType_animalID", all.x = T) %>%
  # remove columns with all NA
  select(where(function(x) !all(is.na(x)))) %>%
  mutate(
    xtnID = case_when(
      xtnRemaining == "no" ~ xtnID.1,
      .default = xtnID
    )
  ) %>%
  select(c("sampleType_animalID", "sampleType", "xtnID")) %>%
  mutate(
    xtnLoc = case_when(
      str_detect(xtnID, "p") ~ gsub(".*[_]([^.]+)[.].*", "\\1", xtnID),
      str_detect(xtnID, "t") ~ gsub(".*[_]([^_]+)[_].*", "\\1", xtnID)
    ),
    xtnRow = case_when(
      str_detect(xtnID, "p") ~ str_sub(gsub(".*[.]([^_]+)[_].*", "\\1", xtnID), 1, 1),
      str_detect(xtnID, "t") ~ NA
    ),
    xtnCol = case_when(
      str_detect(xtnID, "p") ~ str_sub(gsub(".*[.]([^_]+)[_].*", "\\1", xtnID), 2, length(gsub(".*[.]([^_]+)[_].*", "\\1", xtnID))),
      str_detect(xtnID, "t") ~ NA
    ),
    eltn = case_when(
      str_detect(xtnID, "H2O") ~ NA,
      .default = str_sub(xtnID, -2, length(xtnID))
      )
    ) %>%
  # add whether plates have beads
  merge(., xtnPlate_beadChecks[, c("xtnLoc", "eltn", "xtnPlate_beadsPresent")], by = c("xtnLoc", "eltn"), all.x = T) %>%
  relocate(c("xtnLoc", "eltn"), .after = "xtnID") %>%
  arrange(gsub("_.*", "", sampleType_animalID), str_sub(xtnLoc, 1, 1), as.numeric(str_sub(xtnLoc, 2, length(xtnLoc))), as.numeric(xtnCol), xtnRow) %>%
  # place negatives evenly across plate
  mutate(ID = as.character(row_number())) %>%
  mutate(ID = case_when(
    ID == "5" ~ "11.1",
    ID == "21" ~ "30.1",
    ID == "63" ~ "42.1",
    ID == "64" ~ "52.1",
    ID == "66" ~ "67.1",
    ID == "78" ~ "86.1",
    .default = ID
  )) %>%
  arrange(as.numeric(ID))
```

Export xtn info

```{r}
md_bfh <- bfh_xtns %>%
  mutate(wellID = row_number()) %>%
  relocate(wellID) %>%
  select(-ID)

write.csv(md_bfh, "./04_tamRun4/tamRun4_metadata.csv", row.names = F)
```


#### Transfer info

##### Xtn tube source wells

Assign source wells to tube xtns

```{r}
bfh_sourceWells_bloodTubes <- bfh_xtns %>%
  filter(!str_detect(xtnID, "tamTiger")) %>%
  filter(str_detect(xtnID, "blood_t")) %>%
  mutate(
    source_well.t = wellValues_tuberack[1:length(xtnID)]
  ) %>%
  select(c("xtnID", "source_well.t"))

bfh_sourceWells_fecalTubes1to24 <- bfh_xtns %>%
  filter(str_detect(sampleType, "fecal")) %>%
  .[1:24,] %>%
  mutate(
    source_well.t = wellValues_tuberack[1:length(xtnID)]
    ) %>%
  select(c("xtnID", "source_well.t"))
bfh_sourceWells_fecalTubes25to32 <- bfh_xtns %>%
  filter(str_detect(sampleType, "fecal")) %>%
  .[25:32,] %>%
  mutate(
    source_well.t = wellValues_tuberack[1:length(xtnID)]
    ) %>%
  select(c("xtnID", "source_well.t"))

bfh_sourceWells_hairTubes <- bfh_xtns %>%
  filter(str_detect(xtnID, "hair_t")) %>%
  mutate(
    source_well.t = wellValues_tuberack[1:length(xtnID)]
  ) %>%
  select(c("xtnID", "source_well.t"))

bfh_sourceWells_allTubes <- rbind(bfh_sourceWells_bloodTubes,
                                  bfh_sourceWells_fecalTubes1to24,
                                  bfh_sourceWells_fecalTubes25to32,
                                  bfh_sourceWells_hairTubes)
```

##### Xtn transfer info

```{r}
bfh_transferInfo_pp2 <- bfh_xtns %>%
  merge(., bfh_sourceWells_allTubes, all.x = T) %>%
  arrange(as.numeric(ID)) %>%
  mutate(
    ot2set = case_when(
      str_detect(xtnID, "p1") & eltn == "e1" ~ "set1_xtnPlate1_e1",
      str_detect(xtnID, "p1") & eltn == "e2" ~ "set2_xtnPlate1_e2",
      str_detect(xtnID, "p2") & eltn == "e1" ~ "set3_xtnPlate2_e1",
      str_detect(xtnID, "p2") & eltn == "e2" ~ "set4.1_xtnPlate2_e2",
      str_detect(xtnID, "blood_t") ~ "set4.2_bloodTubes",
      xtnID %in% bfh_sourceWells_fecalTubes1to24$xtnID ~ "set5_fecalTubes1to24",
      xtnID %in% bfh_sourceWells_fecalTubes25to32$xtnID ~ "set6.1_fecalTubes25to32",
      str_detect(xtnID, "p3") & eltn == "e1" ~ "set6.2_xtnPlate3_e1",
      str_detect(xtnID, "p3") & eltn == "e2" ~ "set7.1_xtnPlate3_e2",
      str_detect(xtnID, "p4") & eltn == "e1" ~ "set7.2_xtnPlate4_e1",
      str_detect(xtnID, "p4") & eltn == "e2" ~ "set7.3_xtnPlate4_e2",
      str_detect(xtnID, "hair_t") ~ "set7.4_hairTubes",
    ),
    reagent = xtnID,
    source_labware = case_when(
      str_detect(xtnID, "p1") ~ nestPlate,
      str_detect(xtnID, "p2") ~ nestPlate,
      str_detect(xtnID, "p3") ~ nestPlate,
      str_detect(xtnID, "p4") ~ basePlate,
      str_detect(xtnID, "t") ~ tuberack
    ),
    source_slot = case_when(
      xtnPlate_beadsPresent == "yes" ~ 7,
      (str_detect(xtnID, "p") & str_detect(xtnID, "e1")) ~ 1,
      (str_detect(xtnID, "p") & str_detect(xtnID, "e2")) ~ 4,
      str_detect(xtnID, "t") ~ 3
    ),
    source_well = case_when(
      str_detect(xtnID, "p") ~ str_c(xtnRow, xtnCol),
      .default = source_well.t),
    asp_height = 1,
    dest_labware = basePlate,
    dest_slot = 2,
    dest_well = wellValues_plate,
    transfer_volume = case_when(
      str_detect(sampleType, "blood") ~ 2,
      .default = 4
    )
  ) %>%
  select(transferHeaders) %>%
  arrange(ot2set) %>%
  mutate(id = row_number())

bfh_transferInfo_pp3 <- bfh_transferInfo_pp2 %>%
  mutate(dest_slot = 5)

bfh_pcr1_xtnTransfer <- rbind(bfh_transferInfo_pp2,
                               bfh_transferInfo_pp3) %>%
  arrange(id, dest_slot) %>%
  select(-id)
```

##### Water & mm transfer info

Blood samples only require 2ul xtn volume, so need to add 2ul water to match the reaction volume.

```{r}
bfh_pcr1_waterTransfer <- data.frame(
  ot2set = rep("set8_water.mm", 8),
  reagent = "nf-water",
  source_labware = basePlate,
  source_slot = 6,
  source_well = "A1",
  asp_height = 1,
  dest_labware = nestPlate,
  dest_slot = c(rep(2, 4), rep(5, 4)),
  dest_well = rep(c("A1", "A2", "A3", "A4"), 2),
  transfer_volume = 2
) %>%
  select(transferHeaders)

bfh_pcr1_mmTransfer <- data.frame(
  ot2set = rep("set8_water.mm", 24),
  reagent = "mastermix",
  source_labware = basePlate,
  source_slot = 6,
  source_well = c(rep("A2", 12), rep("A3", 12)),
  asp_height = 1,
  dest_labware = nestPlate,
  dest_slot = c(rep(2, 12), rep(5, 12)),
  dest_well = rep(grep("A", wellValues_plate, value = T), 2),
  transfer_volume = 6
) %>%
  select(transferHeaders)
```

#### Full OT2 input

```{r}
bfh_pcr1_fullTransferInput <- rbind(
  bfh_pcr1_xtnTransfer,
  bfh_pcr1_waterTransfer,
  bfh_pcr1_mmTransfer)
```

Export

```{r}
# comma-separated string with end-of-line delimiter
bfh_pcr1_ot2Input_string <- format_delim(bfh_pcr1_fullTransferInput,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/30x3_pcr1setup_forOT2_string.txt")

bfh_pcr1_ot2Input_string

sink()

# csv file
write.csv(bfh_pcr1_ot2Input, "./robotProtocols/inputFiles/30x3_pcr1setup_forOT2.csv", row.names = F)
```

### 5.2.2 tamGenetics

#### Plate 1 & 2 (blood samples)

((do Strip 1 MANUALLY))

##### Plate 1 xtn transfer

```{r}
# xtn list plate 1
tamGenetics_xtns_p1 <- xtnsAll_updated %>%
  filter(lysisLoc == "p1") %>%
  filter(eltn == "e1") %>%
  arrange(lysisLoc, lysisCol, lysisRow) %>%
  mutate(transferID = row_number()) %>%
  mutate(
    sampleType_animalID = str_c(sampleType, "_", animalID)
  ) %>%
  # replace "SKIP" xtns
  merge(., xtnsRemaining_byAnimalID, by = "sampleType_animalID", all.x = T) %>%
  mutate(
    xtnID = case_when(
      xtnRemaining == "no" ~ xtnID.1,
      .default = xtnID
    )
  ) %>%
  arrange(transferID) %>%
  select(c("transferID", "sampleType_animalID", "sampleType", "xtnID", "xtnLoc", "eltn", "xtnRow", "xtnCol", "xtnPlate_beadsPresent"))
  
# assign source wells
tamGenetics_sourceWells_bloodTubes <- tamGenetics_xtns_p1 %>%
  filter(str_detect(xtnID, "blood_t")) %>%
  mutate(
    source_well.t = wellValues_tuberack[1:length(xtnID)]
  )

tamGenetics_xtnTransfer_p1 <- tamGenetics_xtns_p1 %>%
  merge(., tamGenetics_sourceWells_bloodTubes[, c("xtnID", "source_well.t")], by = "xtnID", all.x = T) %>%
  arrange(as.numeric(transferID)) %>%
  mutate(
    ot2set = case_when(
      str_detect(xtnID, "p") & str_detect(xtnID, "e1") ~ "set1_xtnPlate1_e1",
      str_detect(xtnID, "p") & str_detect(xtnID, "e2") ~ "set2.1_xtnPlate1_e2",
      str_detect(xtnID, "blood_t") ~ "set2.2_xtnPlate1.tubes"
      ),
    reagent = xtnID,
    source_labware = case_when(
      str_detect(xtnID, "p1") ~ nestPlate,
      str_detect(xtnID, "p2") ~ nestPlate,
      str_detect(xtnID, "p3") ~ nestPlate,
      str_detect(xtnID, "p4") ~ basePlate,
      str_detect(xtnID, "blood_t") ~ tuberack
    ),
    source_slot = case_when(
      xtnPlate_beadsPresent == "yes" ~ 7,
      (str_detect(xtnID, "p") & str_detect(xtnID, "e1")) ~ 1,
      (str_detect(xtnID, "p") & str_detect(xtnID, "e2")) ~ 4,
      str_detect(xtnID, "blood_t") ~ 3
    ),
    source_well = case_when(
      str_detect(xtnID, "p") ~ str_c(xtnRow, xtnCol),
      .default = source_well.t),
    asp_height = 1,
    dest_labware = basePlate,
    dest_slot = 2,
    dest_well = wellValues_plate,
    transfer_volume = case_when(
      str_detect(sampleType, "blood") ~ 2,
      .default = 4
    )
  ) %>%
  select(transferHeaders) %>%
  arrange(ot2set)
```

##### Plate 1 mastermix transfer

```{r}
tamGenetics_mmTransfer_pcr1_p1 <- data.frame(
  ot2set = rep("set3_mm", 12),
  reagent = "mastermix",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = rep("A1", 12),
  asp_height = 1,
  dest_labware = nestPlate,
  dest_slot = rep(2, 12),
  dest_well = grep("A", wellValues_plate, value = T),
  transfer_volume = 8
  ) %>%
  select(transferHeaders)
```

##### Plate 2 xtn transfer

```{r}
# xtn list plate 2
tamGenetics_xtns_p2 <- xtnsAll_updated %>%
  filter(lysisLoc == "p2") %>%
  filter(eltn == "e1") %>%
  arrange(lysisLoc, lysisCol, lysisRow) %>%
  mutate(transferID = row_number()) %>%
  mutate(
    sampleType_animalID = str_c(sampleType, "_", animalID)
  ) %>%
  # replace "SKIP" xtns
  merge(., xtnsRemaining_byAnimalID, by = "sampleType_animalID", all.x = T) %>%
  mutate(
    xtnID = case_when(
      xtnRemaining == "no" ~ xtnID.1,
      .default = xtnID
    )
  ) %>%
  arrange(transferID) %>%
  select(c("transferID", "sampleType_animalID", "sampleType", "xtnID", "xtnLoc", "eltn", "xtnRow", "xtnCol", "xtnPlate_beadsPresent"))
  
# assign source wells
tamGenetics_sourceWells_bloodTubes <- tamGenetics_xtns_p2 %>%
  filter(str_detect(xtnID, "blood_t")) %>%
  mutate(
    source_well.t = wellValues_tuberack[1:length(xtnID)]
  )

tamGenetics_xtnTransfer_p2 <- tamGenetics_xtns_p2 %>%
  merge(., tamGenetics_sourceWells_bloodTubes[, c("xtnID", "source_well.t")], by = "xtnID", all.x = T) %>%
  arrange(as.numeric(transferID)) %>%
  mutate(
    ot2set = case_when(
      str_detect(xtnID, "p") & str_detect(xtnID, "e1") ~ "set4_xtnPlate2_e1",
      str_detect(xtnID, "p") & str_detect(xtnID, "e2") ~ "set5.1_xtnPlate2_e2",
      str_detect(xtnID, "blood_t") ~ "set5.2_xtnPlate1.tubes"
      ),
    reagent = xtnID,
    source_labware = case_when(
      str_detect(xtnID, "p1") ~ nestPlate,
      str_detect(xtnID, "p2") ~ nestPlate,
      str_detect(xtnID, "p3") ~ nestPlate,
      str_detect(xtnID, "p4") ~ basePlate,
      str_detect(xtnID, "blood_t") ~ tuberack
    ),
    source_slot = case_when(
      xtnPlate_beadsPresent == "yes" ~ 7,
      (str_detect(xtnID, "p") & str_detect(xtnID, "e1")) ~ 1,
      (str_detect(xtnID, "p") & str_detect(xtnID, "e2")) ~ 4,
      str_detect(xtnID, "blood_t") ~ 3
    ),
    source_well = case_when(
      str_detect(xtnID, "p") ~ str_c(xtnRow, xtnCol),
      .default = source_well.t),
    asp_height = 1,
    dest_labware = basePlate,
    dest_slot = 2,
    dest_well = wellValues_plate,
    transfer_volume = case_when(
      str_detect(sampleType, "blood") ~ 2,
      .default = 4
    )
  ) %>%
  select(transferHeaders) %>%
  arrange(ot2set)
```

##### Plate 2 mastermix transfer

```{r}
tamGenetics_mmTransfer_pcr1_p2 <- data.frame(
  ot2set = rep("set6_mm", 12),
  reagent = "mastermix",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = rep("A2", 12),
  asp_height = 1,
  dest_labware = nestPlate,
  dest_slot = rep(2, 12),
  dest_well = grep("A", wellValues_plate, value = T),
  transfer_volume = 8
  ) %>%
  select(transferHeaders)
```

##### OT2 transfer info

Full transfer info

```{r}
tamGenetics_pcr1_p12 <- rbind(
  tamGenetics_xtnTransfer_p1,
  tamGenetics_mmTransfer_pcr1_p1,
  tamGenetics_xtnTransfer_p2,
  tamGenetics_mmTransfer_pcr1_p2)
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_pcr1_p12_string <- format_delim(tamGenetics_pcr1_p12,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_pcr1setup_forOT2_p12_string.txt")

tamGenetics_pcr1_p12_string

sink()

# csv file
write.csv(tamGenetics_pcr1_p12, "./robotProtocols/inputFiles/tamGenetics_pcr1setup_forOT2_p12.csv", row.names = F)
```

#### Strip 1 sample list (manual)

```{r}
tamGenetics_xtns_s1 <- xtnsAll_updated %>%
  filter(sampleType == "blood") %>%
  filter(str_detect(lysisLoc, "t")) %>%
  filter(eltn == "e1") %>%
  arrange(as.numeric(str_sub(xtnLoc, 2, -1))) %>%
  select(xtnID)
```

#### Plate 3a & 3b (hair samples)

##### Plate 3a/b xtn transfer

```{r}
# xtn list plates 3ab
tamGenetics_xtns_p3ab <- xtnsAll_updated %>%
  filter(xtnLoc == "p3") %>%
  filter(eltn == "e1") %>%
  arrange(xtnLoc, xtnCol, xtnRow) %>%
  mutate(transferID = row_number()) %>%
  mutate(
    sampleType_animalID = str_c(sampleType, "_", animalID)
  ) %>%
  # replace "SKIP" xtns
  merge(., xtnsRemaining_byAnimalID, by = "sampleType_animalID", all.x = T) %>%
  mutate(
    xtnID = case_when(
      xtnRemaining == "no" ~ xtnID.1,
      .default = xtnID
    )
  ) %>%
  arrange(transferID) %>%
  select(c("transferID", "sampleType_animalID", "sampleType", "xtnID", "xtnLoc", "eltn", "xtnRow", "xtnCol", "xtnPlate_beadsPresent"))
  
# assign source wells
tamGenetics_sourceWells_hairTubes.p3ab <- tamGenetics_xtns_p3ab %>%
  filter(str_detect(xtnID, "hair_t")) %>%
  mutate(
    source_well.t = wellValues_tuberack[1:length(xtnID)]
  )

tamGenetics_xtnTransfer_p3a <- tamGenetics_xtns_p3ab %>%
  merge(., tamGenetics_sourceWells_hairTubes.p3ab[, c("xtnID", "source_well.t")], by = "xtnID", all.x = T) %>%
  arrange(as.numeric(transferID)) %>%
  mutate(
    ot2set = case_when(
      is.na(xtnID) ~ "EXCLUDE",
      str_detect(xtnID, "p") & str_detect(xtnID, "e1") ~ "set1_xtnPlate3_e1",
      str_detect(xtnID, "p") & str_detect(xtnID, "e2") ~ "set2.1_xtnPlate3_e2",
      str_detect(xtnID, "hair_t") ~ "set2.2_xtnPlate3.tubes"
      ),
    reagent = xtnID,
    source_labware = case_when(
      is.na(xtnID) ~ "EXCLUDE",
      str_detect(xtnID, "p1") ~ nestPlate,
      str_detect(xtnID, "p2") ~ nestPlate,
      str_detect(xtnID, "p3") ~ nestPlate,
      str_detect(xtnID, "p4") ~ basePlate,
      str_detect(xtnID, "hair_t") ~ tuberack
    ),
    source_slot = case_when(
      is.na(xtnID) ~ NA,
      str_detect(xtnID, "hair_t") ~ 3,
      xtnPlate_beadsPresent == "yes" ~ 7,
      (str_detect(xtnID, "p") & str_detect(xtnID, "e1")) ~ 1,
      (str_detect(xtnID, "p") & str_detect(xtnID, "e2")) ~ 4
    ),
    source_well = case_when(
      is.na(xtnID) ~ "EXCLUDE",
      str_detect(xtnID, "p") ~ str_c(xtnRow, xtnCol),
      .default = source_well.t),
    asp_height = 1,
    dest_labware = basePlate,
    dest_slot = 2,
    dest_well = wellValues_plate,
    transfer_volume = case_when(
      str_detect(sampleType, "blood") ~ 2,
      .default = 4
    )
  ) %>%
  filter(ot2set != "EXCLUDE") %>%
  select(transferHeaders) %>%
  arrange(ot2set) %>%
  mutate(id = row_number())

tamGenetics_xtnTransfer_p3b <- tamGenetics_xtnTransfer_p3a %>%
  mutate(dest_slot = 5)

tamGenetics_xtnTransfer_p3ab <- rbind(tamGenetics_xtnTransfer_p3a,
                                      tamGenetics_xtnTransfer_p3b) %>%
  arrange(id, dest_slot) %>%
  select(-id)
```

##### Plate 3a/b mastermix transfer

```{r}
tamGenetics_mmTransfer_pcr1_p3ab <- data.frame(
  ot2set = rep("set3_mm", 12),
  reagent = "mastermix",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = c(rep("A4", 12), rep("A5", 12)),
  asp_height = 1,
  dest_labware = nestPlate,
  dest_slot = c(rep(2, 12), rep(5, 12)),
  dest_well = rep(grep("A", wellValues_plate, value = T), 2),
  transfer_volume = 6
  ) %>%
  select(transferHeaders)
```

##### OT2 transfer info

Full transfer info

```{r}
tamGenetics_pcr1_p3ab <- rbind(tamGenetics_xtnTransfer_p3ab,
                               tamGenetics_mmTransfer_pcr1_p3ab)
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_pcr1_p3ab_string <- format_delim(tamGenetics_pcr1_p3ab,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_pcr1_p3ab_string.txt")

tamGenetics_pcr1_p3ab_string

sink()

# csv file
write.csv(tamGenetics_pcr1_p3ab, "./robotProtocols/inputFiles/tamGenetics_pcr1_p3ab.csv", row.names = F)
```

#### Plate 4a & 4b (hair samples)

##### Plate 4a/b xtn transfer

###### xtnPlate4

```{r}
# xtn list plates 4 (74 samples in plate)
tamGenetics_xtns_xtnPlate4 <- xtnsAll_updated %>%
  filter(xtnLoc == "p4") %>%
  filter(eltn == "e1") %>%
  arrange(xtnLoc, xtnCol, xtnRow) %>%
  mutate(transferID = row_number()) %>%
  mutate(
    sampleType_animalID = str_c(sampleType, "_", animalID)
  ) %>%
  # replace "SKIP" xtns
  merge(., xtnsRemaining_byAnimalID, by = "sampleType_animalID", all.x = T) %>%
  mutate(
    xtnID = case_when(
      xtnRemaining == "no" ~ xtnID.1,
      .default = xtnID
    )
  ) %>%
  arrange(transferID) %>%
  select(c("transferID", "sampleType_animalID", "sampleType", "xtnID", "xtnLoc", "eltn", "xtnRow", "xtnCol", "xtnPlate_beadsPresent"))
  
# xtn tubes in original xtnPlate4
tamGenetics_hairTubes.xtnPlate4 <- tamGenetics_xtns_xtnPlate4 %>%
  filter(str_detect(xtnID, "hair_t"))
```

###### xtnPlate_tamTiger

```{r}
# xtn list plate tamTiger1
tamGenetics_xtns_ptamTiger1 <- xtnsAll_updated %>%
  filter(xtnLoc == "ptamTiger1") %>%
  filter(eltn == "e1") %>%
  arrange(xtnLoc, xtnCol, xtnRow) %>%
  mutate(transferID =
    (length(tamGenetics_xtns_xtnPlate4$xtnID)+1):
      (
        (length(tamGenetics_xtns_xtnPlate4$xtnID)+1) + 
        (length(xtnID)-1)
      )
    ) %>%
  mutate(
    sampleType_animalID = str_c(sampleType, "_", animalID)
  ) %>%
  # replace "SKIP" xtns
  merge(., xtnsRemaining_byAnimalID, by = "sampleType_animalID", all.x = T) %>%
  mutate(
    xtnID = case_when(
      xtnRemaining == "no" ~ xtnID.1,
      .default = xtnID
    )
  ) %>%
  arrange(transferID) %>%
  select(c("transferID", "sampleType_animalID", "sampleType", "xtnID", "xtnLoc", "eltn", "xtnRow", "xtnCol", "xtnPlate_beadsPresent"))
  
# xtn tubes in original xtnPlate tamTiger1
tamGenetics_hairTubes.ptamTiger1 <- tamGenetics_xtns_ptamTiger1 %>%
  filter(str_detect(xtnID, "hair_t"))

# xtn list plate tamTiger2
tamGenetics_xtns_ptamTiger2 <- xtnsAll_updated %>%
  filter(xtnLoc == "ptamTiger2") %>%
  filter(eltn == "e1") %>%
  arrange(xtnLoc, xtnCol, xtnRow) %>%
  mutate(transferID =
    (length(tamGenetics_xtns_xtnPlate4$xtnID) +
       length(tamGenetics_xtns_ptamTiger1$xtnID) +
       1):
      (
        (length(tamGenetics_xtns_xtnPlate4$xtnID) +
       length(tamGenetics_xtns_ptamTiger1$xtnID) +
       1) + 
        (length(xtnID)-1)
      )
    ) %>%
  mutate(
    sampleType_animalID = str_c(sampleType, "_", animalID)
  ) %>%
  # replace "SKIP" xtns
  merge(., xtnsRemaining_byAnimalID, by = "sampleType_animalID", all.x = T) %>%
  mutate(
    xtnID = case_when(
      xtnRemaining == "no" ~ xtnID.1,
      .default = xtnID
    )
  ) %>%
  arrange(transferID) %>%
  select(c("transferID", "sampleType_animalID", "sampleType", "xtnID", "xtnLoc", "eltn", "xtnRow", "xtnCol", "xtnPlate_beadsPresent"))
  
# xtn tubes in original xtn plate tamTiger2
tamGenetics_hairTubes.ptamTiger2 <- tamGenetics_xtns_ptamTiger2 %>%
  filter(str_detect(xtnID, "hair_t"))
```

###### All plate xtns for pcr1Plate4ab

```{r}
# assign source wells for tube xtns originally in plates
tamGenetics_sourceWells_hairTubes.p4ptamTiger12 <- rbind(
  tamGenetics_hairTubes.xtnPlate4,
  tamGenetics_hairTubes.ptamTiger1,
  tamGenetics_hairTubes.ptamTiger2)  %>%
  mutate(
    source_well.t = wellValues_tuberack[1:length(xtnID)]
  )

# combine all plate xtns into one list
tamGenetics_xtnTransfer_pcr1Plate4ab_plateXtns <- rbind(tamGenetics_xtns_xtnPlate4,
                                           tamGenetics_xtns_ptamTiger1,
                                           tamGenetics_xtns_ptamTiger2) %>%
  merge(., tamGenetics_sourceWells_hairTubes.p4ptamTiger12[, c("xtnID", "source_well.t")], by = "xtnID", all.x = T) %>%
  arrange(as.numeric(transferID)) %>%
  select(c("transferID", "sampleType_animalID", "sampleType", "xtnID", "xtnLoc", "eltn", "xtnRow", "xtnCol", "xtnPlate_beadsPresent", "source_well.t"))
```

###### Xtn tubes not originally in xtnPlates

78 wells are taken up by xtns from xtnPlate4, xtnPlatetamTiger1, and xtnPlatetamTiger2. This leaves 18 wells to be filled with xtns not originally in xtn plates.

```{r}
# number of wells available in pcr1Plate4ab after plate xtns
wellsRemaining_pcr1Plate4ab <- 96 - length(tamGenetics_xtnTransfer_pcr1Plate4ab_plateXtns$xtnID) # 18

# xtn list for those not originally in xtn plates
tamGenetics_nonPlateHairXtns <- xtnsAll_updated %>%
  filter(sampleType == "hair") %>%
  # remove tubes in pcr1Plate3ab
  filter(!str_c("hair_", animalID) %in% tamGenetics_xtns_p3ab$sampleType_animalID) %>%
  # remove tubes in plate xtns for pcr1Plate4ab
  filter(!str_c("hair_", animalID) %in% tamGenetics_xtnTransfer_pcr1Plate4ab_plateXtns$sampleType_animalID) %>%
  filter(eltn == "e1") %>%
  filter(!duplicated(animalID))

tamGenetics_nonPlateHairXtns_remaining <- tamGenetics_nonPlateHairXtns %>%
  filter(xtnRemaining == "yes")

# number of tubes already present from xtnPlate tube xtns
wellValues_tuberack_toExclude <- sum(!is.na(tamGenetics_xtnTransfer_pcr1Plate4ab_plateXtns$source_well.t))

# choose tubes to include in pcr1Plate4ab & assign source wells
tamGenetics_nonPlateHairXtns_pcr1Plate4ab <- tamGenetics_nonPlateHairXtns_remaining[1:as.numeric(wellsRemaining_pcr1Plate4ab),] %>%
  mutate(
    sampleType_animalID = str_c(sampleType, "_", animalID),
    source_well.t = wellValues_tuberack[as.numeric((wellValues_tuberack_toExclude)+1):(length(xtnID)+1)],
    transferID = (96-18+1):96
  ) %>%
  # replace "SKIP" xtns
  merge(., xtnsRemaining_byAnimalID, by = "sampleType_animalID", all.x = T) %>%
  mutate(
    xtnID = case_when(
      xtnRemaining == "no" ~ xtnID.1,
      .default = xtnID
    )
  ) %>%
  arrange(transferID) %>%
  select(c("transferID", "sampleType_animalID", "sampleType", "xtnID", "xtnLoc", "eltn", "xtnRow", "xtnCol", "xtnPlate_beadsPresent", "source_well.t"))
```

###### All xtn transfers

```{r}
# all xtns for pcr1Plate4ab
tamGenetics_xtns_pcr1Plate4ab <- rbind(
  tamGenetics_xtnTransfer_pcr1Plate4ab_plateXtns,
  tamGenetics_nonPlateHairXtns_pcr1Plate4ab) %>%
  mutate(
    xtnID = case_when(
      is.na(xtnID) ~ "hair_ptamTiger1.A1_e1",
      .default = xtnID
    )
  )

tamGenetics_xtnTransfer_p4a <- tamGenetics_xtns_pcr1Plate4ab %>%
  arrange(as.numeric(transferID)) %>%
  mutate(
    ot2set = case_when(
#      is.na(xtnID) ~ "EXCLUDE",
      str_detect(xtnID, "p4") & str_detect(xtnID, "e1") ~ "set1.1_xtnPlate4_e1",
      str_detect(xtnID, "p4") & str_detect(xtnID, "e2") ~ "set1.2_xtnPlate4_e2",
      str_detect(xtnID, "ptamTiger1") ~ "set1.3_xtnPlate.tamTiger1",
      str_detect(xtnID, "ptamTiger2") ~ "set1.4_xtnPlate.tamTiger2",
      str_detect(xtnID, "hair_t") ~ "set1.5_xtnTubes"
      ),
    reagent = xtnID,
    source_labware = case_when(
#      is.na(xtnID) ~ "EXCLUDE",
      str_detect(xtnID, "p1") ~ nestPlate,
      str_detect(xtnID, "p2") ~ nestPlate,
      str_detect(xtnID, "p3") ~ nestPlate,
      str_detect(xtnID, "p4") ~ basePlate,
      str_detect(xtnID, "tamTiger") ~ nestPlate,
      str_detect(xtnID, "hair_t") ~ tuberack
    ),
    source_slot = case_when(
#      is.na(xtnID) ~ NA,
      str_detect(ot2set, "set1.1") ~ 1,
      str_detect(ot2set, "set1.2") ~ 4,
      str_detect(ot2set, "set1.3") ~ 7,
      str_detect(ot2set, "set1.4") ~ 10,
      str_detect(ot2set, "set1.5") ~ 3
    ),
    source_well = case_when(
#      is.na(xtnID) ~ "EXCLUDE",
      str_detect(xtnID, "p") ~ str_c(xtnRow, xtnCol),
      !is.na(source_well.t) ~ source_well.t
      ),
    asp_height = 1,
    dest_labware = basePlate,
    dest_slot = 2,
    dest_well = wellValues_plate,
    transfer_volume = case_when(
      str_detect(sampleType, "blood") ~ 2,
      .default = 4
    )
  ) %>%
#  filter(ot2set != "EXCLUDE") %>%
  select(transferHeaders) %>%
  arrange(ot2set) %>%
  mutate(transferID = row_number())

tamGenetics_xtnTransfer_p4b <- tamGenetics_xtnTransfer_p4a %>%
  mutate(dest_slot = 5)

tamGenetics_xtnTransfer_p4ab <- rbind(tamGenetics_xtnTransfer_p4a,
                                      tamGenetics_xtnTransfer_p4b) %>%
  arrange(transferID, dest_slot) %>%
  select(-transferID)

tamGenetics_xtnTransfer_p4ab_distribute <- tamGenetics_xtnTransfer_p4a %>%
  select(-transferID)
```

##### Plate 4a/b mastermix transfer

```{r}
tamGenetics_mmTransfer_pcr1_p4ab <- data.frame(
  ot2set = rep("set2_mm", 24),
  reagent = "mastermix",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = c(rep("A1", 12), rep("A2", 12)),
  asp_height = 1,
  dest_labware = nestPlate,
  dest_slot = c(rep(2, 12), rep(5, 12)),
  dest_well = rep(grep("A", wellValues_plate, value = T), 2),
  transfer_volume = 6
  ) %>%
  select(transferHeaders)
```

##### OT2 transfer info

Full transfer info - use just the xtn transfers for one plate; will specify to distribute xtn volume to both xtn plates in the python script

```{r}
# tamGenetics_pcr1_p4ab <- rbind(tamGenetics_xtnTransfer_p4ab,
#                                tamGenetics_mmTransfer_pcr1_p4ab)

tamGenetics_pcr1_4ab_distribute <- rbind(tamGenetics_xtnTransfer_p4ab_distribute,
                                         tamGenetics_mmTransfer_pcr1_p4ab)
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_pcr1_p4ab_string <- format_delim(tamGenetics_pcr1_4ab_distribute,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_pcr1_p4ab_string.txt")

tamGenetics_pcr1_p4ab_string

sink()

# csv file
write.csv(tamGenetics_pcr1_4ab_distribute, "./robotProtocols/inputFiles/tamGenetics_pcr1_p4ab.csv", row.names = F)
```

#### Plate 5ab (hair samples)

##### Plate 5ab xtn transfer

```{r}
tamGenetics_nonPlateHairXtns_pcr1Plate5ab <- tamGenetics_nonPlateHairXtns %>%
  filter(!str_c("hair_", animalID) %in% tamGenetics_xtns_pcr1Plate4ab$sampleType_animalID) %>%
  mutate(
    x1 = case_when(
      str_detect(xtnLoc, "tx") ~ "tx",
      .default = "t"
      ),
    x2 = case_when(
      str_detect(xtnLoc, "tx") ~ str_sub(xtnLoc, start = 3, end = -1),
      .default = str_sub(xtnLoc, 2, -1)
    ),
    x2 = case_when(
      str_detect(x2, "A") ~ gsub("A", "", x2),
      .default = x2
    )
  ) %>%
  arrange(x1, as.numeric(x2)) %>%
  mutate(
    transferID = row_number(),
    sampleType_animalID = str_c(sampleType, "_", animalID)
    ) %>%
  # replace "SKIP" xtns
  merge(., xtnsRemaining_byAnimalID, by = "sampleType_animalID", all.x = T) %>%
  mutate(
    xtnID = case_when(
      xtnRemaining == "no" ~ xtnID.1,
      .default = xtnID
    )
  ) %>%
  arrange(transferID) %>%
  select(c("transferID", "sampleType_animalID", "sampleType", "xtnID", "xtnLoc", "eltn"))

tamGenetics_negs_pcr1Plate5ab <- data.frame(
  transferID = 26.1,
  sampleType_animalID = "hair_pcr1Neg",
  sampleType = "hair_pcr1Neg",
  xtnID = "hair_pcr1Neg",
  xtnLoc = NA,
  eltn = NA
)

# source wells
source_wells_3tuberacks <- rep(wellValues_tuberack, 3)

# xtn transfer
tamGenetics_xtnTransfer_p5ab <- rbind(tamGenetics_nonPlateHairXtns_pcr1Plate5ab,
                                      tamGenetics_negs_pcr1Plate5ab) %>%
  arrange(as.numeric(transferID)) %>%
  mutate(
    transferID = row_number(),
    ot2set = case_when(
      as.numeric(transferID) <= 24 ~ "set1_tubes1to24",
      as.numeric(transferID) <= 48 ~ "set2_tubes25to48",
      as.numeric(transferID) > 48 ~ "set3_tubes49up"
    ),
    reagent = xtnID,
    source_labware = tuberack,
    source_slot = 3,
    source_well = source_wells_3tuberacks[1:length(xtnID)],
    asp_height = 1,
    dest_labware = basePlate,
    dest_slot = 2,
    dest_well = wellValues_plate[1:length(xtnID)],
    transfer_volume = case_when(
      str_detect(sampleType, "blood") ~ 2,
      .default = 4
    )
  ) %>%
  select(transferHeaders)
```

##### Plate 5a/b mastermix transfer

```{r}
destValues_mastermix <- grep("A", wellValues_plate, value = T)

tamGenetics_mmTransfer_pcr1_p5ab <- data.frame(
  ot2set = rep("set4_mm", 14),
  reagent = "mastermix",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = c(rep("A4", 7), rep("A5", 7)),
  asp_height = 1,
  dest_labware = nestPlate,
  dest_slot = c(rep(2, 7), rep(5, 7)),
  dest_well = rep(destValues_mastermix[1:7], 2),
  transfer_volume = 6
  ) %>%
  select(transferHeaders)
```

##### OT2 transfer info

Full transfer info - use just the xtn transfers for one plate; will specify to distribute xtn volume to both xtn plates in the python script

```{r}
tamGenetics_pcr1Plate5ab <- rbind(
  tamGenetics_xtnTransfer_p5ab,
  tamGenetics_mmTransfer_pcr1_p5ab)
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_pcr1Plate5ab_string <- format_delim(tamGenetics_pcr1Plate5ab,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_pcr1_p5ab_string.txt")

tamGenetics_pcr1Plate5ab_string

sink()

# csv file
write.csv(tamGenetics_pcr1Plate5ab, "./robotProtocols/inputFiles/tamGenetics_pcr1_p5ab.csv", row.names = F)
```

## 5.3 Dilutions + PCR2

### 5.3.1 30x3

##### Steps

Transfering 8 ul water vs. 10 ul - spot-checked some wells and they ranged from 7-9ul in actual volume (vs. the 10 ul they were supposed to be at)

```{r}
# step 1: 8 ul water to pcr1 a >>
# PYTHON SCRIPT: 4 ul pcr1 a to dilution plate > 4 ul dilution to pcr2 plate
bfh_dPCR2_pcr1a.dilutionPlate <- data.frame(
  ot2set = "set1_water.pcr1a.dilutionPlate",
  reagent = "water.pcr1a.dilution",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 2,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 8
)

# step 2: 8 ul water to pcr1 b >>
# PYTHON SCRIPT: 4 ul pcr1 b to dilution plate > 4 ul dilution to pcr2 plate > 32 ul water to dilution plate > 6 ul dilution to pcr2 plate
bfh_dPCR2_pcr1b.dilutionPlate <- data.frame(
  ot2set = "set2_water.pcr1b.dilutionPlate.pcr2",
  reagent = "water.pcr1b.dilution",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 3,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 8
)

# step 3: index primers to pcr2 plate
bfh_dPCR2_indexes.pcr2 <- data.frame(
  ot2set = "set3_indexes.pcr2",
  reagent = "indexPlate_setA",
  source_labware = nestPlate,
  source_slot = 11,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 3,
  dest_labware = basePlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 4
)

# step 4: kapa to pcr2 plate
bfh_dPCR2_kapa.pcr2 <- data.frame(
  ot2set = "set4_kapa.pcr2",
  reagent = "kapa",
  source_labware = basePlate,
  source_slot = 7,
  source_well = "A1",
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 10
)
```

##### OT2 transfer info

```{r}
bfh_dilutionsPCR2_p1ab <- rbind(
  bfh_dPCR2_pcr1a.dilutionPlate,
  bfh_dPCR2_pcr1b.dilutionPlate,
  bfh_dPCR2_indexes.pcr2,
  bfh_dPCR2_kapa.pcr2
) %>%
  select("ot2set", "reagent", "source_labware", "source_slot", "source_well", "asp_height", "dest_labware", "dest_slot", "dest_well", "disp_height", "transfer_volume")
```

Export

```{r}
# comma-separated string with end-of-line delimiter
bfh_dilutionsPCR2_p1ab_string <- format_delim(bfh_dilutionsPCR2_p1ab,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/30x3_dilutionsPCR2_p1ab_string.txt")

bfh_dilutionsPCR2_p1ab_string

sink()

# csv file
write.csv(bfh_dilutionsPCR2_p1ab, "./robotProtocols/inputFiles/30x3_dilutionsPCR2_p1ab.csv", row.names = F)
```

### 5.3.2 tamGenetics

#### Plate 1: Take 1

##### Steps

Adding a dispense height variable & adjusting disp_height for water transfer so can reuse tips for dilutions to pcr2 plate transfer

```{r}
# step 1: pcr1 to dilution plate
tamGenetics_dPCR2_pcr1.dilutionPlate_p1 <- data.frame(
  ot2set = "set1_pcr1.dilutionPlate",
  reagent = "pcr1Plate1",
  source_labware = basePlate,
  source_slot = 2,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 1,
  dest_labware = nestPlate,
  dest_slot = 5,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 2
)

# step 2: water to dilution plate
tamGenetics_dPCR2_water.dilutionPlate_p1 <- data.frame(
  ot2set = "set2_water.dilutionPlate",
  reagent = "nf-water",
  source_labware = reservoir_12well,
  source_slot = 7,
  source_well = "A1",
  asp_height = 1,
  dest_labware = nestPlate,
  dest_slot = 5,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 18
)

# step 3: dilutions to pcr2 plate
tamGenetics_dPCR2_dilutionPlate.pcr2_p1 <- data.frame(
  ot2set = "set3_dilutionPlate.pcr2",
  reagent = "dilutionPlate",
  source_labware = nestPlate,
  source_slot = 5,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 6
)

# step 4: index primers to pcr2 plate
tamGenetics_dPCR2_indexes.pcr2_p1 <- data.frame(
  ot2set = "set4_indexes.pcr2",
  reagent = "indexPlate_setA",
  source_labware = nestPlate,
  source_slot = 11,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 3,
  dest_labware = basePlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 4
)

# step 5: kapa to pcr2 plate
tamGenetics_dPCR2_kapa.pcr2_p1 <- data.frame(
  ot2set = "set5_kapa.pcr2",
  reagent = "kapa",
  source_labware = reservoir_12well,
  source_slot = 7,
  source_well = "A4",
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 10
)
```

##### OT2 transfer info

```{r}
tamGenetics_dilutionsPCR2_p1 <- rbind(
  tamGenetics_dPCR2_pcr1.dilutionPlate_p1,
  tamGenetics_dPCR2_water.dilutionPlate_p1,
  tamGenetics_dPCR2_dilutionPlate.pcr2_p1,
  tamGenetics_dPCR2_indexes.pcr2_p1,
  tamGenetics_dPCR2_kapa.pcr2_p1
) %>%
  select("ot2set", "reagent", "source_labware", "source_slot", "source_well", "asp_height", "dest_labware", "dest_slot", "dest_well", "disp_height", "transfer_volume")
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_dilutionsPCR2_p1_string <- format_delim(tamGenetics_dilutionsPCR2_p1,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p1_string.txt")

tamGenetics_dilutionsPCR2_p1_string

sink()

# csv file
write.csv(tamGenetics_dilutionsPCR2_p1, "./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p1.csv", row.names = F)
```


blowout adjust

```{r}
tamGenetics_dilutionsPCR2_p1_blowoutAdjust <- tamGenetics_dilutionsPCR2_p1 %>%
  filter(ot2set != "set1_pcr1.dilutionPlate1") %>%
  mutate(id = row_number()) %>%
  filter(id != c(1, 2, 3, 4)) %>%
  select(-id)
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_dilutionsPCR2_p1_blowoutAdjust_string <- format_delim(tamGenetics_dilutionsPCR2_p1_blowoutAdjust,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p1_blowoutAdjust_string.txt")

tamGenetics_dilutionsPCR2_p1_blowoutAdjust_string

sink()

# csv file
write.csv(tamGenetics_dilutionsPCR2_p1_blowoutAdjust, "./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p1_blowoutAdjust.csv", row.names = F)
```

#### Plate 1: Take 2

##### Steps

```{r}
# step 1: water to pcr1 >>
# PYTHON SCRIPT: pcr1 to dilution plate > dilution plate to pcr2 plate
tamGenetics_dPCR2_pcr1.dilutionPlate_p1Take2 <- data.frame(
  ot2set = "set1_water.pcr1.dilutionPlate.pcr2",
  reagent = "water.pcr1.dilution",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 2,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 8
)

# step 2: index primers to pcr2 plate
tamGenetics_dPCR2_indexes.pcr2_p1Take2 <- data.frame(
  ot2set = "set2_indexes.pcr2",
  reagent = "indexPlate_setA",
  source_labware = nestPlate,
  source_slot = 11,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 3,
  dest_labware = basePlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 4
)

# step 3: kapa to pcr2 plate
tamGenetics_dPCR2_kapa.pcr2_p1Take2 <- data.frame(
  ot2set = "set3_kapa.pcr2",
  reagent = "kapa",
  source_labware = basePlate,
  source_slot = 7,
  source_well = "A1",
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 10
)
```

##### OT2 transfer info

```{r}
tamGenetics_dilutionsPCR2_p1Take2 <- rbind(
  tamGenetics_dPCR2_pcr1.dilutionPlate_p1Take2,
  tamGenetics_dPCR2_indexes.pcr2_p1Take2,
  tamGenetics_dPCR2_kapa.pcr2_p1Take2
) %>%
  select("ot2set", "reagent", "source_labware", "source_slot", "source_well", "asp_height", "dest_labware", "dest_slot", "dest_well", "disp_height", "transfer_volume")
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_dilutionsPCR2_p1Take2_string <- format_delim(tamGenetics_dilutionsPCR2_p1Take2,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p1Take2_string.txt")

tamGenetics_dilutionsPCR2_p1Take2_string

sink()

# csv file
write.csv(tamGenetics_dilutionsPCR2_p1Take2, "./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p1Take2.csv", row.names = F)
```

#### Plate 2

##### Steps

Ditching the higher dispense height for water; robot hangs onto the last few ul even with a blowout so opting for it to dispense at bottom of well

```{r}
# step 1: pcr1 to dilution plate
tamGenetics_dPCR2_pcr1.dilutionPlate_p2 <- data.frame(
  ot2set = "set1_pcr1.dilutionPlate",
  reagent = "pcr1Plate2",
  source_labware = basePlate,
  source_slot = 2,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 0.25,
  dest_labware = nestPlate,
  dest_slot = 5,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 2
)

# step 2: water to dilution plate
tamGenetics_dPCR2_water.dilutionPlate_p2 <- data.frame(
  ot2set = "set2_water.dilutionPlate",
  reagent = "nf-water",
  source_labware = reservoir_12well,
  source_slot = 7,
  source_well = "A1",
  asp_height = 1,
  dest_labware = nestPlate,
  dest_slot = 5,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 18
)

# step 3: dilutions to pcr2 plate
tamGenetics_dPCR2_dilutionPlate.pcr2_p2 <- data.frame(
  ot2set = "set3_dilutionPlate.pcr2",
  reagent = "dilutionPlate",
  source_labware = nestPlate,
  source_slot = 5,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 6
)

# step 4: index primers to pcr2 plate
tamGenetics_dPCR2_indexes.pcr2_p2 <- data.frame(
  ot2set = "set4_indexes.pcr2",
  reagent = "indexPlate_setB",
  source_labware = nestPlate,
  source_slot = 11,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 3,
  dest_labware = basePlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 4
)

# step 5: kapa to pcr2 plate
tamGenetics_dPCR2_kapa.pcr2_p2 <- data.frame(
  ot2set = "set5_kapa.pcr2",
  reagent = "kapa",
  source_labware = reservoir_12well,
  source_slot = 7,
  source_well = "A4",
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 10
)
```

##### OT2 transfer info

```{r}
tamGenetics_dilutionsPCR2_p2 <- rbind(
  tamGenetics_dPCR2_pcr1.dilutionPlate_p2,
  tamGenetics_dPCR2_water.dilutionPlate_p2,
  tamGenetics_dPCR2_dilutionPlate.pcr2_p2,
  tamGenetics_dPCR2_indexes.pcr2_p2,
  tamGenetics_dPCR2_kapa.pcr2_p2
) %>%
  select("ot2set", "reagent", "source_labware", "source_slot", "source_well", "asp_height", "dest_labware", "dest_slot", "dest_well", "disp_height", "transfer_volume")
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_dilutionsPCR2_p2_string <- format_delim(tamGenetics_dilutionsPCR2_p2,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p2_string.txt")

tamGenetics_dilutionsPCR2_p2_string

sink()

# csv file
write.csv(tamGenetics_dilutionsPCR2_p2, "./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p2.csv", row.names = F)
```

#### Plate 3a/b

##### Steps

NOTE that since the water transfer step will require two OT2 transfers (due to higher volume), I'm using a plate with water to avoid contamination

```{r}
# step 1: pcr1 a to dilution plate
tamGenetics_dPCR2_pcr1.dilutionPlate_p3a <- tamGenetics_dPCR2_pcr1.dilutionPlate_p1 %>%
  mutate(
    ot2set = "set1_pcr1a.dilutionPlate",
    reagent = "pcr1Plate3a",
    asp_height = 0.25,
    disp_height = 0.5
    )

# step 2: pcr1 b to dilution plate
tamGenetics_dPCR2_pcr1.dilutionPlate_p3b <- tamGenetics_dPCR2_pcr1.dilutionPlate_p3a %>%
  mutate(
    ot2set = "set2_pcr1b.dilutionPlate",
    reagent = "pcr1Plate3b",
    source_slot = 3,
    asp_height = 0.25,
    disp_height = 0.5
    )

# step 3: water to dilution plate
tamGenetics_dPCR2_water.dilutionPlate_p3ab <- tamGenetics_dPCR2_water.dilutionPlate_p1 %>%
  mutate(
  ot2set = "set3_water.dilutionPlate",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = grep("A", wellValues_plate, value = T),
  transfer_volume = 36
  )

# step 4: dilutions to pcr2 plate
tamGenetics_dPCR2_dilutionPlate.pcr2_p3ab <- tamGenetics_dPCR2_dilutionPlate.pcr2_p1 %>%
  mutate(
    ot2set = "set4_dilutionPlate.pcr2",
)

# step 5: index primers to pcr2 plate
tamGenetics_dPCR2_indexes.pcr2_p3ab <- tamGenetics_dPCR2_indexes.pcr2_p1 %>%
  mutate(
    ot2set = "set5_indexes.pcr2",
    reagent = "indexPlate_setC"
    )

# step 6: kapa to pcr2 plate
tamGenetics_dPCR2_kapa.pcr2_p3ab <- tamGenetics_dPCR2_kapa.pcr2_p1 %>%
  mutate(
  ot2set = "set6_kapa.pcr2",
  source_well = "A1"
  )
```

##### OT2 transfer info

```{r}
tamGenetics_dilutionsPCR2_p3ab <- rbind(
  tamGenetics_dPCR2_pcr1.dilutionPlate_p3a,
  tamGenetics_dPCR2_pcr1.dilutionPlate_p3b,
  tamGenetics_dPCR2_water.dilutionPlate_p3ab,
  tamGenetics_dPCR2_dilutionPlate.pcr2_p3ab,
  tamGenetics_dPCR2_indexes.pcr2_p3ab,
  tamGenetics_dPCR2_kapa.pcr2_p3ab
) %>%
  select("ot2set", "reagent", "source_labware", "source_slot", "source_well", "asp_height", "dest_labware", "dest_slot", "dest_well", "disp_height", "transfer_volume")
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_dilutionsPCR2_p3ab_string <- format_delim(tamGenetics_dilutionsPCR2_p3ab,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p3ab_string.txt")

tamGenetics_dilutionsPCR2_p3ab_string

sink()

# csv file
write.csv(tamGenetics_dilutionsPCR2_p3ab, "./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p3ab.csv", row.names = F)
```

ADJUSTED

```{r}
tamGenetics_dilutionsPCR2_p3ab_waterAdjust <- rbind(
  tamGenetics_dPCR2_water.dilutionPlate_p3ab,
  tamGenetics_dPCR2_dilutionPlate.pcr2_p3ab,
  tamGenetics_dPCR2_indexes.pcr2_p3ab,
  tamGenetics_dPCR2_kapa.pcr2_p3ab
) %>%
  mutate(id = row_number()) %>%
  filter(id != 1) %>%
  select("ot2set", "reagent", "source_labware", "source_slot", "source_well", "asp_height", "dest_labware", "dest_slot", "dest_well", "disp_height", "transfer_volume")
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_dilutionsPCR2_p3ab_waterAdjust_string <- format_delim(tamGenetics_dilutionsPCR2_p3ab_waterAdjust,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p3ab_waterAdjust_string.txt")

tamGenetics_dilutionsPCR2_p3ab_waterAdjust_string

sink()

# csv file
write.csv(tamGenetics_dilutionsPCR2_p3ab_waterAdjust, "./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p3ab_waterAdjust.csv", row.names = F)
```

#### Plate 4a/b

##### Steps

Transfering 8 ul water vs. 10 ul - spot-checked some wells and they ranged from 7-9ul in actual volume (vs. the 10 ul they were supposed to be at)

```{r}
# step 1: 8 ul water to pcr1 a >>
# PYTHON SCRIPT: 4 ul pcr1 a to dilution plate > 4 ul dilution to pcr2 plate
tamGenetics_dPCR2_pcr1a.dilutionPlate <- data.frame(
  ot2set = "set1_water.pcr1a.dilutionPlate",
  reagent = "water.pcr1a.dilution",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 2,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 8
)

# step 2: 8 ul water to pcr1 b >>
# PYTHON SCRIPT: 4 ul pcr1 b to dilution plate > 4 ul dilution to pcr2 plate > 32 ul water to dilution plate > 6 ul dilution to pcr2 plate
tamGenetics_dPCR2_pcr1b.dilutionPlate <- data.frame(
  ot2set = "set2_water.pcr1b.dilutionPlate.pcr2",
  reagent = "water.pcr1b.dilution",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 3,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 8
)

# step 3: index primers to pcr2 plate
tamGenetics_dPCR2_indexes.pcr2 <- tamGenetics_dPCR2_indexes.pcr2_p1 %>%
  mutate(
    ot2set = "set3_indexes.pcr2",
    reagent = "indexPlate_setD"
    )

# step 4: kapa to pcr2 plate
tamGenetics_dPCR2_kapa.pcr2 <- tamGenetics_dPCR2_kapa.pcr2_p1 %>%
  mutate(
  ot2set = "set4_kapa.pcr2",
  source_well = "A1"
  )
```

##### OT2 transfer info

```{r}
tamGenetics_dilutionsPCR2_p4ab <- rbind(
  tamGenetics_dPCR2_pcr1a.dilutionPlate,
  tamGenetics_dPCR2_pcr1b.dilutionPlate,
  tamGenetics_dPCR2_indexes.pcr2,
  tamGenetics_dPCR2_kapa.pcr2
) %>%
  select("ot2set", "reagent", "source_labware", "source_slot", "source_well", "asp_height", "dest_labware", "dest_slot", "dest_well", "disp_height", "transfer_volume")
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_dilutionsPCR2_p4ab_string <- format_delim(tamGenetics_dilutionsPCR2_p4ab,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p4ab_string.txt")

tamGenetics_dilutionsPCR2_p4ab_string

sink()

# csv file
write.csv(tamGenetics_dilutionsPCR2_p4ab, "./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p4ab.csv", row.names = F)
```

#### Plate 5a/b + Strip 1

##### Steps

Transfering 8 ul water vs. 10 ul - spot-checked some wells and they ranged from 7-9ul in actual volume (vs. the 10 ul they were supposed to be at)

```{r}
# step 1: 8 ul water to pcr1 a >>
# PYTHON SCRIPT: 4 ul pcr1 a to dilution plate > 4 ul dilution to pcr2 plate
tamGenetics_dPCR2_pcr1a.dilutionPlate_p5ab.s1 <- data.frame(
  ot2set = "set1_water.pcr1a.dilutionPlate",
  reagent = "water.pcr1a.dilution",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 2,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 8
) %>%
  filter(!source_well %in% c("A8", "A9", "A10", "A11", "A12"))

# step 2: 8 ul water to pcr1 b >>
# PYTHON SCRIPT: 4 ul pcr1 b to dilution plate > 4 ul dilution to pcr2 plate > 32 ul water to dilution plate > 6 ul dilution to pcr2 plate
tamGenetics_dPCR2_pcr1b.dilutionPlate_p5ab.s1 <- data.frame(
  ot2set = "set2_water.pcr1b.dilutionPlate.pcr2",
  reagent = "water.pcr1b.dilution",
  source_labware = nestPlate,
  source_slot = 6,
  source_well = grep("A", wellValues_plate, value = T),
  asp_height = 1,
  dest_labware = basePlate,
  dest_slot = 3,
  dest_well = grep("A", wellValues_plate, value = T),
  disp_height = 1,
  transfer_volume = 8
) %>%
  filter(!source_well %in% c("A8", "A9", "A10", "A11", "A12"))

# step 3: index primers to pcr2 plate
tamGenetics_dPCR2_indexes.pcr2_p5ab.s1 <- tamGenetics_dPCR2_indexes.pcr2_p1 %>%
  mutate(
    ot2set = "set3_indexes.pcr2",
    reagent = "indexPlate_setE"
    ) %>%
  filter(!source_well %in% c("A8", "A9", "A10", "A11", "A12"))

# step 4: kapa to pcr2 plate
tamGenetics_dPCR2_kapa.pcr2_p5ab.s1 <- tamGenetics_dPCR2_kapa.pcr2_p1 %>%
  mutate(
  ot2set = "set4_kapa.pcr2",
  source_labware = basePlate,
  source_well = "A1"
  ) %>%
  filter(!source_well %in% c("A8", "A9", "A10", "A11", "A12"))
```

##### OT2 transfer info

```{r}
tamGenetics_dilutionsPCR2_p5ab.s1 <- rbind(
  tamGenetics_dPCR2_pcr1a.dilutionPlate_p5ab.s1,
  tamGenetics_dPCR2_pcr1b.dilutionPlate_p5ab.s1,
  tamGenetics_dPCR2_indexes.pcr2_p5ab.s1,
  tamGenetics_dPCR2_kapa.pcr2_p5ab.s1
) %>%
  select("ot2set", "reagent", "source_labware", "source_slot", "source_well", "asp_height", "dest_labware", "dest_slot", "dest_well", "disp_height", "transfer_volume")
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_dilutionsPCR2_p5ab.s1_string <- format_delim(tamGenetics_dilutionsPCR2_p5ab.s1,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p5ab,s1_string.txt")

tamGenetics_dilutionsPCR2_p5ab.s1_string

sink()

# csv file
write.csv(tamGenetics_dilutionsPCR2_p5ab.s1, "./robotProtocols/inputFiles/tamGenetics_dilutionsPCR2_p5ab,s1.csv", row.names = F)
```

## 5.4 Normalization & pooling

### 5.4.1 Picogreen results

```{r}
picoResults_all <- read.csv("./picogreen/16Aug2023_pcr2_tamRun5.p12345_30x3.p1.csv", fileEncoding = "UTF-16LE")
```

### 5.4.2 Excluded samples

The samples below were not added to the PCR1 plates (no xtn volume remaining), and should thus be excluded from normalization calculations and pooling:

```{r}
tamGenetics_samplesToExclude <- data.frame(
  plate = c("p3", "p3", "p5"),
  well = c("F6", "B12", "C1")
) %>%
  mutate(pcr2ID = str_c(plate, ".", well))

bfh_samplesToExclude <- data.frame(
  plate = c("p1"),
  well = c("B7")
) %>%
  mutate(pcr2ID = str_c(plate, ".", well))
```

### 5.4.3 tamGenetics

ADD SKIPPED SAMPLES? OR JUST REMOVE PIPETTE TIPS?

#### sample_ng.ul overview

```{r}
tamGenetics_picoResults <- picoResults_all %>%
  filter(str_detect(Sample, "tamGenetics"))

ggplot(picoResults_tamGenetics, aes(Result)) +
  geom_histogram(color = 4, fill = "white", bins = 100) +
  scale_x_continuous(breaks = round(seq(min(picoResults_tamGenetics$Result), max(picoResults_tamGenetics$Result), by = 1),1))
```

#### Steps

Outline initial transfer steps here; do the rest in python

```{r}
norm_ng.ul <- 10
sampleVol <- 7

tamGenetics_normPool_generalInfo <- picoResults_all %>%
  filter(str_detect(Sample, "tamGenetics")) %>%
  dplyr::rename("reagent" = "Sample",
         "well" = "Wells",
         "sample_ng.ul" = "MeanResult") %>%
  mutate(
    pcr2ID = case_when(
      str_detect(reagent, "p1") ~ str_c("p1.", well),
      str_detect(reagent, "p2") ~ str_c("p2.", well),
      str_detect(reagent, "p3") ~ str_c("p3.", well),
      str_detect(reagent, "p4") ~ str_c("p4.", well),
      str_detect(reagent, "p5") ~ str_c("p5.", well),
    ),
    sampleType = case_when(
      well %in% c("C4", "F9") ~ "negative",
      pcr2ID %in% tamGenetics_samplesToExclude$pcr2ID ~ "EXCLUDE",
      .default = NA
    ),
    waterVol = case_when(
      pcr2ID %in% tamGenetics_samplesToExclude$pcr2ID ~ 0,
      sample_ng.ul < 10 ~ 0,
      .default = round(((as.numeric(sample_ng.ul)*sampleVol)/norm_ng.ul)-sampleVol, 1)
      ),
    waterVol = case_when(
      waterVol < 2 ~ 0, 
      .default = waterVol
    ),
    waterSum = cumsum(waterVol)
  ) %>%
  select(c("reagent", "sampleType", "well", "sample_ng.ul", "waterVol", "waterSum"))

tamGenetics_normPool_water.normPlate <- tamGenetics_normPool_generalInfo %>%
  mutate(
    ot2set = "set1_water.normPlate",
    source_labware = tuberack,
    source_slot = 6,
    source_well = case_when(
      waterSum < 1400 ~ "A1",
      waterSum < 1400*2 ~ "B1",
      waterSum < 1400*3 ~ "C1",
      waterSum < 1400*4 ~ "D1",
      waterSum < 1400*5 ~ "A2",
      waterSum < 1400*6 ~ "B2",
      waterSum < 1400*7 ~ "C2",
      waterSum < 1400*8 ~ "D2",
      waterSum < 1400*9 ~ "A3",
      waterSum < 1400*10 ~ "B3",
      waterSum < 1400*11 ~ "C3",
      waterSum < 1400*12 ~ "D3",
      waterSum < 1400*13 ~ "A4",
      waterSum < 1400*14 ~ "B4",
      waterSum < 1400*15 ~ "C4",
      waterSum < 1400*16 ~ "D4",
      waterSum < 1400*17 ~ "A5",
      waterSum < 1400*18 ~ "B5",
      waterSum < 1400*19 ~ "C5",
      waterSum < 1400*20 ~ "D5",
      waterSum < 1400*21 ~ "A6",
      waterSum < 1400*22 ~ "B6",
      waterSum < 1400*23 ~ "C6",
      waterSum < 1400*24 ~ "D6"
    ),
    dest_labware = nestPlate,
    dest_slot = case_when(
      str_detect(reagent, "p1") ~ 4,
      str_detect(reagent, "p2") ~ 7,
      str_detect(reagent, "p3") ~ 2,
      str_detect(reagent, "p4") ~ 5,
      str_detect(reagent, "p5") ~ 8,
    ),
    dest_well = well,
    transfer_volume = waterVol
    ) %>%
  select(c("ot2set", "reagent", "source_labware", "source_slot", "source_well", "dest_labware", "dest_slot", "dest_well", "transfer_volume"))

tamGenetics_normPool_sample.normPlate_p1 <- data.frame(
  ot2set = "set2_sample.normPlate_p1",
  reagent = "pcr2Plate1",
  source_labware = nestPlate,
  source_slot = 1,
  source_well = grep("A", wellValues_plate, value = T),
  dest_labware = nestPlate,
  dest_slot = 4,
  dest_well = grep("A", wellValues_plate, value = T),
  transfer_volume = sampleVol
)

tamGenetics_normPool_sample.normPlate_p2 <- data.frame(
  ot2set = "set3_sample.normPlate_p2",
  reagent = "pcr2Plate2",
  source_labware = nestPlate,
  source_slot = 1,
  source_well = grep("A", wellValues_plate, value = T),
  dest_labware = nestPlate,
  dest_slot = 7,
  dest_well = grep("A", wellValues_plate, value = T),
  transfer_volume = sampleVol
)

tamGenetics_normPool_sample.normPlate_p3 <- data.frame(
  ot2set = "set4_sample.normPlate_p3",
  reagent = "pcr2Plate3",
  source_labware = nestPlate,
  source_slot = 1,
  source_well = grep("A", wellValues_plate, value = T),
  dest_labware = nestPlate,
  dest_slot = 2,
  dest_well = grep("A", wellValues_plate, value = T),
  transfer_volume = sampleVol
)

tamGenetics_normPool_sample.normPlate_p4 <- data.frame(
  ot2set = "set5_sample.normPlate_p4",
  reagent = "pcr2Plate4",
  source_labware = nestPlate,
  source_slot = 1,
  source_well = grep("A", wellValues_plate, value = T),
  dest_labware = nestPlate,
  dest_slot = 5,
  dest_well = grep("A", wellValues_plate, value = T),
  transfer_volume = sampleVol
)

tamGenetics_normPool_sample.normPlate_p5 <- data.frame(
  ot2set = "set6_sample.normPlate_p5",
  reagent = "pcr2Plate5",
  source_labware = nestPlate,
  source_slot = 1,
  source_well = grep("A", wellValues_plate, value = T),
  dest_labware = nestPlate,
  dest_slot = 8,
  dest_well = grep("A", wellValues_plate, value = T),
  transfer_volume = sampleVol
) %>%
  filter(!source_well %in% c("A8", "A9", "A10", "A11", "A12"))
```

#### OT2 transfer 

Transfer info

```{r}
tamGenetics_normPool <- rbind(
  tamGenetics_normPool_water.normPlate,
  tamGenetics_normPool_sample.normPlate_p1,
  tamGenetics_normPool_sample.normPlate_p2,
  tamGenetics_normPool_sample.normPlate_p3,
  tamGenetics_normPool_sample.normPlate_p4,
  tamGenetics_normPool_sample.normPlate_p5
)
```

Export

```{r}
# comma-separated string with end-of-line delimiter
tamGenetics_normPool_string <- format_delim(tamGenetics_normPool,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/tamGenetics_normPool_string.txt")

tamGenetics_normPool_string

sink()

# csv file
write.csv(tamGenetics_normPool, "./robotProtocols/inputFiles/tamGenetics_normPool.csv", row.names = F)
```

### 5.4.2 30x3

#### Steps

Outline initial transfer steps here; do the rest in python

```{r}
norm_ng.ul <- 10
sampleVol <- 7

bfh_normPool_generalInfo <- picoResults_all %>%
  filter(str_detect(Sample, "30x3")) %>%
  dplyr::rename("reagent" = "Sample",
         "well" = "Wells",
         "sample_ng.ul" = "MeanResult") %>%
  mutate(
    pcr2ID = str_c("p1.", well),
    sampleType = case_when(
      well %in% c("C4", "F9") ~ "negative",
      pcr2ID %in% bfh_samplesToExclude$pcr2ID ~ "EXCLUDE",
      .default = NA
    ),
    waterVol = case_when(
      pcr2ID %in% bfh_samplesToExclude$pcr2ID ~ 0,
      sample_ng.ul < 10 ~ 0,
      .default = round(((as.numeric(sample_ng.ul)*sampleVol)/norm_ng.ul)-sampleVol, 1)
      ),
    waterVol = case_when(
      waterVol < 2 ~ 0, 
      .default = waterVol
    ),
    waterSum = cumsum(waterVol)
  ) %>%
  select(c("reagent", "sampleType", "well", "sample_ng.ul", "waterVol", "waterSum"))

bfh_normPool_water.normPlate <- bfh_normPool_generalInfo %>%
  mutate(
    ot2set = "set1_water.normPlate",
    source_labware = tuberack,
    source_slot = 6,
    source_well = case_when(
      waterSum < 1400 ~ "A1",
      waterSum < 1400*2 ~ "B1",
      waterSum < 1400*3 ~ "C1",
      waterSum < 1400*4 ~ "D1",
      waterSum < 1400*5 ~ "A2",
      waterSum < 1400*6 ~ "B2",
      waterSum < 1400*7 ~ "C2",
      waterSum < 1400*8 ~ "D2",
      waterSum < 1400*9 ~ "A3",
      waterSum < 1400*10 ~ "B3",
      waterSum < 1400*11 ~ "C3",
      waterSum < 1400*12 ~ "D3",
      waterSum < 1400*13 ~ "A4",
      waterSum < 1400*14 ~ "B4",
      waterSum < 1400*15 ~ "C4",
      waterSum < 1400*16 ~ "D4",
      waterSum < 1400*17 ~ "A5",
      waterSum < 1400*18 ~ "B5",
      waterSum < 1400*19 ~ "C5",
      waterSum < 1400*20 ~ "D5",
      waterSum < 1400*21 ~ "A6",
      waterSum < 1400*22 ~ "B6",
      waterSum < 1400*23 ~ "C6",
      waterSum < 1400*24 ~ "D6"
    ),
    dest_labware = nestPlate,
    dest_slot = 2,
    dest_well = well,
    transfer_volume = waterVol
    ) %>%
  select(c("ot2set", "reagent", "source_labware", "source_slot", "source_well", "dest_labware", "dest_slot", "dest_well", "transfer_volume"))

bfh_normPool_sample.normPlate_p1 <- data.frame(
  ot2set = "set2_sample.normPlate_p1",
  reagent = "pcr2Plate1",
  source_labware = nestPlate,
  source_slot = 1,
  source_well = grep("A", wellValues_plate, value = T),
  dest_labware = nestPlate,
  dest_slot = 2,
  dest_well = grep("A", wellValues_plate, value = T),
  transfer_volume = sampleVol
)
```

#### OT2 transfer 

Transfer info

```{r}
bfh_normPool <- rbind(
  bfh_normPool_water.normPlate,
  bfh_normPool_sample.normPlate_p1
)
```

Export

```{r}
# comma-separated string with end-of-line delimiter
bfh_normPool_string <- format_delim(bfh_normPool,
                           delim = ",",
                           eol = "\\n")

sink("./robotProtocols/inputFiles/30x3_normPool_string.txt")

bfh_normPool_string

sink()

# csv file
write.csv(bfh_normPool, "./robotProtocols/inputFiles/30x3_normPool.csv", row.names = F)
```

# SCRAPS

## 5.1 Data

### 5.1.1 Maps & xtns

#### Blood samples

```{r}
# All xtns
xtnMaster_blood <- read.csv("./extractions/tamGenetics_extractionsBlood_master_21July2023.csv")

# Original plate/tube set-up
xtnMap_blood_p1e1 <- xtnMaster_blood %>%
  filter(lysisPlate == 1) %>%
  arrange(lysisCol, lysisRow) %>%
  mutate(sampleType = "blood") %>%
  mutate(xtnLoc = str_c("p", lysisPlate)) %>%
  mutate(well = str_c(lysisRow, lysisCol)) %>%
  mutate(eltn = "e1") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))
  
xtnMap_blood_p1e2 <- xtnMaster_blood %>%
  filter(lysisPlate == 1) %>%
  arrange(lysisCol, lysisRow) %>%
  mutate(sampleType = "blood") %>%
  mutate(xtnLoc = str_c("p", lysisPlate)) %>%
  mutate(well = str_c(lysisRow, lysisCol)) %>%
  mutate(eltn = "e2") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnMap_blood_p2e1 <- xtnMaster_blood %>%
  filter(lysisPlate == 2) %>%
  arrange(lysisCol, lysisRow) %>%
  mutate(sampleType = "blood") %>%
  mutate(xtnLoc = str_c("p", lysisPlate)) %>%
  mutate(well = str_c(lysisRow, lysisCol)) %>%
  mutate(eltn = "e1") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))
  
xtnMap_blood_p2e2 <- xtnMaster_blood %>%
  filter(lysisPlate == 2) %>%
  arrange(lysisCol, lysisRow) %>%
  mutate(sampleType = "blood") %>%
  mutate(xtnLoc = str_c("p", lysisPlate)) %>%
  mutate(well = str_c(lysisRow, lysisCol)) %>%
  mutate(eltn = "e2") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnMap_blood_tubesE1 <- xtnMaster_blood %>%
  filter(str_detect(lysisPlate, "tube")) %>%
  mutate(sampleType = "blood") %>%
  mutate(xtnLoc = str_c("t", sampleTube)) %>%
  mutate(well = NA) %>%
  mutate(eltn = "e1") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnMap_blood_tubesE2 <- xtnMaster_blood %>%
  filter(str_detect(lysisPlate, "tube")) %>%
  mutate(sampleType = "blood") %>%
  mutate(xtnLoc = str_c("t", sampleTube)) %>%
  mutate(well = NA) %>%
  mutate(eltn = "e2") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

# Completed PLATE xtns
xtnPlates_blood_e1 <- xtnMaster_blood %>%
  filter(xtnPlate %in% c(1, 2)) %>%
  arrange(xtnCol, xtnRow) %>%
  mutate(sampleType = "blood") %>%
  mutate(xtnLoc = str_c("p", xtnPlate)) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(eltn = "e1") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnPlates_blood_e2 <- xtnMaster_blood %>%
  filter(xtnPlate %in% c(1, 2)) %>%
  arrange(xtnCol, xtnRow) %>%
  mutate(sampleType = "blood") %>%
  mutate(xtnLoc = str_c("p", xtnPlate)) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(eltn = "e2") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

# Completed TUBE xtns
xtnTubes_blood_e1 <- xtnMaster_blood %>%
  filter(!is.na(xtnTube)) %>%
  mutate(sampleType = "blood") %>%
  mutate(xtnLoc = str_c("t", xtnTube)) %>%
  mutate(well = NA) %>%
  mutate(eltn = "e1") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  mutate(mapID = case_when(
    str_detect(lysisPlate, "tube") ~ reagent,
    .default = str_c("blood_p", lysisPlate, "e1_", lysisRow, lysisCol))) %>%
  select(c("animalID", "sampleType", "mapID", "xtnLoc", "eltn", "well", "reagent"))

xtnTubes_blood_e2 <- xtnMaster_blood %>%
  filter(!is.na(xtnTube)) %>%
  mutate(sampleType = "blood") %>%
  mutate(xtnLoc = str_c("t", xtnTube)) %>%
  mutate(well = NA) %>%
  mutate(eltn = "e2") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  mutate(mapID = case_when(
    str_detect(lysisPlate, "tube") ~ reagent,
    .default = str_c("blood_p", lysisPlate, "e2_", lysisRow, lysisCol))) %>%
  select(c("animalID", "sampleType", "mapID", "xtnLoc", "eltn", "well", "reagent"))
```

#### Fecal samples

```{r}
xtnMaster_fecal <- read.csv("./extractions/tamGenetics_extractionsFecal_master_21July2023.csv")

xtnMap_fecal_tubesE1 <- xtnMaster_fecal %>%
  filter(elution == "E1") %>%
  mutate(sampleType = "fecal") %>%
  mutate(xtnLoc = str_c("t", sampleTube)) %>%
  mutate(well = NA) %>%
  mutate(eltn = tolower(elution)) %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnMap_fecal_tubesE2 <- xtnMaster_fecal %>%
  filter(elution == "E2") %>%
  mutate(sampleType = "fecal") %>%
  mutate(xtnLoc = str_c("t", sampleTube)) %>%
  mutate(well = NA) %>%
  mutate(eltn = tolower(elution)) %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnTubes_fecal_e1 <- xtnMap_fecal_tubesE1 %>%
  mutate(mapID = reagent) %>%
  select(c("animalID", "sampleType", "mapID", "xtnLoc", "eltn", "well", "reagent"))

xtnTubes_fecal_e2 <- xtnMap_fecal_tubesE2 %>%
  mutate(mapID = reagent) %>%
  select(c("animalID", "sampleType", "mapID", "xtnLoc", "eltn", "well", "reagent"))
```

#### Hair samples

```{r}
xtnMaster_hair <- read.csv("./extractions/tamGenetics_extractionsHair_master_21July2023.csv") %>%
  mutate(xtnTube = gsub("\\s+", "", xtnTube))

# Original plate/tube set-up
xtnMap_hair_p3e1 <- xtnMaster_hair %>%
  filter(xtnPlate == 3) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = str_c("p", xtnPlate)) %>%
  mutate(eltn = "e1") %>%
  arrange(xtnCol, xtnRow) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(reagent = str_c("hair_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnMap_hair_p3e2 <- xtnMaster_hair %>%
  filter(xtnPlate == 3) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = str_c("p", xtnPlate)) %>%
  mutate(eltn = "e2") %>%
  arrange(xtnCol, xtnRow) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(reagent = str_c("hair_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnMap_hair_p4e1 <- xtnMaster_hair %>%
  filter(xtnPlate == 4) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = str_c("p", xtnPlate)) %>%
  mutate(eltn = "e1") %>%
  arrange(xtnCol, xtnRow) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(reagent = str_c("hair_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnMap_hair_p4e2 <- xtnMaster_hair %>%
  filter(xtnPlate == 4) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = str_c("p", xtnPlate)) %>%
  mutate(eltn = "e2") %>%
  arrange(xtnCol, xtnRow) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(reagent = str_c("hair_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnMap_hair_tubesE1 <- xtnMaster_hair %>%
  filter(is.na(xtnPlate)) %>%
  filter(elution != "E2") %>%
  filter(!grepl("-", xtnStatus)) %>%
  filter(!is.na(xtnTube)) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = 
           case_when(
             str_detect(xtnTube, "A,B") ~ str_c("tx", gsub("A,B", "A", xtnTube)),
             .default = str_c("t", xtnTube))) %>%
  mutate(eltn = "e1") %>%
  mutate(well = NA) %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnMap_hair_tubesE2 <- xtnMaster_hair %>%
  filter(is.na(xtnPlate)) %>%
  filter(elution != "E2") %>%
  filter(!grepl("-", xtnStatus)) %>%
  filter(!is.na(xtnTube)) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = 
           case_when(
             str_detect(xtnTube, "A,B") ~ str_c("tx", gsub("A,B", "B", xtnTube)),
             .default = str_c("t", xtnTube))) %>%
  mutate(eltn = "e2") %>%
  mutate(well = NA) %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

# Completed PLATE xtns
xtnPlates_hair_p3e1 <- xtnMaster_hair %>%
  filter(xtnPlate == 3) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = str_c("p", xtnPlate)) %>%
  mutate(eltn = "e1") %>%
  arrange(xtnCol, xtnRow) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(reagent = str_c("hair_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnPlates_hair_p3e2 <- xtnMaster_hair %>%
  filter(xtnPlate == 3) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = str_c("p", xtnPlate)) %>%
  mutate(eltn = "e2") %>%
  arrange(xtnCol, xtnRow) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(reagent = str_c("hair_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnPlates_hair_p4e1 <- xtnMaster_hair %>%
  filter(xtnPlate == 4) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = str_c("p", xtnPlate)) %>%
  mutate(eltn = "e1") %>%
  arrange(xtnCol, xtnRow) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(reagent = str_c("hair_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

xtnPlates_hair_p4e2 <- xtnMaster_hair %>%
  filter(xtnPlate == 4) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = str_c("p", xtnPlate)) %>%
  mutate(eltn = "e2") %>%
  arrange(xtnCol, xtnRow) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(reagent = str_c("hair_", xtnLoc, eltn)) %>%
  select(c("animalID", "sampleType", "xtnLoc", "eltn", "well", "reagent"))

# Completed TUBE xtns
xtnTubes_hair_e1 <- xtnMaster_hair %>%
  filter(!is.na(xtnTube)) %>%
  filter(elution != "E2") %>%
  filter(!is.na(xtnTube)) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = 
           case_when(
             str_detect(xtnTube, "A,B") ~ str_c("tx", gsub("A,B", "A", xtnTube)),
             .default = str_c("t", xtnTube))) %>%
  mutate(well = NA) %>%
  mutate(eltn = "e1") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  mutate(mapID =
           case_when(
             grepl("-", xtnStatus) ~ gsub("replacement for plate xtn ", "", xtnStatus),
             str_detect(xtnTube, "A,B") ~ str_c("hair_tx", gsub("A,B", "A", xtnTube, "_e1")),
             .default = str_c("hair_t", xtnTube, eltn))) %>%
  mutate(mapID = 
           case_when(
             grepl("-", mapID) ~ str_c("hair_p", gsub("(.*)-(.*)", "\\1", mapID), "e1_", gsub("(.*)-(.*)", "\\2", mapID)),
             .default = mapID)) %>%
  select(c("animalID", "sampleType", "mapID", "xtnLoc", "eltn", "well", "reagent"))

xtnTubes_hair_e2 <- xtnMaster_hair %>%
  filter(!is.na(xtnTube)) %>%
  filter(elution != "E2") %>%
  filter(!is.na(xtnTube)) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = 
           case_when(
             str_detect(xtnTube, "A,B") ~ str_c("tx", gsub("A,B", "B", xtnTube)),
             .default = str_c("t", xtnTube))) %>%
  mutate(well = NA) %>%
  mutate(eltn = "e2") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  mutate(mapID =
           case_when(
             grepl("-", xtnStatus) ~ gsub("replacement for plate xtn ", "", xtnStatus),
             str_detect(xtnTube, "A,B") ~ str_c("hair_tx", gsub("A,B", "B", xtnTube, "_e2")),
             .default = str_c("hair_t", xtnTube, "_e2"))) %>%
  mutate(mapID = 
           case_when(
             grepl("-", mapID) ~ str_c("hair_p", gsub("(.*)-(.*)", "\\1", mapID), "e2_", gsub("(.*)-(.*)", "\\2", mapID)),
             .default = mapID)) %>%
  select(c("animalID", "sampleType", "mapID", "xtnLoc", "eltn", "well", "reagent"))
```

### 5.1.2 Xtns to SKIP

Extractions known to be OUT or non-functional

#### Xtn records

(blood & fecal master xtn files don't have xtn status)

```{r}
tx9B <- data.frame(sampleType = "hair",
                   xtnLoc = "tx9B",
                   eltn = "e2",
                   well = NA,
                   reagent = "hair_tx9B")

xtnsOut_hairMaster <- xtnMaster_hair %>%
  filter(str_detect(xtnStatus, c("OUT|nonfxnl"))) %>%
  mutate(sampleType = "hair") %>%
  mutate(xtnLoc = 
           case_when(
             is.na(xtnPlate) ~ str_c("tx", gsub("A,B", "A", xtnTube)),
             .default = str_c("p", xtnPlate))) %>%
  mutate(eltn = tolower(elution)) %>%
  mutate(well = str_c(xtnRow, xtnCol)) %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  select(c("sampleType", "xtnLoc", "eltn", "well", "reagent")) %>%
  rbind(., tx9B)
```

#### tamRun3 records

```{r}
# tamRun3 metadata
md_tamRun3 <- read.csv("./03_tamRun3/03_run3GTscore/tamRun3_metadata_5June2023.csv")

t16e2 <- data.frame(sampleType = "hair",
                   xtnLoc = "t16e2",
                   eltn = "e2",
                   well = NA,
                   reagent = "hair_t16e2")

xtnsOut_tamun3 <- md_tamRun3 %>%
  filter(str_detect(pcr1Notes_p12, "OUT")) %>%
  select(c("pcr1Notes_p12", "xtnUsed_p12", "sampleType")) %>%
  mutate(xtnsOut_plate =
           case_when(
             grepl("-", xtnUsed_p12) ~ str_c(sampleType, "_p", str_sub(xtnUsed_p12, 1, 1)),
             .default = str_c(sampleType, "_t", xtnUsed_p12))) %>%
  mutate(xtnsOut_loc = 
           case_when(
             str_detect(pcr1Notes_p12, fixed("e1 is out", ignore_case = T)) ~ str_c(xtnsOut_plate, "_e1"),
             .default = str_c(xtnsOut_plate, "_e2"))) %>%
  mutate(well = 
           case_when(
             grepl("-", xtnUsed_p12) ~ str_sub(xtnUsed_p12, 3, length(xtnUsed_p12)))) %>%
  select(c("xtnsOut_loc", "well")) %>%
  separate(., xtnsOut_loc, into = c("sampleType", "xtnLoc", "eltn")) %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn)) %>%
  rbind(., t16e2)
```

#### On-site xtn checks

```{r}
xtnsOut_onsiteChecks <- matrix(c("sampleType_p#_eltn_well",
                                 "sampleType_t#_eltn_NA"),
                               ncol = 1) %>%
  `colnames<-`(., "xtnsOut") %>%
  as.data.frame() %>%
  separate(., xtnsOut, into = c("sampleType", "xtnLoc", "eltn", "well"), sep = "_") %>%
  mutate(reagent = str_c(sampleType, "_", xtnLoc, eltn))
```

#### Full list

```{r}
xtnsOut <- rbind(xtnsOut_hairMaster, xtnsOut_tamun3, xtnsOut_onsiteChecks)

xtnsOut_platesE1 <- xtnsOut %>%
  filter(grepl("p", xtnLoc)) %>%
  filter(eltn == "e1")

xtnsOut_platesE2 <- xtnsOut %>%
  filter(grepl("p", xtnLoc)) %>%
  filter(eltn == "e2")

xtnsOut_tubesE1 <- xtnsOut %>%
  filter(grepl("t", xtnLoc)) %>%
  filter(!grepl("tamTiger", xtnLoc)) %>%
  filter(eltn == "e1")

xtnsOut_tubesE2 <- xtnsOut %>%
  filter(grepl("t", xtnLoc)) %>%
  filter(!grepl("tamTiger", xtnLoc)) %>%
  filter(eltn == "e2")
```

```{r}
xtnList_blood_e1 <- xtnMaster_blood %>%
  mutate(sampleType =
           "blood") %>%
  mutate(animalID =
           case_when(animalID == "BLANK" ~ str_c("neg_", xtnPlate, xtnRow, xtnCol, "_e1"),
                              .default = animalID)) %>%
  mutate(origLocID =
           case_when(
             !str_detect(lysisPlate, "tube") ~ str_c("p", lysisPlate, "_", lysisRow, lysisCol),
             str_detect(lysisPlate, "tube") ~ str_c("t", xtnTube, "_blood_e1"))) %>%
  mutate(origLoc =
           case_when(
             grepl("t", origLocID) ~ "tube",
             .default = "plate")) %>%
  mutate(xtn =
           case_when(
             is.na(xtnTube) ~ str_c("p", xtnPlate, "_", xtnRow, xtnCol, "_e1"),
             .default = str_c("t", xtnTube, "_blood_e1"))) %>%
  mutate(xtnType =
           case_when(grepl("t", xtn) ~ "tube",
                     .default = "plate")) %>%
  select(c("animalID", "sampleType", "origLoc", "origLocID", "xtnType", "xtn"))

xtnList_blood_e2 <- xtnList_blood_e1 %>%
  mutate(origLocID = gsub("e1", "e2", origLocID)) %>%
  mutate(xtn = gsub("e1", "e2", xtn))

xtnList_blood <- rbind(xtnList_blood_e1, xtnList_blood_e2)

# Fecal xtns


# Hair xtns
xtnMaster_hair <- read.csv("./extractions/tamGenetics_extractionsHair_master_21July2023.csv")

xtnList_hair_e1 <- xtnMaster_hair %>%
  filter(!if_all(c(xtnTube, xtnPlate), is.na)) %>%
  mutate(animalID =
           case_when(
             animalID == "BLANK" ~ str_c("neg_", xtnPlate, xtnRow, xtnCol, "_e1"),
             .default = animalID)) %>%
  mutate(sampleType =
           "hair") %>%
  mutate(origLocID =
           case_when(
             grepl("-", xtnStatus) ~ gsub("replacement for plate xtn ", "", xtnStatus),
             is.na(xtnPlate) ~ str_c("t", xtnTube, "_hair_", tolower(elution)),
             .default = str_c("p", xtnPlate, "_", xtnRow, xtnCol, "_", tolower(elution)))) %>%
  mutate(origLocID = 
           case_when(
             grepl("-", origLocID) ~ str_c("p", gsub("-", "_", origLocID), "_", tolower(elution)),
             .default = origLocID)) %>%
  mutate(origLoc = 
           case_when(
             grepl("tamTiger", origLocID) ~ "plate",
             grepl("t", origLocID) ~ "tube",
             .default = "plate")) %>%
  mutate(xtn =
           case_when(
             is.na(xtnTube) ~ str_c("p", xtnPlate, "_", xtnRow, xtnCol, "_", tolower(elution)),
             .default = str_c("t", xtnTube, "_hair_", tolower(elution)))) %>%
  mutate(xtnType =
           case_when(
             grepl("tamTiger", xtn) ~ "plate",
             grepl("t", xtn) ~ "tube",
             .default = "plate")) %>%
  select(c("animalID", "sampleType", "origLoc", "origLocID", "xtnType", "xtn"))

xtnList_hair_e2 <- xtnList_hair_e1 %>%
  mutate(origLocID = gsub("e1", "e2", origLocID)) %>%
  mutate(xtn = gsub("e1", "e2", xtn))

xtnList_hair <- rbind(xtnList_hair_e1, xtnList_hair_e2)

# Full xtn list
xtnList_all <- rbind(xtnList_blood, xtnList_fecal, xtnList_hair)
```

