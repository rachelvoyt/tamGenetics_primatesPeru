---
title: "tamGenetics_paper3_demographics_dataCleaning"
author: "Rachel Voyt"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1 Overview

This document is a record of all the steps involved in cleaning the
saddleback and emperor tamarin demography data from 2009 to 2023.

Data sources used to assemble the demography dataset include:

-   Excel sheets provided by Mini & Gideon listing individuals captured
    from 2009-2019 & 2021-2023
-   Trapping sheets - provides morphometrics and health metrics for
    individuals captured
-   Capture reports - provides additional detail on captures, including
    group size (especially helpful when not all individuals are
    captured)
-   The FPI database - should include the same information as the
    capture sheets and reports, but good to check for consistency

Data cleaning steps include:

1.  Combine and reformat capture records
    1.  Combine excel sheets for 2009-2019 and 2021-2023 individual
        captures and reformat columns to reflect desired variables
    2.  Export as **captureData_2009to2023_v1.csv**
2.  OpenRefine cleaning
    1.  Import captureData_2009to2023_v1.csv to OpenRefine
    2.  Standardize value names (e.g., species names, group names, etc.)
    3.  Export as **captureData_2009to2023_v2.csv**
3.  Finalize captureData_byIndiv to upload to Google Sheets
    1.  Import captureData_2009to2023_v2.csv to R
    2.  Ensure microchips are read as characters & subset capture data
        to include only LWED and SIMP entries
    3.  Export as **captureData_2009to2023_v3.csv**
4.  Google sheets cleaning

# 2 Packages

```{r}
library(data.table)
library(janitor)
library(readxl)
library(tidyverse)
```

# 3 Prep raw data

## 3.1 Reformat & combine raw data

Individual capture data currently exists in two files, one from
2009-2019 and the other from 2021-2023

```{r}
captures_2009.2019_byIndiv <- read.csv("./paper3_demographics/01_dataOrganization/01_dataOriginal/tamarin_captures_2009-2019.csv", na.strings = c("", "NA"))

captures_2021.2023_byIndiv <- read.csv("./paper3_demographics/01_dataOrganization/01_dataOriginal/tamarin_captures_2021-2023.csv", na.strings = c("", "NA"))
```

For the captureData_byIndiv datasheet, we need the following column
names:

```{r}
colNames_captures_byIndiv <- c(
  'reviewedInitials',
  'reviewedDate',
  'captureDate',
  'captureID',
  'species',
  'groupName',
  'groupID',
  'ageClass',
  'sex',
  'animalName',
  'animalID',
  'trappingID',
  'microchip',
  'weightTotal',
  'weightBag',
  'weightAnimal',
  'testesVulva_length',
  'testesVulva_width',
  'spGland_length',
  'spGland_width',
  'nippleR_length',
  'nippleL_length',
  'dentitionState',
  'notes',
  'links'
)
```

Using these column names, we can reformat and combine the 2009-2019 &
2021-2023 capture sheets:

```{r}
# Reformat captures_2009.2019_byIndiv
captures_2009.2019_byIndiv_updated <- data.frame(matrix(ncol = length(colNames_captures_byIndiv), nrow = length(captures_2009.2019_byIndiv$X), dimnames = list(NULL, colNames_captures_byIndiv))) %>%
  mutate(
    reviewedInitials = "",
    reviewedDate = "",
    captureDate = captures_2009.2019_byIndiv$CaptureDate,
    captureID = "",
    species = captures_2009.2019_byIndiv$Species,
    groupName = captures_2009.2019_byIndiv$GroupName,
    groupID = captures_2009.2019_byIndiv$GroupID,
    ageClass = captures_2009.2019_byIndiv$Age_class,
    sex = captures_2009.2019_byIndiv$Sex,
    animalName = captures_2009.2019_byIndiv$AnimalName,
    animalID = captures_2009.2019_byIndiv$AnimalID,
    trappingID = captures_2009.2019_byIndiv$CaptureNo.,
    microchip = captures_2009.2019_byIndiv$Microchip,
    weightTotal = "",
    weightBag = "",
    weightAnimal = "",
    testesVulva_length = "",
    testesVulva_width = "",
    spGland_length = "",
    spGland_width = "",
    nippleR_length = "",
    nippleL_length = "",
    dentitionState = "",
    notes = "",
    links = ""
  ) %>%
  select(all_of(colNames_captures_byIndiv)) %>%
  mutate(originalData = "tamarin_captures_2009-2019.csv")

# Reformat captures_2021.2023_byIndiv
captures_2021.2023_byIndiv_updated <- data.frame(matrix(ncol = length(colNames_captures_byIndiv), nrow = length(captures_2021.2023_byIndiv$ID), dimnames = list(NULL, colNames_captures_byIndiv))) %>%
  mutate(
    reviewedInitials = "",
    reviewedDate = "",
    captureDate = captures_2021.2023_byIndiv$CaptureDate,
    captureID = "",
    species = captures_2021.2023_byIndiv$Species,
    groupName = captures_2021.2023_byIndiv$group,
    groupID = "",
    ageClass = captures_2021.2023_byIndiv$age,
    sex = captures_2021.2023_byIndiv$sex,
    animalName = captures_2021.2023_byIndiv$animal_name,
    animalID = captures_2021.2023_byIndiv$animal_ID,
    trappingID = captures_2021.2023_byIndiv$capture_number,
    microchip = captures_2021.2023_byIndiv$Microchip,
    weightTotal = "",
    weightBag = "",
    weightAnimal = "",
    testesVulva_length = "",
    testesVulva_width = "",
    spGland_length = "",
    spGland_width = "",
    nippleR_length = "",
    nippleL_length = "",
    dentitionState = "",
    notes = "",
    links = ""
  ) %>%
  select(all_of(colNames_captures_byIndiv)) %>%
  mutate(originalData = "tamarin_captures_2020-2023.csv")

# Combined capture records
captures_2009.2023_byIndiv <- rbind(captures_2009.2019_byIndiv_updated, captures_2021.2023_byIndiv_updated)
```

Then export the combined data file for input into OpenRefine for
additional cleaning:

```{r}
write.csv(captures_2009.2023_byIndiv, "./paper3_demographics/01_dataOrganization/02_dataCleaning/captureData_2009to2023_byIndiv_v1.csv", row.names = F)
```

## 3.2 Filter post OpenRefine

I cleaned up a lot of the column entries in OpenRefine, including the
species column -- now that LWED/SIMP entries now have these values (as
opposed to SFUS, Saguinus weddelli, etc.) in the species column, we can
filter to just these entries:

```{r}
captures_2009.2023_v2 <- read.csv("./paper3_demographics/01_dataOrganization/02_dataCleaning/captureData_2009to2023_byIndiv_v2.csv") %>%
  # make sure microchips are read as text vs. numbers
  mutate(
    microchip1 = as.character(microchip1),
    microchip2 = as.character(microchip2),
    microchip3 = as.character(microchip3)
  )

captures_2009.2023_v3 <- captures_2009.2023_v2 %>%
  filter(species %in% c("LWED", "SIMP"))
```

OUTPUT: **captureData_2009to2023_byIndiv_v3.csv**; export for entry into
the tamGenetics_demographics_dataCleaning Google sheet

```{r}
write.csv(captures_2009.2023_v3, "./paper3_demographics/01_dataOrganization/02_dataCleaning/captureData_2009to2023_byIndiv_v3.csv", row.names = F)
```

## 3.3 captureData_byGroup template

Using captures_2009.2023_v3, we can also get a starting point for the
captureData_byGroup sheet on tamGenetics_demographics_dataCleaning:

```{r}
captures_2009.2023_byGroup <- captures_2009.2023_v3 %>%
  select(c("captureDate", "species", "groupName", "groupID")) %>%
  distinct()

write.csv(captures_2009.2023_byGroup, "./paper3_demographics/01_dataOrganization/02_dataCleaning/captureData_2009to2023_byGroup_v1.csv", row.names = F)
```

# 4 Clean data

## 4.1 captureData_byIndiv

### Clean step #1 (COMPLETE)

Input: **captureData_2009to2023_byIndiv_v3.csv** Output: edited on Google sheet
only (no csv file)

Cleaning step 1 was completed by Maddy in Google Sheets, where she did
line-by-line checks of individual capture data against the original
capture reports and trapping sheets.

### Clean step #2 (IN PROGRESS)

Input: Google sheet only (no csv file) Output: after Gideon has finished
going through things, export as
**captureData_2009to2023_byIndiv_v4.csv**

After Maddy finished going through all the data in Google Sheets, I went
through the data again to check for errors/inconsistencies, tagging
Gideon where needed to address anything that I couldn't reconcile.

My own checks include a quick check in R to ensure that each animalID
was consistently assigned the same species and sex, which I did using
the captureData_byIndividual Google Sheet from 8 February 2024 (now
archived).

I found two animalIDs with inconsistent sex assignments (species
assignments were fine though):

Issue #1 - animalID 116 (GBY) has both F & M entries Issue #2 - animalID
234 (YBG3) also has both F & M entries

After reviewing data sheets, both should be M; both are entered
correctly on my original md file. I also updated both on the Google
sheet.

```{r, eval=FALSE}
capData_byIndiv_8Feb2024 <- read.csv("./paper3_demographics/01_dataOrganization/archived/tamGenetics_demographics_dataCleaning_captureData_byIndividual_8Feb2024.csv")

dupTest_spSex_8Feb2024 <- capData_byIndiv_8Feb2024 %>%
  select(c(animalID, species, sex)) %>%
  arrange(animalID) %>%
  distinct() %>%
  group_by(animalID) %>%
  filter(n() > 1) %>%
  summarize(n=n())

# examine animalIDs 116 & 234
dupTest_spSex_8Feb2024_troubleshooting <- capData_byIndiv_8Feb2024 %>%
  filter(animalID %in% c(116, 234))
```

### Clean step #3: Microchips (COMPLETE)

#### Data

##### capData_byIndiv_v4

Use the final cleaned version from Google Sheets - the very final
cleaned copy should be named captureData_2009to2023_byIndiv_v4.csv, but
since Clean step #2 isn't completely finished (Gideon needs to go
through things), just use the latest version available

```{r}
capData_byIndiv_v4 <- read.csv("./paper3_demographics/01_dataOrganization/captureData_byIndividual_20May2024.csv", na.strings = c("", "NA")) %>%
  # create rowID corresponding to google sheet for easy reference
  mutate(rowID = row_number()) %>%
  relocate(rowID) %>%
  # remove entries marked to discard
  filter(discardEntry != "yes") %>%
  # provide non-NA value for entries missing animalID or microchip
  mutate(
    animalID = case_when(
      is.na(as.character(animalID)) ~ "UNK",
      .default = as.character(animalID)
    ),
    microchip1 = case_when(
      is.na(microchip1) ~ "UNK",
      .default = microchip1
    )
  ) %>%
  # sort by animalID, then captureDate
  arrange(animalID, captureDate)
```

##### microchips_capData

Microchips from googleSheet-cleaned captureData_byIndiv - note that
entries missing animalID or microchip have those values replaced by
"unk"

```{r}
microchips_capData_v1 <- capData_byIndiv_v4 %>%
  select(c(rowID, animalID, microchip1, microchip2, microchip3)) %>%
  # replace missing animalID/microchip values with "unk"
  mutate(
    animalID = case_when(
      is.na(as.character(animalID)) ~ "UNK",
      .default = as.character(animalID)
    ),
    microchip1 = case_when(
      is.na(microchip1) ~ "UNK",
      .default = microchip1
      )
  ) %>%
  # make sure microchips are read as text vs. numbers
  mutate(
    microchip1 = as.character(microchip1),
    microchip2 = as.character(microchip2),
    microchip3 = as.character(microchip3)
  ) %>%
  pivot_longer(!c(rowID, animalID),
               names_to = "microchipVersion",
               values_to = "microchip") %>%
#  select(-microchipVersion) %>%
  # remove NAs introduced by pivot
  na.omit() %>%
  # create animalID.microchip combo variable
  mutate(
    animalID.microchip = str_c(animalID, as.character(microchip), sep = "_")
  ) %>%
  relocate(microchipVersion, .after = rowID) %>%
  arrange(rowID)

# old stuff:
#  group_by(animalID.microchip) %>%
#  count() %>%
#  separate(animalID.microchip, into = c("animalID", "microchip"), sep = "_", remove = F) %>%
#  select(c(rowID, animalID, microchip, animalID.microchip, n)) %>%
#  merge(., as.data.frame(table(capData_byIndiv_v4$animalID)), by.x = "animalID", by.y = "Var1") %>%
#  dplyr::rename("n_chip" = "n",
#                "n_captures" = "Freq") %>%
#  arrange(animalID)
```

##### microchips_fpiData

Need to load in full FPI database and subset to tamarins

```{r}
# had to export database as multiple pages; import all & recombine
fpiData_p1 <- read.csv("./paper3_demographics/01_dataOrganization/01_dataOriginal/fpi_animal-list_page1.csv")
fpiData_p2 <- read.csv("./paper3_demographics/01_dataOrganization/01_dataOriginal/fpi_animal-list_page2.csv")
fpiData_p3 <- read.csv("./paper3_demographics/01_dataOrganization/01_dataOriginal/fpi_animal-list_page3.csv")
fpiData_p4 <- read.csv("./paper3_demographics/01_dataOrganization/01_dataOriginal/fpi_animal-list_page4.csv")

fpiData_full <- rbind(fpiData_p1, fpiData_p2, fpiData_p3, fpiData_p4)

# export full list to have on hand
write.csv(fpiData_full, "./paper3_demographics/01_dataOrganization/01_dataOriginal/fpi_animal-list_full.csv", row.names = F)

# subset data
## typo check - have Primate and Primates
table(fpiData_full$order)

## filter to Primates & correct typo
fpiData_primates <- fpiData_full %>%
  filter(order %in% c("Primate", "Primates")) %>%
  mutate(order = "Primates")

## typo check - just Callitrichidae, no typos
table(fpiData_primates$family)

## filter to Callitrichidae
fpiData_tams <- fpiData_primates  %>%
  filter(family == "Callitrichidae")

## typo check - have Leontocebus weddeli, Leontocebus weddelli, and Saguinus imperator
table(fpiData_tams$species)

## filter to lwed & simp & switch species to short-name & add rowID
fpiData_tams2 <- fpiData_tams %>%
  filter(species %in% c("Leontocebus weddeli",
                        "Leontocebus weddelli",
                        "Saguinus imperator")) %>%
  mutate(
    species = case_when(
      species == "Leontocebus weddeli" ~ "LWED",
      species == "Leontocebus weddelli" ~ "LWED",
      species == "Saguinus imperator" ~ "SIMP"
    )
  ) %>%
  arrange(as.numeric(animal_id)) %>%
  mutate(
    rowID = row_number()
  ) %>%
  relocate(rowID)

## select animalID/microchips variables only
microchips_fpiData_v1 <- fpiData_tams2 %>%
  select(rowID, animal_id, microchip_band_tag) %>%
  dplyr::rename("animalID" = "animal_id",
                "microchip" = "microchip_band_tag") %>%
  # replace missing animalID/microchip values with "unk"
  mutate(
    animalID = case_when(
      is.na(as.character(animalID)) ~ "UNK",
      .default = as.character(animalID)
    ),
    microchip = case_when(
      microchip == "NO CHIP" ~ "UNK",
      microchip == "NONE" ~ "UNK",
      microchip == "NULL" ~ "UNK",
      microchip == "UNK?" ~ "UNK",
      .default = microchip
      )
  ) %>%
  # separate any combined microchips
  separate("microchip", c("microchip1", "microchip2", "microchip3"), sep = "/") %>%
  # make sure microchips are read as text vs. numbers
  mutate(
    microchip1 = as.character(microchip1),
    microchip2 = as.character(microchip2),
    microchip3 = as.character(microchip3)
  ) %>%
  pivot_longer(!c(rowID, animalID),
               names_to = "microchipVersion",
               values_to = "microchip") %>%
#  select(-microchipVersion) %>%
  # remove NAs introduced by pivot
  na.omit() %>%
  mutate(
    animalID.microchip = str_c(animalID, as.character(microchip), sep = "_")
  ) %>%
  distinct() %>%
  relocate(microchipVersion, .after = rowID) %>%
  arrange(rowID)
```

##### microchips_masterList_v1

We can combine all of the animalID/microchip data above to create a
master list of all unique animalID/microchip combos found in both
capData and fpiData, with additional columns to note whether the
combination is found in capData, fpiData, or both.

```{r}
microchips_masterList_v1 <- rbind(
  microchips_capData_v1 %>% select(animalID.microchip),
  microchips_fpiData_v1 %>% select(animalID.microchip)
) %>%
  # ensure all letters are uppercase
  mutate(animalID.microchip = toupper(animalID.microchip)) %>%
  # remove duplicates
  distinct() %>%
  # recreate separate animalID & microchip variables
  mutate(
    animalID = str_split_i(animalID.microchip, "_", i = 1),
    microchip = str_split_i(animalID.microchip, "_", i = 2)
  ) %>%
  select(animalID, microchip, animalID.microchip) %>%
  arrange(animalID) %>%
  # note whether combo appears in capData, fpiData, or both
  mutate(
    in_capData = case_when(
      animalID.microchip %in% microchips_capData_v1$animalID.microchip ~ "yes",
      .default = "no"
    ),
    in_fpiData = case_when(
      animalID.microchip %in% microchips_fpiData_v1$animalID.microchip ~ "yes",
      .default = "no"
    ),
    in_both = case_when(
      in_capData == "yes" & in_fpiData == "yes" ~ "yes",
      .default = "no"
    )
  )
```

#### dupChecks

Now that we have a full list of animalIDs/microchips from both capData
and fpiData, the first cleaning step is to check whether any microchips
have been assigned to multiple animalIDs.

##### Identify duplicates

In total, there are 4 microchips that have been assigned to more than
one animalID:

-   **4C31275328** to animalIDs 25 and 98
-   **4C33045515** to animalIDs 63 and 156
-   **7E10234910** to animalIDs 234 and 535
-   **933000320126286** to animalIDs 15 and 32

```{r}
microchips_dupChecks <- microchips_masterList_v1 %>%
  # remove entries w/NA animalID or microchip
  filter(!str_detect(animalID.microchip, "UNK")) %>%
  # check for dupes
  get_dupes(microchip) %>%
  select(animalID, microchip, animalID.microchip) %>%
  merge(., data.frame(table(microchips_capData_v1$animalID.microchip)), by.x = "animalID.microchip", by.y = "Var1", all.x = T) %>%
  dplyr::rename("n_chip" = "Freq") %>%
  merge(., data.frame(table(capData_byIndiv_v4$animalID)), by.x = "animalID", by.y = "Var1", all.x = T) %>%
  dplyr::rename("n_captures" = "Freq") %>%
  arrange(microchip, as.numeric(animalID))

microchips_dupChecks %>%
  distinct(microchip) %>%
  nrow()
```

##### Assess

**MicrochipID 4C31275328: 25, 98**

-   fpiData for animalID 25 says not to use those records and instead
    use those for animalID 98

UPDATES:

-   25_4C31275328 - remove
-   also remove any other entries for animalID 25

```{r}
microchipError_4C31275328_fpiData <- fpiData_microchipPresent %>%
  filter(animal_id %in% c("25", "98"))
```

**Microchip 4C33045515: 63, 156**

-   animalID 63 - listed for for 6/7 captures
-   animalID 156 - listed for 1/5 captures
-   In the Google Sheet, the relevant entry for animalID 156 (rowID 498)
    the microchip for the relevant google sheet entry for animalID 156
    is highlighted yellow; no comments, but I'm going to go ahead and
    assume this was a copy/paste error or some such

UPDATES:

-   156_4C33045515 - remove
-   156_0A02356657 - add

```{r}
microchipError_4C33045515_capData <- capData_byIndiv_v4 %>%
  filter(animalID %in% c("63", "156"))
```

**Microchip 7E10234910: 234, 535**

-   animalID 234 - listed for 2/2 captures
-   animalID 535 - listed for 1/2 captures

Oof complicated. Same group (Illest), same species (LWED)... is this the
same individual?? 234 = YBG3 535 = YBG3, YBG4

OKAY - after looking at all of the trapping sheets and reports for 234
and 535, I've determined that this is the SAME individual. Part of the
issue likely has to do with the 2021 capture, where they had a microchip
reader issue and ended up inserting outdated microchips. This individual
received the following microchips in the following years:

-   2018 (234) - 7E10234910 (trapping sheet missing, but listed as an
    old microchip in trapping sheets from more recent years)
-   2019 (535) - 933000320126306
-   2021 (535) - 0A02357926
-   2023 (234) - 933000320617489

**note** that the fpi data for LWED YBG individuals doesn't seem to be
correct for this individual? Lists animalID 535 as "unknown Illest adult
first captured in 2019" w/microchips "0a02357926/933000320126306"

UPDATES:

-   in capData, append "animalID 234 & 535 are the SAME indiv - changed
    animalID here from 535 to 234" to notes_RV
-   then change animalID 535 to 234 - note that this means this indiv
    has 4 unique microchip IDs total

```{r}
microchipError_7E10234910_capData <- capData_byIndiv_v4 %>%
  filter(animalID %in% c("234", "535"))

fpiData_lwedYBG <- fpiData_tams2 %>%
  filter(species == "LWED") %>%
  filter(str_detect(animal_name, "YBG"))
```

**MicrochipID 933000320126286: 15, 32**

-   animalID 15 = SIMP_F, SRC/SPS, 48585E5774/933000320126286
-   animalID 32 = SIMP_M, RBL, 4903445A51/933000320126286

The fpiData has no notes, no capture dates; each has another microchipID
available, but both still have the common microchip listed as well.

From the Google sheet captureData_byIndividual records, I have the
following notes for animalID 15/rowID 594: "the '..26286' belongs to the
individual in the row just above this one; current individual's trapping
sheet lists"new" microchip '..26274' and "new new" microchip '..26285' -
there's no trapping report or other further info available in the folder
(w/o going through the mp3)"

Looking at the individual capture records, 933000320126286 is only
associated with RBL (animalID 32); trapping reports further support,
stating that RBL was given this new microchip on 29 June 2019. As such,
I'm going to move forward with the assumption that it belongs only to
animalID 32, and NOT to animalID 15.

I'm still not entirely sure if 93300032012628***5*** is a legit
microchip for animalID 15, but am fairly certain that
93300032012628***6*** is **not**. As such, I'm going to swap the 6 to a
5 for animalID 15 and go from there.

UPDATES:

-   change 15_933000320126286 - remove
-   15_933000320126285 - add

```{r}
microchipError_933000320126286_fpiData <- fpiData_microchipPresent %>%
  filter(animal_id %in% c("15", "32"))

microchipError_933000320126286_capData <- microchips_capData %>%
  filter(animalID %in% c("15", "32"))

microchipError_933000320126286_capData <- capData_byIndiv_v4 %>%
  filter(microchip1 == "933000320126286")
```

##### Update: microchips_runningUpdates_v1

Create dataframe to track updates to original microchips_masterList_v1

UPDATES:

-   Remove all entries for animalID 25
-   15_933000320126286 - remove
-   156_4C33045515 - remove
-   535_7E10234910 - remove
-   Change all entries for animalID 234 to animalID 535
-   Add to notes: "fpiData said to discard entries for animalID 25"
-   Add to notes: "animalID 234 & 535 are the SAME indiv - changed all
    to animalID 234"

```{r}
microchips_runningUpdates_v1 <- microchips_masterList_v1 %>%
  mutate(
    action = 
      case_when(
        as.character(animalID) == "25" ~ "remove",
        animalID.microchip == "156_4C33045515" ~ "remove",
        # remove the animalID 535 entry that results in a 234 duplicate
        animalID.microchip == "535_7E10234910" ~ "remove",
        # update all other animalID 535 entries to 234
        as.character(animalID) == "535" ~ "update_535to234",
        animalID.microchip == "15_933000320126286" ~ "remove",
        .default = "keep"
      ),
    notes = 
      case_when(
        as.character(animalID) == "25" ~ "fpiData said to discard entries for animalID 25 and instead use those for animalID 98",
        animalID.microchip == "156_4C33045515" ~ "Listed microchip belongs to animalID 63; microchip listed for 6/7 animalID 63 captures vs. 1/5 animalID 156 captures",
        animalID.microchip == "15_933000320126286" ~ "Listed microchip belongs to animalID 32; records suggest it's a typo and should end in *285",
        as.character(animalID) == "234" ~ "animalID 234 & 535 are the SAME indiv - this entry was originally listed as 234 (no changes needed)",
        as.character(animalID) == "535" & action == "remove" ~ "animalID 234 & 535 are the SAME indiv - this entry was originally listed as 535 (changed to 234, then marked to remove b/c created duplicate entry)",
        as.character(animalID) == "535" ~ "animalID 234 & 535 are the SAME indiv - this entry was originally listed as 535 (changed to 234)",
        .default = NA
      )
  ) %>%
  arrange(as.numeric(animalID))
```

##### Update: microchips_capData_v2

```{r}
microchips_capData_v2 <- microchips_capData_v1 %>%
  merge(., microchips_runningUpdates_v1[, c("animalID.microchip", "action", "notes")], by = "animalID.microchip", all.x = T) %>%
  mutate(
    animalID = case_when(
      as.character(animalID) == "535" ~ "234",
      .default = as.character(animalID)
    ),
    microchip = case_when(
      as.character(animalID) != "234" & action == "remove" ~ "UNK",
      .default = microchip
    ),
    notes = case_when(
      action == "remove" & as.character(animalID) == "156" ~ "Microchip originally listed (4C33045515) belongs to animalID 63; need to update",
      action == "remove" & as.character(animalID) == "234" ~ "animalID 234 & 535 are the SAME indiv - this entry was originally listed as 535 (changed to 234)",
      .default = notes
    )
  ) %>%
  mutate(
    animalID.microchip = str_c(animalID, "_", microchip)
  ) %>%
  select(rowID, microchipVersion, animalID, microchip, animalID.microchip, action, notes) %>%
  arrange(rowID) %>%
  select(-action)
```

##### Update: microchip_masterList_v2

Discard all combos marked to "remove" for a clean list of animalIDs +
associated microchips

```{r}
microchips_masterList_v2 <- microchips_runningUpdates_v1 %>%
  filter(action != "remove") %>%
  mutate(
    animalID = case_when(
      action == "update_535to234" ~ "234",
      .default = animalID
    ),
    animalID.microchip = str_c(animalID, "_", microchip)
  ) %>%
  select(-action)
```

#### Missing data

Now that we've taken care of microchips assigned to more than 1
animalID, we can address entries with a missing animalID and/or
microchip.

##### Assess

From current microchips_masterList_v2, going to create the following
lists: 1) entries with animalID, but no microchip 2) entries with
microchip, but no animalID

```{r}
microchips_missingAnimalIDs <- microchips_masterList_v2 %>%
  filter(as.character(animalID) == "UNK") %>%
  # remove any entries where microchip is also unknown
  filter(microchip != "UNK") %>%
  select(animalID, microchip, animalID.microchip)

microchips_missingMicrochips <- microchips_masterList_v2 %>%
  filter(microchip == "UNK") %>%
  # remove any entries where animalID is also unknown
  filter(as.character(animalID) != "UNK") %>%
  select(animalID, microchip, animalID.microchip)
```

Let's see how many we can fill in -

```{r}
# MISSING ANIMALIDS
## create clean master list w/no missing data
microchips_masterList_v2_clean <- microchips_masterList_v2 %>%
  filter(!str_detect(animalID.microchip, "UNK"))

## find missing animalIDs
microchips_missingAnimalIDs_found <- microchips_missingAnimalIDs %>%
  select(-animalID) %>%
  # match microchips to animalIDs
  merge(., microchips_masterList_v2_clean[, c("animalID", "microchip")], by = "microchip", all.x = T) %>%
  select(animalID, microchip, animalID.microchip) %>%
  na.omit() %>%
  arrange(as.numeric(animalID))

# MISSING MICROCHIPS
## for entries missing microchips, create list w/one microchip per animalID only
microchips_masterList_v2_clean_oneMicrochip <- microchips_masterList_v2_clean %>%
  filter(animalID %in% microchips_missingMicrochips$animalID) %>%
  select(animalID, microchip) %>%
  mutate(
    temp = as.integer(!duplicated(animalID))
  ) %>%
  filter(temp == 1) %>%
  select(-temp)

## find missing microchips
microchips_missingMicrochips_found <- microchips_missingMicrochips %>%
  select(-microchip) %>%
  merge(., microchips_masterList_v2_clean_oneMicrochip, by = "animalID", all.x = T) %>%
  select(animalID, microchip, animalID.microchip) %>%
  arrange(animalID) %>%
  na.omit()
```

What's still missing?

```{r}
# dataframes of entries still missing data
microchips_missingAnimalIDs_v2 <- microchips_missingAnimalIDs %>%
  filter(!animalID.microchip %in% microchips_missingAnimalIDs_found$animalID.microchip)

microchips_missingMicrochips_v2 <- microchips_missingMicrochips %>%
  filter(!animalID.microchip %in% microchips_missingMicrochips_found$animalID.microchip)

# list of animalID.microchip still missing data
microchips_missingData_final <- rbind(
  microchips_missingAnimalIDs_v2,
  microchips_missingMicrochips_v2
) %>%
  select(animalID.microchip)

# reformat to add back to master list later
microchips_masterList_missingData <- microchips_masterList_v2 %>%
  filter(animalID.microchip %in% microchips_missingData_final$animalID.microchip)
```

##### Update: microchips_runningUpdates_v2

Update "action" and "notes" columns for entries for which missing data
has been located

```{r}
microchips_runningUpdates_v2 <- microchips_runningUpdates_v1 %>%
  mutate(
    action = 
      case_when(
        animalID.microchip %in% microchips_missingAnimalIDs_found$animalID.microchip ~ "assign_animalID",
        animalID.microchip %in% microchips_missingMicrochips_found$animalID.microchip ~ "assign_microchip",
        .default = action
      ),
    notes = 
      case_when(
        action == "assign_animalID" ~ "animalID originally missing for this entry, but was located",
        action == "assign_microchip" ~ "microchip originally missing for this entry, but was located",
        str_detect(animalID.microchip, "UNK") & action == "keep" ~ "unable to locate missing data",
        .default = notes
      )
  ) %>%
  arrange(as.numeric(animalID))
```

##### Update: microchips_capData_v3

Update microchip list for capData w/located data

```{r}
microchips_capData_v3 <- microchips_capData_v2 %>%
  select(-notes) %>%
  # revert UNK to NA for missing animalIDs & microchips
  mutate(
    animalID = case_when(
      as.character(animalID) == "UNK" ~ NA,
      .default = as.character(animalID)
    ),
    microchip = case_when(
      microchip == "UNK" ~ NA,
      .default = microchip
    )
  ) %>%
  # update entries w/missing animalIDs
  merge(., microchips_missingAnimalIDs_found[, c("animalID.microchip", "animalID")], by = "animalID.microchip", all.x = T) %>%
  mutate(
    animalID = coalesce(animalID.x, animalID.y),
    .keep = "unused"
  ) %>%
  # update entries w/missing microchips
  merge(., microchips_missingMicrochips_found[, c("animalID.microchip", "microchip")], by = "animalID.microchip", all.x = T) %>%
  mutate(
    microchip = coalesce(microchip.x, microchip.y),
    .keep = "unused"
  ) %>%
  # update notes
  merge(., microchips_runningUpdates_v2[, c("animalID.microchip", "notes")], by = "animalID.microchip", all.x = T) %>%
  # revert NAs back to UNK
  mutate(
    animalID = case_when(
      is.na(as.character(animalID)) ~ "UNK",
      .default = as.character(animalID)
    ),
    microchip = case_when(
      is.na(microchip) ~ "UNK",
      .default = microchip
    )
  ) %>%
  # update animalID.microchip
  mutate(
    animalID.microchip = str_c(animalID, "_", microchip)
  ) %>%
  relocate(animalID.microchip, .after = microchip) %>%
  arrange(rowID)
```

##### Reassess

After updating the microchips for capData, we can check if there are any
entries that have both microchip1 and microchip2 entries but are still
missing an animalID.

We find one for capData rowID 814 - looking at the microchip1 entry for
rowID 814, we see that this belongs to animalID 8

```{r}
microchips_capData_v3 %>%
  filter(microchipVersion == "microchip2") %>%
  filter(microchip %in% microchips_masterList_missingData$microchip)

microchips_capData_v3 %>%
  filter(rowID == 814) %>%
  select(rowID, animalID, microchip)
```

It also looks like we need to put back a microchip for animalID 156 to
replace the incorrect one that we took out (see dupChecks) -- going with
156_0A02356657 since that's listed as microchip1 for 4 other entries

```{r}
microchips_capData_v3 %>%
  filter(animalID == 156)
```

##### Update: microchips_runningUpdates_v3

Update microchip running updates with animalID/microchip
8_933000320523715 (no need to add notes for 156_0A02356657; this is
already a confirmed combo)

```{r}
microchips_runningUpdates_v3 <- microchips_runningUpdates_v2 %>%
  mutate(
    action = case_when(
      microchip == "933000320523715" ~ "assign_animalID",
      .default = action
    ),
    notes = case_when(
      microchip == "933000320523715" ~ "animalID originally missing for this entry, but was located",
      .default = notes
    )
  )
```

##### Update: microchips_capData_v4

Update capData with animalID/microchip 8_933000320523715 &
156_0A02356657

```{r}
microchips_capData_v4 <- microchips_capData_v3 %>%
  mutate(
    animalID = case_when(
      microchip == "933000320523715" ~ "8",
      .default = animalID
    ),
    microchip = case_when(
      as.character(animalID) == "156" & microchip == "UNK" ~ "0A02356657",
      .default = microchip
    ),
    animalID.microchip = str_c(animalID, "_", microchip),
    notes = case_when(
      microchip == "933000320523715" ~ "animalID originally missing for this entry, but was located",
      as.character(rowID) == "498" ~ "Microchip entered incorrectly as [4C33045515], updated to [0A02356657]",
      .default = notes
    )
  )
```

##### Update: microchips_masterList_v3

For all entries EXCEPT for 8_933000320523715, we can remove the entries
for which animalIDs/microchips were found, since that means they already
exist in the master list of animalID/microchip combos - then add back in
the combos that are still unknown

```{r}
microchips_masterList_v3 <- microchips_masterList_v2_clean %>%
  rbind(.,
        microchips_masterList_missingData) %>%
  mutate(
    animalID = case_when(
      microchip == "933000320523715" ~ "8",
      .default = as.character(animalID)
    ),
    animalID.microchip = str_c(animalID, "_", microchip)
  ) %>%
  arrange(as.numeric(animalID)) %>%
  # update in_capData, in_fpiData, in_both
  mutate(
    in_capData = case_when(
      animalID.microchip %in% microchips_capData_v4$animalID.microchip ~ "yes",
      .default = "no"
    ),
    in_fpiData = case_when(
      animalID.microchip %in% microchips_fpiData_v1$animalID.microchip ~ "yes",
      .default = "no"
    ),
    in_both = case_when(
      in_capData == "yes" & in_fpiData == "yes" ~ "yes",
      .default = "no"
    )
  )
```

#### Typos & such

Now that we've taken care of microchips duplicated across animalIDs and
resolved most of the missing animalIDs/microchips, the next step is to
check for errors/typos/etc in the microchip IDs.

##### Data

**Comparison dataframe for capData vs. fpiData microchips**

The dataframe below lists all animalID/microchip combinations in both
capData and fpiData, then indicates 1) if the combo is present in
capData, fpiData, and/or both, 2) length of the microchip ID, 3) the
number of times that animalID/microchip combo appeared in capData, and
4) the total number of times that particular animalID appeared in
capData

```{r}
chipCompare_cap.fpi <- microchips_masterList_v3 %>%
  select(-notes) %>%
  # add length of microchip id
  mutate(
    nchar = nchar(microchip)
  ) %>%
  # add number of times animalID/microchip combo appeared in capData
  merge(., as.data.frame(table(microchips_capData_v4$animalID.microchip)), by.x = "animalID.microchip", by.y = "Var1", all.x = T) %>%
  dplyr::rename("n_chip" = "Freq") %>%
  # add total number of times animalID appeared in capData (total captures)
  merge(., as.data.frame(table(microchips_capData_v4$animalID)), by.x = "animalID", by.y = "Var1", all.x = T) %>%
  dplyr::rename("n_captures" = "Freq")
```

##### Assess

First I'm going to subset the comparison dataframe to animalID/microchip
combos that are unique to either capData or fpiData records + any combos
in which the microchip ID length is not either 10 or 15 characters.

In these investigations, it's important to keep in mind that microchip
numbers are usually 9-10 or 15 characters in length. Based on the
tamarin microchip numbers, it looks like microchips should either be 10
or 15 characters long.

```{r}
microchipErrors_typos_animalIDList <- chipCompare_cap.fpi %>%
  filter(in_both == "no" | !nchar %in% c(10, 15))

microchipErrors_typos <- chipCompare_cap.fpi %>%
  filter(animalID %in% microchipErrors_typos_animalIDList$animalID) %>%
  arrange(as.numeric(animalID))
```

**animalID 4**

-   3 total combos, 6 total captures
-   474455E294C appears in 2/6 captures; present in capData only; nchar
    = 11
-   47455E294C appears in 3/6 captures; present in both capData and
    fpiData
-   4745JE294C appears in 1/6 captures; present in capData only
-   UPDATES animalID 4
    -   4_474455E294C - remove
    -   4_47455E294C - keep
    -   4_4745JE294C - remove

**animalID 5**

-   2 total combos, 3 total captures
-   4C230533D appears in 1/3 captures; present in capData only; nchar =
    9
-   4C2305355D appears in 2/3 captures; present in both capData and
    fpiData
-   UPDATES animalID 5
    -   5_4C230533D - remove
    -   5_4C2305355D - keep

**animalID 8, 15-character microchip only**

-   2 total combos, 4 total captures
-   933000320523715 is in capData only
-   93300320523715 is in fpiData only; nchar = 14
-   UPDATES animalID 8
    -   8_0A02114607 - keep
    -   8_933000320523715 - keep
    -   8_93300320523715 - remove

**animalID 15, 10-character microchip**

-   3 total combos, 11 total captures
-   4858565774 appears in 1/11 captures; present in capData only
-   48585E5744 appears in 1/11 captures; present in capData only
-   48585E5774 appears in 7/11 captures; present in both capData and
    fpiData
-   UPDATES animalID 15 10-character microchip
    -   15_4858565774 - remove
    -   15_48585E5744 - remove
    -   15_48585E5774 - keep

**animalID 15, 15-character microchip**

-   2 total combos, 11 total captures
-   933000320126274 appears in 1/11 captures; present in capData only
-   933000320126285 appears in 1/11 captures; present in both capData
    and fpiData
-   See section above dupChecks/fpiData -- this animalID is listed in
    fpiData w/microchip "..286" vs. "..285", which I believe is an error
-   I'm fairly certain both "..274" and "..285" are valid -- while
    there's no trapping report to confirm, given that "274" is labeled
    "new" and "285" is labeled "new new" on the trapping sheet, it seems
    like there were microchip issues encountered in the field and both
    microchips ended up being used for whatever reason
-   UPDATES animalID 15 15-character microchip
    -   15_933000320126274 - keep
    -   15_933000320126285 - keep

**animalID 22**

-   2 total combos, 5 total captures
-   4C24163739 appears in 4/5 captures; present in both capData and
    fpiData
-   4624163739 appears in 1/5 captures; present in capData only
-   UPDATES animalID 22
    -   22_4C24163739 - keep
    -   22_4624163739 - remove

**animalID 26, 10-character microchip only**

-   2 total combos, 10 total captures
-   4650584351 appears in 7/10 captures; present in both capData and
    fpiData
-   46505084351 appears in 1/10 captures; present in capData only; nchar
    = 11
-   UPDATES animalID 26 10-character microchip
    -   26_4650584351 - keep
    -   26_46505084351 - discard
    -   26_933000320126321 - keep

**animalID 27, 10-character microchip only**

-   2 total combos, 17 total captures
-   4C2410290B appears in 1/17 captures; present in capData only
-   4C241D290B appears in 10/17 captures; present in both capData and
    fpiData
-   UPDATES animalID 27
    -   27_4C2410290B - remove
    -   27_4C241D290B - keep
    -   27_933000320126311 - keep

**animalID 37**

-   2 total combos, 3 total captures (one capture has no microchip
    listed)
-   4C330555735 appears in 1/3 captures; present in capData only; nchar
    = 11
-   4C33055735 appears in 2/3 captures; present in both capData and
    fpiData
-   UPDATES animalID 37
    -   37_4C330555735 - remove
    -   37_4C33055735 - keep

**animalID 38, 10-character microchip only**

-   2 total combos, 12 total captures
-   4C23025376 appears in 8/12 captures; present in both capData and
    fpiData
-   4C2302S376 appears in 1/12 captures; present in capData only
-   Typo S vs. 5
-   UPDATES animalID 38
    -   38_4C23025376 - keep
    -   38_4C2302S376 - remove
    -   38_933000320126301 - keep

**animalID 45**

-   2 total combos, 3 total captures
-   0A02113564 appears in 1/3 captures; present in capData only
-   0A02114707 appears in 2/3 captures; present in both capData and
    fpiData
-   0A02113564 is listed with captureDate 2013-07-14 (rowID 202);
    trapping sheet notes it as "new"; trapping report notes that female
    hadn't been trapped before and confirms microchip ID
-   0A02114707 is listed with captureDates 2014-06-17 (rowID 236) and
    2015-07-02 (rowID 327); 2014 trapping report notes that she's been
    trapped before and "has the microchip 0A02114707, confirmed with
    reader"
-   Descriptions in all trapping reports suggest this is the same
    individual (very old, rough looking)
-   My investigations don't help much, so going to move forward with the
    assumption that both microchips are valid... though might be good to
    keep in mind that animalID 46 (who was trapped the day after
    animalID 46 in 2013) has a veryyy similar microchip to our odd one
    out here (0A02114907 for 46 vs. ..707 for 45)
-   UPDATES animalID 45
    -   45_0A02113564 - keep
    -   45_0A02114707 - keep

**animalID 54**

-   2 total combos, 6 total captures
-   473642753 appears in 1/6 captures; present in capData only; nchar =
    9
-   473642753F appears in 5/6 captures; present in both capData and
    fpiData
-   UPDATES animalID 54
    -   54_473642753 - remove
    -   54_473642753F - keep

**animalID 70**

-   4 total combos, 3 total captures
-   formatting issues; read in as numbers or had extra spaces
-   UPDATES animalID 70
    -   70_4.82635E+23 - remove
    -   70_4.83E+23 - remove
    -   70_482 635 1E17 - remove
    -   70_4826351E17 - keep

**animalID 76**

-   "?423" is appended to the microchip ID "475F780623" in both capData
    and fpiData
-   All trapping sheets and reports list the microchip as ending in
    "623"; I've seen no indication that "423" was even possible here
-   UPDATES animalID 76
    -   76_423? - remove
    -   76_475F780623 - keep

**animalID 90**

-   2 total combos; 3 total captures
-   487434730E appears in 1/3 captures; present in capData only;
    supported by trapping sheet info
-   48743473OE appears in 2/3 captures; present in both capData and
    fpiData
-   Based on other microchips, I think the numeric 0 (vs. O) is correct
    here
-   UPDATES animalID 90
    -   90_487434730E - keep
    -   90_48743473OE - remove

**animalID 92**

-   2 total combos; 3 total captures
-   483D23220E appears in 2/3 captures; present in both capData and
    fpiData
-   483D2322OE appears in 1/3 captures; present in capData only
-   Based on other microchips, I think the numeric 0 (vs. O) is correct
    here
-   UPDATES animalID 92
    -   92_483D23220E - keep
    -   92_483D2322OE - remove

**animalID 96**

-   2 total combos; 2 total captures
-   483B751D75 appears in 1/2 captures; present in capData only
-   483E751D75 appears in 1/2 captures; present in both capData and
    fpiData
-   Typo: B vs. E - E version is in 2012 trapping sheet and report of
    capData, B version is in 2010 trapping sheet (no number given in
    report) - going to go with E here
-   UPDATES animalID 96
    -   96_483B751D75 - remove
    -   96_483E751D75 - keep

**animalID 135, 10-character microchip only**

-   2 total combos; 9 total captures
-   0A02114845 appears in 6/9 captures; present in both capData and
    fpiData
-   2114845 appears in 1/9 captures; present in capData only, nchar = 7
-   Typo: first 3 characters are cut off
-   UPDATES
    -   135_0A02114845 - keep
    -   135_2114845 - remove
    -   135_933000320523679 - keep

**animalID 138, 10-character microchip only**

-   2 total combos; 9 total captures
-   0A002115264 appears in 1/9 captures; present in capData only; nchar
    = 11
-   0A02115264 appears in 6/9 captures; present in both capData and
    fpiData
-   UPDATES animalID 138
    -   138_0A002115264 - remove
    -   138_0A02115264 - keep
    -   138_933000320126316 - keep

**animalID 144, 10-character microchip**

-   2 total combos; 12 total captures
-   0A0235S87 appears in 1/12 captures; present in capData only; nchar =
    9
-   0A02355857 appears in 7/12 captures; present in both capData and
    fpiData
-   UPDATES animalID 144 10-character microchip
    -   144_0A0235S87 - remove
    -   144_0A02355857 - keep

**animalID 144, 15-character microchip**

-   2 total combos; 12 total captures
-   933000320126318 appears in 3/12 captures; present in both capData
    and fpiData
-   93300320126318 appears in 1/12 captures; present in capData only;
    nchar = 14
-   UPDATES animalID 144 15-character microchip
    -   144_933000320126318 - keep
    -   144_93300320126318 - remove

**animalID 146**

-   2 total combos; 1 total captures
-   0A02356156 appears in 1/1 captures; present in capData only
-   0A02336156 appears in 0/1 captures; present in fpiData only
-   Difference is ..233.. (fpiData) vs. ..235.. (capData); trapping
    sheet has ..235.. but trapping report has ..233..
-   Given that no other individual has either of those microchip IDs
    (233 or 235) and animalID 146 was trapped only once so there's
    nothing else to check, I'm going to go with the ..233.. version
    since that's what's in the database and in the trapping report
-   UPDATES animalID 146
    -   146_0A02356156 - remove
    -   146_0A02336156 - keep

**animalID 189, 15-character microchip only**

-   2 total combos; 9 total captures
-   933000320126305 appears in 3/9 captures; present in both capData and
    fpiData
-   93300320126305 appears in 1/9 captures; present in capData only;
    nchar = 14
-   UPDATES animalID 189
    -   189_0A02362360 - keep
    -   189_933000320126305 - keep
    -   189_93300320126305 - remove

**animalID 195, 15-character microchip only**

-   2 total combos; 8 total captures
-   933000320126267 appears in 3/8 captures; present in both capData and
    fpiData
-   93300032012667 appears in 1/8 captures; present in capData only;
    nchar = 14
-   UPDATES animalID 195
    -   195_0A02360155 - keep
    -   195_933000320126267 - keep
    -   195_93300032012667 - remove

**animalID 209, 15-character microchip only**

-   3 total combos; 5 total captures
-   9.33E+15 (format error) appears in 1/5 captures; present in capData
    only
-   933000320126302 appears in 1/5 captures; present in capData only
-   9333000320126302 appears in 0/5 captures; present in fpiData only;
    nchar = 16
-   Trapping sheet and report also have the 9333.., but based on all
    other microchips, this should just have the two 3s after the 9
-   UPDATES animalID 209
    -   209_9.33E+15 - remove
    -   209_933000320126302 - keep
    -   209_9333000320126302 - remove
    -   209_7E10093030 - keep

**animalID 234, 10-character microchip**

-   2 total combos; 8 total captures
-   0A02357926 appears in 1/8 captures; present in capData only
-   7E10234910 appears in 3/8 captures; present in both capData and
    fpiData
-   UPDATES animalID 234 10-character microchip
    -   234_0A02357926 - keep
    -   234_7E10234910 - keep

**animalID 234, 15-character microchip**

-   2 total combos; 8 total captures
-   933000320617489 appears in 1/8 captures; present in capData only
-   933000320126306 appears in 3/8 captures; present in both fpiData
    only
-   See capData/dupChecks above for animalID 234/535 - pretty sure both
    these microchips are valid
-   UPDATES animalID 234 15-character microchip
    -   234_933000320617489 - keep
    -   234_933000320126306 - keep

**animalIDs 1781, 3061, 3089**

-   All of these have 15-character microchips present in capData, but
    not fpiData
-   1781_933000320617494 present in 2/2 captures
-   3061_933000320617486 present in 1/1 captures
-   3089_933000320617515 present in 1/1 captures
-   Means either that animalID isn't in fpiData OR is present in
    fpiData, but missing the microchip
-   Checking fpiData shows that neither the animalIDs nor microchips are
    in fpiData
-   Checking full capData shows no notes indicating that these entries
    should be ditched
-   Keeping them for now, maybe they just got missed when entering data
    into database?
-   UPDATES
    -   1781_933000320617494 - keep
    -   3061_933000320617486 - keep
    -   3089_933000320617515 - keep

```{r}
c("1781", "3061", "3089") %in% as.character(fpiData_tams2$animal_id)
c("933000320617494", "933000320617486", "933000320617515") %in% as.character(fpiData_tams2$microchip_band_tag)

View(capData_byIndiv_v4 %>%
       filter(animalID %in% c(1781, 3061, 3089)))
```

##### List of corrections

Below is a list of all of the updates determined after investigating all
typos/mismatches/etc as well as a separate list with all of the
animalID/microchip combos to remove:

```{r}
microchips_typoUpdates <- data.frame(
  temp = c(
    "4_474455E294C - remove - 4_47455E294C",
    "4_47455E294C - keep - 4_47455E294C",
    "4_4745JE294C - remove - 4_47455E294C",
    
    "5_4C230533D - remove - 5_4C2305355D",
    "5_4C2305355D - keep - 5_4C2305355D",
    
    "8_0A02114607 - keep - 8_0A02114607",
    "8_933000320523715 - keep - 8_933000320523715",
    "8_93300320523715 - remove - 8_933000320523715",
    
    "15_4858565774 - remove - 15_48585E5774",
    "15_48585E5744 - remove - 15_48585E5774",
    "15_48585E5774 - keep - 15_48585E5774",
    
    "15_933000320126274 - keep - 15_933000320126274",
    "15_933000320126285 - keep - 15_933000320126285",
    
    "22_4624163739 - remove - 22_4C24163739",
    "22_4C24163739 - keep - 22_4C24163739",
    
    "26_46505084351 - remove - 26_4650584351",
    "26_4650584351 - keep - 26_4650584351",
    
    "26_933000320126321 - keep - 26_933000320126321",
    
    "27_4C2410290B - remove - 27_4C241D290B",
    "27_4C241D290B - keep - 27_4C241D290B",
    
    "27_933000320126311 - keep - 27_933000320126311",
    
    "37_4C330555735 - remove - 37_4C33055735",
    "37_4C33055735 - keep - 37_4C33055735",
    
    "38_4C23025376 - keep - 38_4C23025376",
    "38_4C2302S376 - remove - 38_4C23025376",
    
    "38_933000320126301 - keep - 38_933000320126301",
    
    "45_0A02113564 - keep - 45_0A02113564",
    "45_0A02114707 - keep - 45_0A02114707",
    
    "54_473642753 - remove - 54_473642753F",
    "54_473642753F - keep - 54_473642753F",
    
    "70_4.82635E+23 - remove - 70_4826351E17",
    "70_4.83E+23 - remove - 70_4826351E17",
    "70_482 635 1E17 - remove - 70_4826351E17",
    "70_4826351E17 - keep - 70_4826351E17",
    
    "76_423? - remove - 76_475F780623",
    "76_475F780623 - keep - 76_475F780623",
    
    "90_487434730E - keep - 90_487434730E",
    "90_48743473OE - remove - 90_487434730E",
    
    "92_483D23220E - keep - 92_483D23220E",
    "92_483D2322OE - remove - 92_483D23220E",
    
    "96_483B751D75 - remove - 96_483E751D75",
    "96_483E751D75 - keep - 96_483E751D75",
    
    "135_0A02114845 - keep - 135_0A02114845",
    "135_2114845 - remove - 135_0A02114845",
    
    "135_933000320523679 - keep - 135_933000320523679",
    
    "138_0A002115264 - remove - 138_0A02115264",
    "138_0A02115264 - keep - 138_0A02115264",
    
    "138_933000320126316 - keep - 138_933000320126316",
    
    "144_0A02355857 - keep - 144_0A02355857",
    "144_0A0235S87 - remove - 144_0A02355857",
    
    "144_933000320126318 - keep - 144_933000320126318",
    "144_93300320126318 - remove - 144_933000320126318",
    
    "146_0A02336156 - keep - 146_0A02336156",
    "146_0A02356156 - remove - 146_0A02336156",
    
    "189_0A02362360 - keep - 189_0A02362360",
    
    "189_933000320126305 - keep - 189_933000320126305",
    "189_93300320126305 - remove - 189_933000320126305",
    
    "195_0A02360155 - keep - 195_0A02360155",
    
    "195_933000320126267 - keep - 195_933000320126267",
    "195_93300032012667 - remove - 195_933000320126267",
    
    "209_7E10093030 - keep - 209_7E10093030",
    "209_9.33E+15 - remove - 209_7E10093030",
    
    "209_933000320126302 - keep - 209_933000320126302",
    "209_9333000320126302 - remove - 209_933000320126302",
    
    "234_0A02357926 - keep - 234_0A02357926",
    "234_7E10234910 - keep - 234_7E10234910",
    
    "234_933000320126306 - keep - 234_933000320126306",
    "234_933000320617489 - keep - 234_933000320617489",
    
    "1781_933000320617494 - keep - 1781_933000320617494",
    "3061_933000320617486 - keep - 3061_933000320617486",
    "3089_933000320617515 - keep - 3089_933000320617515"
    )
  ) %>%
  separate("temp", into = c("animalID.microchip", "action", "new"), sep = " - ") %>%
  mutate(
    check = case_when(
      animalID.microchip == new ~ TRUE,
      .default = FALSE
    )
  )

microchips_typoUpdates_toRemove <- microchips_typoUpdates %>%
  filter(action == "remove")
```

##### Update: microchips_runningUpdates_v4

Update microchip running updates with typo corrections

```{r}
microchips_runningUpdates_v4 <- microchips_runningUpdates_v3 %>%
  merge(., microchips_typoUpdates_toRemove[, c("animalID.microchip", "new")], by = "animalID.microchip", all.x = T) %>%
  mutate(
    action = case_when(
      !is.na(new) ~ "update_microchip",
      .default = action
    ),
    notes = case_when(
      !is.na(new) ~ str_c("Microchip entered incorrectly, update to [", new, "]"),
      .default = notes
    )
  ) %>%
  select(-new) %>%
  relocate(animalID.microchip, .after = microchip)
```

##### Update: microchips_capData_v5

Update capData with typo corrections

```{r}
microchips_capData_v5 <- microchips_capData_v4 %>%
  merge(., microchips_typoUpdates_toRemove[, c("animalID.microchip", "new")], by = "animalID.microchip", all.x = T) %>%
  mutate(
    notes = case_when(
      !is.na(new) ~ str_c(microchipVersion, " entered incorrectly as [", microchip, "], updated to [", new, "]"),
      .default = notes
    ),
    animalID.microchip = case_when(
      !is.na(new) ~ new,
      .default = animalID.microchip
    )
  ) %>%
  select(-animalID, -microchip) %>%
  separate("animalID.microchip", into = c("animalID", "microchip"), sep = "_", remove = F) %>%
  select(rowID, microchipVersion, animalID, microchip, animalID.microchip, notes) %>%
  # need to ditch the duplicate rowID/animalID/microchip combos formed after updating to "new" microchip
  arrange(rowID, notes) %>%
  mutate(
    rowID.animalID.microchip = str_c(rowID, animalID.microchip, sep = "."),
    dup = duplicated(rowID.animalID.microchip)
  ) %>%
  filter(dup == "FALSE") %>%
  select(-rowID.animalID.microchip, -dup)
```

##### Update: microchips_masterList_v4

Update master list with typo corrections

```{r}
microchips_masterList_v4 <- microchips_masterList_v3 %>%
  select(animalID.microchip) %>%
  merge(., microchips_typoUpdates_toRemove[, c("animalID.microchip", "new")], by = "animalID.microchip", all.x = T) %>%
  mutate(
    animalID.microchip = case_when(
      !is.na(new) ~ new,
      .default = animalID.microchip
    )
  ) %>%
  select(-new) %>%
  distinct() %>%
  separate("animalID.microchip", into = c("animalID", "microchip"), sep = "_", remove = F) %>%
  relocate(animalID.microchip, .after = microchip) %>%
  # update in_capData, in_fpiData, in_both
  mutate(
    in_capData = case_when(
      animalID.microchip %in% microchips_capData_v4$animalID.microchip ~ "yes",
      .default = "no"
    ),
    in_fpiData = case_when(
      animalID.microchip %in% microchips_fpiData_v1$animalID.microchip ~ "yes",
      .default = "no"
    ),
    in_both = case_when(
      in_capData == "yes" & in_fpiData == "yes" ~ "yes",
      .default = "no"
    )
  ) %>%
  arrange(as.numeric(animalID))
```

#### Update capData_byIndiv_v5

```{r}
# take notes col off then add back in after pivot
microchips_capData_v5_notesCol <- microchips_capData_v5 %>%
  select(rowID, notes) %>%
  na.omit() %>%
  distinct()

microchips_capData_v6 <- microchips_capData_v5 %>%
  select(rowID, microchipVersion, animalID, microchip) %>%
  pivot_wider(names_from = microchipVersion,
              values_from = microchip) %>%
  # move over microchip2 when microchip1 is NA
  mutate(
    microchip1 = coalesce(microchip1, microchip2)
  ) %>%
  # add notes col back in
  merge(., microchips_capData_v5_notesCol, by = "rowID", all.x = T) %>%
  dplyr::rename("notes_microchips" = "notes")

# make sure we don't have dup rowIDs
microchips_capData_v6 %>%
  select(rowID) %>%
  get_dupes(rowID)

capData_byIndiv_v5 <- capData_byIndiv_v4 %>%
  select(-c(animalID, microchip1, microchip2, microchip3)) %>%
  merge(., microchips_capData_v6, by = "rowID") %>%
  relocate(animalID, .after = animalName2) %>%
  relocate(c(microchip1, microchip2, microchip3), .after = trappingID) %>%
  relocate(notes_microchips, .after = notes_RV)

capData_byIndiv_v5 %>%
  select(rowID) %>%
  get_dupes(rowID)
```

#### EXPORT

```{r}
# updated capData_byIndiv
write.csv(capData_byIndiv_v5, "./paper3_demographics/01_dataOrganization/captureData_byIndividual_v5.csv", row.names = F)

# all edits to microchips/animalIDs
write.csv(microchips_runningUpdates_v4 %>% arrange(as.numeric(animalID)), "./paper3_demographics/01_dataOrganization/microchipUpdates_runningList.csv", row.names = F)
```

### Clean step #4: Species & sex assignments (COMPLETE)

Now that all possible animalIDs/microchips have been assigned and
cleaned, we can do another check to make sure that species and sex
assignments are consistent for each animalID in the capture records.

Looks good - the only duplicates are for the "UNK" animalIDs.

```{r}
dupTest_spSex_capData_byIndiv_v5 <- capData_byIndiv_v5 %>%
  select(c(animalID, species, sex)) %>%
  arrange(animalID) %>%
  distinct() %>%
  group_by(animalID) %>%
  filter(n() > 1) %>%
  summarize(n=n())
```

### byIndiv

1.  Address all issues noted by MD
2.  Ensure the following variables are filled in:
    1.  captureDate
    2.  captureID
    3.  species
    4.  groupName
    5.  groupID
    6.  ageClass
    7.  sex
    8.  animalName1
    9.  animalID
    10. trappingID
    11. microchip1
    12. tailPattern
3.  Address missing data
4.  Address valid_groupName = FALSE
5.  Ensure species and sex are consistent per animalID; address
    inconsistencies

## 4.2 captureData_byGroup

### Clean step #1 (COMPLETE)

Cleaning step 1 was completed by Maddy in Google Sheets.

### Clean step #2 (IN PROGRESS)

asdf

## 4.3 nonCaptureObs

### Data entry (IN PROGRESS)

For every entry in captureData_byGroup, enter any non-captured
individuals (with as many details as are available) into the
nonCaptureObs Google sheet.

OR

just use captureData_byGroup and grab the uncaptured names for now

### Clean step #1 (IN PROGRESS)

Download and rename as **nonCaptureObs_2009to2023_v1.csv**

Assign animalIDs and other info where possible

```{r}
nonCapObs_v1 <- read.csv()
```

# 5 Organize clean data

## All observations

Creating a master file of all observations + all other info available
for those observations

## Data

Combine data from captureData_byIndiv & nonCaptureObs

```{r}
# latest clean version of capData_byIndiv
captureData_byIndiv <- read.csv("./paper3_demographics/01_dataOrganization/captureData_byIndividual_v5.csv") %>%
  # remove "UNK" animalIDs
  filter(as.character(animalID) != "UNK")

# latest clean version of nonCaptureObs
nonCaptureObs <- read_excel("./paper3_demographics/01_dataOrganization/tamGenetics_demographics_dataCleaning.xlsx", sheet = 3) %>%
  as.data.frame()

captureData_byIndiv_allObs <- captureData_byIndiv %>%
  dplyr::rename("obsDate" = "captureDate") %>%
  mutate(
    animalID = as.integer(animalID),
    obsType = "capture",
    animalID_certainty = "certain",
    animalName_certainty = "certain",
    ageClass_certainty = NA,
    sex_certainty = "certain",
    group_certainty = "certain"
  ) %>%
  select(c("animalID",
           "animalID_certainty",
           "obsDate",
           "obsType",
           "species",
           "groupName",
           "groupID",
           "group_certainty",
           "ageClass",
           "ageClass_certainty",
           "sex",
           "sex_certainty",
           "animalName1",
           "animalName2",
           "animalName_certainty",
           "microchip1",
           "microchip2",
           "microchip3",
           "weightTotal",
           "weightBag",
           "weightAnimal",
           "testesVulva_length",
           "testesVulva_width",
           "spGland_length",
           "spGland_width",
           "nippleR_length",
           "nippleL_length",
           "dentitionState",
           "notes_MD",
           "notes_RV",
           "notes_microchips"))
  
nonCaptureObs_allObs <- nonCaptureObs %>%
  rename("animalName1" = "animalName") %>%
  mutate(
    animalID_certainty = NA,
    animalName2 = NA,
    microchip1 = NA,
    microchip2 = NA,
    microchip3 = NA,
    weightTotal = NA,
    weightBag = NA,
    weightAnimal = NA,
    testesVulva_length = NA,
    testesVulva_width = NA,
    spGland_length = NA,
    spGland_width = NA,
    nippleR_length = NA,
    nippleL_length = NA,
    dentitionState = NA
  ) %>%
  select(c("animalID",
           "animalID_certainty",
           "obsDate",
           "obsType",
           "species",
           "groupName",
           "groupID",
           "group_certainty",
           "ageClass",
           "ageClass_certainty",
           "sex",
           "sex_certainty",
           "animalName1",
           "animalName2",
           "animalName_certainty",
           "microchip1",
           "microchip2",
           "microchip3",
           "weightTotal",
           "weightBag",
           "weightAnimal",
           "testesVulva_length",
           "testesVulva_width",
           "spGland_length",
           "spGland_width",
           "nippleR_length",
           "nippleL_length",
           "dentitionState",
           "notes"))
```

All observations

```{r}
allObs <- rbind(captureData_byIndiv_allObs, nonCaptureObs_allObs) %>%
  filter(!is.na(obsDate)) %>%
  arrange(obsDate) %>%
  group_by(animalID) %>%
  mutate(obsID = row_number()) %>%
  ungroup() %>%
  relocate(obsID, .after = animalID_certainty)
```

# 7 Census data

## 7.1 To-do's

1.  Download tamGenetics_demographics_dataCleaning
2.  Extract captureData_byIndiv & nonCaptureObs
3.  Create censusData with the following columns:
    1.  obsDate
    2.  obsType
    3.  animalID
    4.  obsID (animalID\_#)
    5.  species
    6.  groupName
    7.  groupID
    8.  animalName
    9.  ageClass
    10. sex
    11. notes

## 7.3 censusData template

```{r}
censusData <- allObs %>%
  select(c("obsDate", "obsType", "animalID", "animalID_certainty", "animalName1", "animalName2", "animalName_certainty", "ageClass", "ageClass_certainty", "sex", "sex_certainty", "groupName", "groupID", "group_certainty", "species", "notes"))
```

# 8 Biographical data

Desired columns:

-   animalID
-   species
-   sex
-   natalGroup
-   natalGroupID
-   natalGroup_certainty
-   momID
-   firstBorn
-   dadID
-   dad_LLR
-   twinID
-   birthDate_assigned
-   birthDate_min
-   birthDate_max
-   birthDate_dist
-   entryDate
-   entryType
-   departDate
-   departDate_error
-   departType

## 8.1 bioData template

```{r}
bioData <- allObs %>%
  filter(obsID == 1) %>%
  mutate(
    natalGroup = 
      case_when(
        ageClass == "juvenile" ~ groupName,
        .default = "unk"
        ),
    natalGroupID = 
      case_when(
        !is.na(natalGroup) ~ groupID,
        .default = NA
      ),
    natalGroup_certainty = NA,
    momID = NA,
    firstBorn = NA,
    dadID = NA,
    dad_LLR = NA,
    twinID = NA,
    birthDate_assigned = 
      case_when(
        ageClass == "juvenile" ~ make_date(
          year = year((obsDate) - years(1)),
          month = 10,
          day = 1),
        .default = NA
      ),
    birthDate_min = 
      case_when(
        ageClass == "juvenile" ~ birthDate_assigned,
        ageClass == "subadult" ~ make_date(
          year = year((obsDate) - years(5)),
          month = 10,
          day = 1),
        ageClass == "adult" ~ make_date(
          year = year((obsDate) - years(13)),
          month = 10,
          day = 1),
        .default = NA
      ),
    birthDate_max = NA,
    birthDate_dist = NA,
    entryDate = obsDate,
    entryType = obsType,
    departDate = NA,
    departDate_error = NA,
    departType = NA
  ) %>%
  select(c('animalID',
           'species',
           'sex',
           'natalGroup',
           'natalGroupID',
           'natalGroup_certainty',
           'momID',
           'firstBorn',
           'dadID',
           'dad_LLR',
           'twinID',
           'birthDate_assigned',
           'birthDate_min',
           'birthDate_max',
           'birthDate_dist',
           'entryDate',
           'entryType',
           'departDate',
           'departDate_error',
           'departType'))
```

## 8.2 watsaDiss_data

In her dissertation (Watsa 2013), Mini has a lot of tables that contain
useful information -- I'm reproducing them here so that I can use them
in my own analyses.

In those tables, Mini uses what I refer to as the "dissID" for each
individual, which refers to the sex, group, and individual number (e.g.,
F12 = female in group 1, female number 2). I located their corresponding
groupNames & animalIDs manually for watsa_table.vi1 below, then used
that to create watsaDiss_groupKey as well as a start to
watsaDiss_indivKey so that I can add the groupNames and animalIDs to the
remaining tables as well.

**NOTE** that year 1/2/3 don't always refer to the same years in Mini's
dissertation tables!! Year 1 is either 2010 or 2011, while year 2 is
2011 or 2012 - be sure to check the table legend in the dissertation!

### watsaDiss_indivKey & watsaDiss_groupKey

#### LWED group notes

-   **SF1 (FC)**
    -   F10
        -   **watsa_table.vi4:** primary breeding female; year1 (2010)
            entry only; old adult; glandArea = 226 mm2; nippleLength =
            3.9 mm
        -   **in-text (p. 193):** allonursed F11's twins for 125 days
            after F10 had attempted weaning
        -   animalID 117/GPG based on capData; 2010 glandArea &
            nippleLength are a match, plus is the only indiv not
            captured after 2010
    -   F11
        -   **watsa_table.vi4:** primary breeding female; entries for
            years 1, 2, 3 (2010, 2011, 2012), though not trapped in
            2011; regular adult; glandArea 2010 = 133 mm2, 2012 = 157
            mm2; nippleLength 2010 = 3.9 mm, 2012 = 4 mm
        -   **in-text (p. 193):** gave birth to infants in 2009-Nov;
            twins were first nursed by mother for 109 days/3.6 months
            w/last 30 days attempted weaning; from day 109-234 (125
            days/4.2 months) F10 allonursed infants
        -   animalID 76/GRC based on capData; glandArea & nippleLength
            match
    -   F12
        -   **watsa_table.vi1:** exact bday known 11/23/09
        -   **watsa_table.vi12:** infant in 2010; non-fertile female in
            2011
        -   **watsa_table.vii8:** glandArea 2011 = 170 mm2
        -   animalID 101/GPO based on capData; glandArea 2011 matches
            (and F13's, F12's twin, does not)
    -   F13
        -   **watsa_table.vi1:** exact bday known 11/23/09
        -   **watsa_table.vi5:** SBF in year 3; glandArea 166 mm2 --
            NOTE that this doesn't match what I have for animalID 7
            (most likely animalID) in 2012 (I have 196 mm2); but
            animalID 101 doesn't have a capture in 2012
        -   **watsa_table.vi12:** infant in 2010; non-fertile female in
            2011; SBF in 2012
        -   animalID 7/GPBL (since confirmed that she isn't 101, must be
            7)  
    -   F14
        -   **watsa_table.vi1:** ageEst 7.25 on 6/8/12
        -   **watsa_table.vi3:** noted as slightly older than F15 (sep
            2011 birthEst vs. F15 oct 2011)
        -   **watsa_table.vi12:** infant in year3/2012
        -   either animalID 75/GPL or 77/GPY
        -   animalID 75 based on capData & trapReport; has visible sp
            gland (unlike 77/GPY)
    -   F15
        -   **watsa_table.vi1:** ageEst 7.25 on 6/8/12
        -   **watsa_table.vi3:** noted as slightly younger than F14 (oct
            2011 birthEst vs. F14 sep 2011)
        -   **watsa_table.vi12:** infant in year3/2012
        -   either animalID 75/GPL or 77/GPY
        -   animalID 77/GPY based on capData & trapReport; in report,
            noted as still having deciduous canines & no visible gland
            (unlike 75/GPL)
-   **SF2 (Jf)**
    -   F20
        -   **watsa_table.vi5:** secondary female; glandArea 2010 = 95
            mm2
        -   **watsa_table.vi12:** killed by friaje in 2010
        -   animalID 120 based on matching capData glandArea
    -   F21
        -   **watsa_table.vi4:** primary female; glandArea 2010 = 393
            mm2
        -   **watsa_table.vi12:** killed by friaje in 2010
        -   animalID 121 based on matching capData glandArea
    -   F22
        -   **watsa_table.vi4:** has entries for year 2 & 3
        -   **watsa_table.vi12:** primary breeding female in 2011 &
            2012; 2011 notes say "F22 immigrated successfully and became
            the primary breeding female"
        -   **watsa_table.vii8:** glandArea 2011 = 283 mm2; nippleLength
            2011 = 4.3 mm
        -   animalID 105 based on capData; glandArea 2011 & nippleLength
            matches
    -   F23
        -   **watsa_table.vi1:** ageEst 3 months on 4/24/11
        -   **watsa_table.vi3:** survived for 1 year; in natal group at
            30 mo of age [[birthEst is 2010-Jan, but I think this should
            be 2011-Jan??]]
        -   either animalID 30/RPG or 111/RPBL
        -   animalID 30/RPG based on capData; has captureDates 2011,
            2012, and 2013
    -   F24
        -   **watsa_table.vi1:** ageEst 3 months on 4/24/11
        -   **watsa_table.vi3:** dead; disappeared from group by 2011
            [[birthEst is 2010-Jan, but I think this should be
            2011-Jan??]]
        -   either animalID 30/RPG or 111/RPBL
        -   animalID 111/RPBL based on capData; only has one entry
            captureDate 111
    -   M22
        -   **watsa_table.vi1:** ageEst 5.75 months on 6/30/12
        -   animalID 29/RBS based on capData; is the only Jf juvenile
            male w/2012 captureDate
-   **SF3 (Perro6)**
    -   F30
        -   **watsa_table.vi12:** non-fertile female in 2010; listed as
            SBF w/Loners in 2011 & 2012
        -   **watsa_table.vii8:** glandArea 2010 (pre-dispersal) = 105
            mm2, 2010 (post-dispersal) = 147 mm2, 2011 = 335 mm2
        -   animalID 115/RCBL based on capData; all glandArea
            measurements match; NOTE however, that capData lists group
            as "Angels" on 6/22/10 (animalID 130/YPG is the only other
            individuals w/capData in Angels) - watsa_table.vi12 says
            that LF1 roamed briefly w/F30 in "Loners" category in 2010,
            maybe this is "Angels"? Though also has "relatively stable
            bachelorette group" w/F30 and LF2 in 2012
    -   F31
        -   **watsa_table.vi4:** primary female; 2010 entry only;
            glandArea = 379 mm2; nippleLength = 5.6 mm
        -   animalID 123/BLPBL based on capData; glandArea & nipple
            length matches, notes say appears to be lactating
    -   M32
        -   **watsa_table.vi1:** ageEst 4.5 on 5/5/10
        -   **watsa_table.vi3:** birthEst 2009-dec; died during July
            2010 friaje
        -   either animalID 125/P6T1 or 126/P6T2
        -   assign as animalID 125; can't find any additional details to
            differentiate w/M33, but should matter given that both died
            in 2010
    -   M33
        -   **watsa_table.vi1:** ageEst 4.5 on 5/5/10
        -   **watsa_table.vi3:** birthEst 2009-dec; died during July
            2010 friaje
        -   either animalID 125/P6T1 or 126/P6T2
        -   assign as animalID 126; can't find any additional details to
            differentiate w/M32, but should matter given that both died
            in 2010
-   **SF4 (AR6)**
    -   F41
        -   **watsa_table.vi4:** primary female; entries for years 1, 2,
            3; glandArea 2010 = 484, 2011 = 483, 2012 = 415
        -   animalID 90 based on capData; animalID 90 is the only female
            w/captureDate entries in 2010, 2011, and 2012; glandArea in
            2010 & 2012 match, but 2011 = 522 in capData (this seems
            hella high though; likely the diss value is correct)
    -   F42
        -   **watsa_table.vi12:** listed as non-fertile female in 2010
        -   **watsa_table.vii8:** glandArea 2010 = 75 mm2
        -   animalID 128/OPW based on capData; glandArea 2010 matches
    -   F43
        -   **watsa_table.vi1:** ageEst 5.75 months on 4/11/11
        -   **watsa_table.vi3:** birthYear_est 2010-oct; in natal group
            at 21 months
        -   **watsa_table.vi5:** secondary female; entries for 2012
            only; glandArea 2012 = 133 mm2
        -   animalID 71 based on capData; animalID 71 is the only F
            aside from animalID 90 w/captureDate in 2012 (year 3);
            HOWEVER glandArea doesn't match (capData = 339.24 mm2)
    -   M43
        -   **watsa_table.vi1:** ageEst 5.75 months on 4/11/11
        -   **watsa_table.vi3:** birthYear_est 2010-oct; in natal group
            at 21 months
        -   **watsa_table.vi7:** SBM in 2012; tvol = 662 mm3
        -   animalID 26 based on capData; only juv male captured 4/11/11
    -   M44
        -   **watsa_table.vi1:** ageEst 9.75 months on 6/20/12
        -   **watsa_table.vi3:** birth_est 2011-sep; survived to min 10
            months
        -   either animalID 27/OBL or 70/OBW
        -   assign as animalID 27; can't find any other details to
            differentiate M44 vs. M45
    -   M45
        -   **watsa_table.vi1:** ageEst 9.75 months on 6/20/12
        -   **watsa_table.vi3:** birth_est 2011-sep; survived to min 10
            months
        -   either animalID 27/OBL or 70/OBW
        -   assign as animalID 70; can't find any other details to
            differentiate M44 vs. M45
-   **SF5 (WhiteSf)**
    -   F50
        -   **watsa_table.vi4:** primary breeding female; entries for
            years 1, 2, 3; glandArea year1 = 263 mm2, year3 = 311 mm2;
            nippleLength year3 = 3.0
        -   animalID 41 based on capData
    -   F51
        -   **watsa_table.vi4:** primary breeding female; entries for
            years 1, 2, 3 (though year 3 says "not trapped"); year1
            gland area = 265 mm2; year1 nippleLength = 3.6
        -   animalID 131 based on capData
    -   F53
        -   **watsa_table.vi1:** ageEst 7.25 months on 6/16/12
        -   **watsa_table.vi3:** birthEst 2011-nov; survived to min 8
            months
        -   animalID 85/WPS based on capData; only juv F captured on
            6/16/12
    -   M51
        -   **watsa_table.vi1:** ageEst 5.75 on 6/28/10 & 7/21/10
        -   **watsa_table.vi2:** present in SF5 in 2012
        -   **watsa_table.vi3:** birthEst 2010-jan; in natal group at 30
            months
        -   **watsa_table.vi6:** PBM in 2012 w/ tvol 907 mm3; glandArea
            75 mm2
        -   **watsa_table.vi7:** SBM in 2011
        -   animalID 83/WBG based on capData; has captureDates in 2010
            (juv) & 2012; 2012 glandArea matches
-   **SF6 (CL3)**
    -   F60
        -   **watsa_table.vi1:** ageEst 9.5 months on 7/6/12
        -   **watsa_table.vi3:** birthEst 2011-sep; survived to min 10
            months
        -   animalID 66/YPO based on capData; only juv F captured on
            7/6/12
    -   F61
        -   **watsa_table.vi4:** primary breeding female; entry for 2012
            only; glandArea 341; nippleLength 3.0
        -   animalID 67 based on capData; the only other F trapped in
            2012 is a juv that year
-   **SF7 (Bloopers)**
    -   F70
        -   **watsa_table.vi4:** primary breeding female; old adult;
            entry for 2012 only; glandArea = 265 mm2
        -   animalID 97 based on capData
    -   F71
        -   **watsa_table.vi4:** primary breeding female; regular adult;
            2012 only; glandArea = 341 mm2
        -   animalID 63 based on capData
    -   F72
        -   **watsa_table.vi5:** SBF in2012; glandArea 299 mm2;
            nippleLength 0 mm; nulliparous
        -   animalID 61/BLPBL based on capData; only F w/captureDate in
            2012 w/matching glandArea & nippleLength
    -   M71
        -   **watsa_table.vi1:** ageEst 9.75 months on 7/6/12
        -   **watsa_table.vi3:** birthEst 2011-Sep; survived to min 10
            months
        -   animalID 60/BLBL based on capData; heavier of the two male
            juvs w/captureDate 7/6/12
    -   M72
        -   **watsa_table.vi1:** ageEst 5.75 months on 7/6/12
        -   **watsa_table.vi3:** birthEst 2011-Jan [[should this be
            2012??]]; survived to min 6 months
        -   animalID 62/BLBR based on capData; lighter of the two male
            juvs w/captureDate 7/6/12

#### SIMP group notes

-   **SI1 (WhiteEmps)**
    -   M12
        -   **watsa_table.vi1:** ageEst 7.25 months on 6/24/12
        -   **watsa_table.vi3:** birthEst 2011-Nov; survived to min 8
            months
        -   either animalID 55/WBW or 93/WBS
        -   assign as animalID 55; can't find any other details in diss
            to differentiate M12 & M13
    -   M13
        -   **watsa_table.vi1:** ageEst 7.25 months on 6/24/12
        -   **watsa_table.vi3:** birthEst 2011-Nov; survived to min 8
            months
        -   either animalID 55/WBW or 93/WBS
        -   assign as animalID 93; can't find any other details in diss
            to differentiate M12 & M13
-   **SI2 (Ji)**
    -   F21
        -   **watsa_table.vi1:** ageEst 1.5 on 4/17/11
        -   **watsa_table.vi3:** birthEst 2011-March; dispersal attempts
            at 17 months
        -   **watsa_table.vi13:** infant in 2011; non-fertile female in
            2012
        -   animalID 36/twin1 based on capData; only female juv
            w/captureDate 4/17/11
    -   M23
        -   **watsa_table.vi1:** ageEst 1.5 on 4/17/11
        -   **watsa_table.vi3:** birthEst 2011-March; marked "dead";
            "disappeared from natal group"
        -   animalID 102/twin2 based on capData; only male juv
            w/captureDate 4/17/11
    -   F22
        -   **watsa_table.vi1:** ageEst 7.25 on 6/13/12
        -   **watsa_table.vi3:** birthEst 2011-Nov; survived to min 8
            months
        -   either 34/RPS or 80/RPBL
        -   assign as animalID 34; can't find any other details in diss
            to differentiate F22/23
    -   F23
        -   **watsa_table.vi1:** ageEst 7.25 on 6/13/12
        -   **watsa_table.vi3:** birthEst 2011-Nov; survived to min 8
            months
        -   either 34/RPS or 80/RPBL
        -   assign as animalID 80; can't find any other details in diss
            to differentiate F22/23
-   **SI3 (IC)**
    -   F30
        -   **watsa_table.vi13:** PBF in 2011 & 2012
        -   **watsa_table.vi8** old adult in 2011 & 2012; glandArea 2011
            = 254 mm2, 2012 = 345 mm2; nippleLenght 2011 = 5.0 mm, 2012
            = 4.9 mm; 2012 notes "highest suprapubic gland area and
            vulvar index"
        -   animalID 24/GPO_GRC based on capData; only adult female
            captured in IC 2012
    -   F32
        -   **watsa_table.vi1:** ageEst 7.25 months on 6/10/12
        -   **watsa_table.vi3:** birthEst 2011-Nov; survival for 1 year
            UNK; disappeared, possibly dispersed
        -   **watsa_table.vi13:** F32 & M33 immigrate into SI3/IC w/M61
            in 2012, not born there
        -   animalID 79/GPS based on capData; only juv F w/captureDate
            6/10/12
    -   M31
        -   **watsa_table.vi10:** PBM in year1/2011; glandArea = 143
            mm2; "lowest tvol., but included b/c he attempted to mate
            with the PBF"
        -   animalID 106 based on capData; glandArea matches, no entries
            aside from 2011
    -   M32
        -   **watsa_table.vi10:** old adult PBM in year2/2012; glandArea
            = 0 mm2
        -   **watsa_table.vi11:** SBM; "not trapped [in 2011] but likely
            breeding male since he bred for sure in year 2 [2012]"
        -   animalID 22 based on capData; only has 2012 captureDate and
            no gland measurements
    -   M33
        -   **watsa_table.vi1:** ageEst 7.25 months on 6/10/12
        -   **watsa_table.vi2:** successfully mated w/F30 despite being
            juv (F30 noted as PBF who was not his mother)
        -   **watsa_table.vi3:** birthEst 2011-Nov; survived to min 8
            months
        -   **watsa_table.vi13:** F32 & M33 immigrate into SI3/IC w/M61
            in 2012, not born there
        -   animalID 1 based on capData; only juv M w/captureDate
            6/10/12

si3 was 2012 focal group; contained 1 female (F30) and 3 males (M32,
M30, M61). observed mating w/only M32 and M61 despite M30 capable of
breeding (pbm here in 2011). mated once with m33

-- in 2011, 2 males are captured: 106/GBR, 74/GBY -- in 2012, 3 males
are captured: 1/GBW (juv), 22/GBL, and 74/GBY + 1 adult female
(24/GRC_GPO) -- that makes F30 24/GRC_GPO -- leaves 22 & 74 for
M32/M30/M61 -- 106/GBY is only captured in 2011 -- 22/GBL is only
captured in 2012 -- 74/GBY is the only adult M captured in 2011 and 2012

-   **SI4 (OrangeEmps)**
    -   F40
        -   **watsa_table.vi1:** ageEst 5.25 on 4/22/11
        -   **watsa_table.vi2:** listed as mating w/M41 in 2011 and unk
            male in 2012 [[table_vi.11 notes that M41 "tried to mate
            with infant F40, unsuccessful"]]
        -   **watsa_table.vi3:** birthEst 2010-Nov; "dead"; "disappeared
            from group by 2012"
        -   either animalID 92/OPY or 109/OPBL
        -   animalID 109/OPBL based on capData; no records beyond
            captureDate 4/22/11 (where listed as juv)
    -   F43
        -   **watsa_table.vi1:** ageEst 5.25 on 4/22/11
        -   **watsa_table.vi3:** birthEst 2010-Nov; in natal group at 20
            months
        -   **watsa_table.vi13:** infant in 2011; non-fertile female in
            2012
        -   either animalID 92/OPY or 109/OPBL
        -   animalID 92/OPY based on capData; juv on captureDate 4/22/11
            with additional captureDate in 2012
-   **SI5 (DangerousPeople)**
    -   F51
        -   **table_vi.3:** (p. 198) "died soon after second capture"
            (meaning in 2012??); est birth 2010-Nov
        -   **table_vi.9:** (p. 211) SBF 2011
        -   **table_vi.13** (p. 223) SBF 2011; simpLoners_F51 SBF
            2012...I assume this is the same F51
        -   **table_vii.8** (p. 263) SBF in 2011 w/glandArea = 166 mm2 &
            nippleLength = 3.9 mm; RFF (roaming fertile female) in 2012
            w/glandArea = 169 mm2 & nippleLength = 4.1 mm
        -   **\>\> F51 = animalID 89?? \<\<**
            -   animalID 89/SPO is the only one besides 88/SPBL trapped
                in both 2011 & 2012
            -   animalID 89 2012 nippleL_length = 4.1 (though
                nippleR_length is 5...); 15/SPS is the only other one
                with nipple measurements, but hers don't match
    -   F52_SI5
        -   **table_iv.1** (p. 121)
            -   F52 age_est 5.75 months on 5/4/11
            -   thought to be twin w/F53
        -   **table_vi.13** (p. 223)
            -   SI5_F52 infant in 2011
            -   SI5_F52 NFF (non-fertile female) in 2012
            -   "F52 died post trapping" in 2012
        -   **in-text** (p. 228)
            -   F52 became nonbreeding adult
        -   **\>\> F52 = animalID 87?? \<\<**
            -   animalID 87/SBPL in capData as "died during processing"
                in capData 2012
            -   SPBL is the only "juvenile" for DangerousPeople capData
    -   F53
        -   **table_iv.1** (p. 121)
            -   F53 not trapped
            -   F53 presumed 5.75 months
            -   F53 "captured the next year and is most likely the twin
                of F52" (I assume by "next year" this means 2012?)
        -   **table_vi.13** (p. 223)
            -   F53 infant in 2011
            -   no other mention of F53 in the diss
        -   **\>\> F53 = animalID 88?? \<\<**
            -   DangerousPeople only have captures during 2011 & 2012;
                animalID 88/SPW is the only one captured in 2012 but not
                2011
-   **SI6 (MI4)**
    -   F60
        -   **watsa_table.vi8:** PBF in year1/2011; glandArea 2011 = 207
            mm2; nippleLength = 4.3 mm
        -   **watsa_table.vi13:** PBF in year1/2011 and year2/2012; 2012
            notes "gives birth to twins and then dies"
        -   animalID 113/LPO based on capData; only entry for 2011,
            glandArea and nippleLength matches
    -   F61
        -   **watsa_table.vi9:** SBF in year1/2011; glandArea 2011 = 133
            mm2
        -   **watsa_table.vi13:** SBF in 2011; "F61 dispersed in August
            [2011]"
        -   animalID 114/LPW based on capData; only entry is for 2011,
            glandArea matches
    -   M60
        -   **watsa_table.vi10:** PBM in 2011/year1 & 2012/years (both
            in si6); glandArea 2011 = 123 mm2, 2012 = 160 mm2
            **watsa_table.vi13:** "M60 and M61 both disperse into SI3,
            M61 is successful, M60 is displaced and disappears"
        -   animalID 78/LBG based on capData; entries for 2011 & 2012
            w/matching glandArea
    -   M61
        -   **watsa_table.vi10:** PBM for two year2/2012 entries - one
            si3 and one si6; successfully dispersed to SI3; glandArea
            144 mm2 in both
        -   **watsa_table.vi11:** SBM in year1/2011 (in si6); glandArea
            43 mm2
        -   **watsa_table.vi13:** "M60 and M61 both disperse into SI3,
            M61 is successful, M60 is displaced and disappears"
        -   animalID 23/LBR based on capData; glandArea match for both
            2011 and 2012

```{r}
# 2010 capData entries start w/rowID 12 to 49
# 2011 capData entries start w/rowID 50 to 91
# 2012 capData entries start w/rowID 92 to 150
# 2013 capData entries start w/rowID 151

View(capData_byIndiv_v5 %>%
#       filter(groupName == "MI4") %>%
#       filter(sex == "F") %>%
       filter(as.character(animalID) == "102") %>%
#       filter(as.character(animalID) %in% c("120", "121")) %>%
#       filter(rowID <= 150) %>%
#       filter(rowID >= 92) %>%
       arrange(animalID, captureDate))
```

#### watsaDiss_groupKey

```{r}
watsaDiss_groupKey <- data.frame(
  temp = c(
    "SF1 - FC",
    "SF2 - Jf",
    "SF3 - Perro6",
    "SF4 - AR6",
    "SF5 - WhiteSf",
    "SF6 - CL3",
    "SF7 - Bloopers",
    
    # SIMP
    "SI1 - WhiteEmps",
    "SI2 - Ji",
    "SI3 - IC",
    "SI4 - OrangeEmps",
    "SI5 - DangerousPeople",
    "SI6 - MI4"
  )
) %>%
  separate("temp", into = c("groupName_diss", "groupName"))
```

#### watsaDiss_indivKey

```{r}
watsaDiss_indivKey <- data.frame(
  temp = c(
    # LWED groups
    ## sf1 - FC
    "LWED - SF1 - F10 - 117",
    "LWED - SF1 - F11 - 76",
    "LWED - SF1 - F12 - 101",
    "LWED - SF1 - F13 - 7",
    "LWED - SF1 - F14 - 75",
    "LWED - SF1 - F15 - 77",
    ## sf2 - Jf
    "LWED - SF2 - F20 - 120",
    "LWED - SF2 - F21 - 121",
    "LWED - SF2 - F22 - 105",
    "LWED - SF2 - F23 - 30",
    "LWED - SF2 - F24 - 111",
    "LWED - SF2 - M22 - 29",
    ## sf3 - Perro6
    "LWED - SF3 - F30 - 115", # also in Loners & Angels
    "LWED - SF3 - F31 - 123",
    "LWED - SF3 - M32 - 125",
    "LWED - SF3 - M33 - 126",
    ## sf4 - AR6
    "LWED - SF4 - F41 - 90",
    "LWED - SF4 - F42 - 128",
    "LWED - SF4 - F43 - 71",
    "LWED - SF4 - M43 - 26",
    "LWED - SF4 - M44 - 27",
    "LWED - SF4 - M45 - 70",
    ## sf5 - WhiteSf
    "LWED - SF5 - F50 - 41",
    "LWED - SF5 - F51 - 131",
    "LWED - SF5 - F53 - 85",
    "LWED - SF5 - M51 - 83",
    ## sf6 - CL3
    "LWED - SF6 - F60 - 66",
    "LWED - SF6 - F61 - 67",
    ## sf7 - Bloopers
    "LWED - SF7 - F70 - 97",
    "LWED - SF7 - F71 - 63",
    "LWED - SF7 - F72 - 61",
    "LWED - SF7 - M71 - 60",
    "LWED - SF7 - M72 - 62",
    
    # SIMP groups
    ## sSI1 - WhiteEmps
    "SIMP - SI1 - M12 - 55",
    "SIMP - SI1 - M13 - 93",
    ## SI2 -Ji
    "SIMP - SI2 - F21 - 36",
    "SIMP - SI2 - M23 - 102",
    "SIMP - SI2 - F22 - 34",
    "SIMP - SI2 - F23 - 80",
    ## SI3 - IC
    "SIMP - SI3 - F30 - 24",
    "SIMP - SI3 - F32 - 79",
    "SIMP - SI3 - M31 - 106",
    "SIMP - SI3 - M32 - 22",
    "SIMP - SI3 - M33 - 1",
    ## SI4 - OrangeEmps
    "SIMP - SI4 - F40 - 109",
    "SIMP - SI4 - F43 - 92",
    ## SI5 - DangerousPeople
    "SIMP - SI5 - F51 - 89",
    "SIMP - SI5 - F52 - 87",
    "SIMP - SI5 - F53 - 88",
    ## SI6 - tbd
    "SIMP - SI6 - F60 - 113",
    "SIMP - SI6 - F61 - 114",
    "SIMP - SI6 - M60 - 78",
    "SIMP - SI6 - M61 - 23"
  )
) %>%
  separate("temp", into = c("species", "groupName_diss", "dissID", "animalID"), sep = " - ") %>%
  merge(., watsaDiss_groupKey[, c("groupName_diss", "groupName")], by = "groupName_diss", all.x = T) %>%
  select(species, dissID, animalID, groupName_diss, groupName) %>%
  arrange(species, dissID)
```

### watsa_table.vi1 (p. 120-121)

Mini has Table IV.1 divided into A (for LWED) and B (for SIMP); I'm
combining them into one table below.

**Note** that in this table, year1 = 2010; year2 = 2011; year3 = 2012

**Appendix IV.1A,B Known ages or estimated exact ages for individuals \<
1 year of age of A) Saguinus fuscicollis & B) Saguinus imperator,
organized by group.** (p. 120-121)

Notes from the dissertation: - The exact birthdate is known for sf_F12 &
sf_F13, 12/23/2009 - "Estimated ages are taken as the lower of the
age-bracket values for each animal, since F12 and F13 with known ages
align to this pattern." (p. 120) - "[si\_]F53 was not trapped in the
first year of her birth, but was captured the next year and is most
likely the twin of [si\_]F52." (p. 121)

```{r}
watsa_table.vi1 <- data.frame(
  # LWED data (p. 120)
  F12_LWED = c("2009-12-17", "0", "1"),
  F13_LWED = c("2009-12-17", "0", "1"),
  
  F14_LWED = c("2012-06-08", "7.25 to 9.75", "7.25"),
  F15_LWED = c("2012-06-08", "7.25 to 9.75", "7.25"),
  
  F23_LWED = c("2011-04-24", "3 to 4.5", "3"),
  F24_LWED = c("2011-04-24", "3 to 4.5", "3"),
  
  M22_LWED = c("2012-06-30", "5.75 to 7.25", "5.75"),
  
  M32_LWED = c("2010-05-05", "4.5 to 5.75", "4.5"),
  M33_LWED = c("2010-05-05", "4.5 to 5.75", "4.5"),
  
  M43_LWED = c("2011-04-11", "5.75 to 7.25", "5.75"),
  F43_LWED = c("2011-04-11", "5.75 to 7.25", "5.75"),
  
  M44_LWED = c("2012-06-20", "9.75 to 11.25", "9.75"),
  M45_LWED = c("2012-06-20", "9.75 to 11.25", "9.75"),
  
  M51_LWED = c("2010-06-28", "5.75 to 7.25", "5.75"),
  
  F53_LWED = c("2012-06-16", "7.25 to 9.75", "7.25"),
  
  F60_LWED = c("2012-06-25", "9.5 to 9.75", "9.5"),
  
  M71_LWED = c("2012-07-06", "9.75 to 11.25", "9.75"),
  M72_LWED = c("2012-07-06", "5.75 to 7.25", "5.75"),
  
  # SIMP data (p. 121)
  M12_SIMP = c("2012-06-24", "7.25 to 9.75", "7.25"),
  M13_SIMP = c("2012-06-24", "7.25 to 9.75", "7.25"),
  
  F21_SIMP = c("2011-04-17", "1.5 to 3", "1.5"),
  M23_SIMP = c("2011-04-17", "1.5 to 3", "1.5"),
  
  F22_SIMP = c("2012-06-13", "7.25 to 9.75", "7.25"),
  F23_SIMP = c("2012-06-13", "7.25 to 9.75", "7.25"),
  
  F32_SIMP = c("2012-06-10", "7.25 to 9.75", "7.25"),
  M33_SIMP = c("2012-06-10", "7.25 to 9.75", "7.25"),
  
  F40_SIMP = c("2011-04-22", "5.25 to 5.75", "5.25"),
  F43_SIMP = c("2011-04-22", "5.25 to 5.75", "5.25"),
  
  F52_SIMP = c("2011-05-04", "5.25 to 5.75", "5.75"),
  F53_SIMP = c("notTrapped", "NA", "5.75")
) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("dissID") %>%
  dplyr::rename(
    "date" = "V1",
    "ageRange_months" = "V2",
    "ageEst_months" = "V3"
  ) %>%
  separate("dissID", into = c("dissID", "species")) %>%
  merge(., watsaDiss_indivKey, by = c("dissID", "species"), all.x = T) %>%
  relocate(c(species, dissID, animalID)) %>%
  arrange(species, dissID)
```

### watsa_table.vi3 (p. 198)

**Table VI. 3: Infant births and survivorship of Saguinus fuscicollis
and Saguinus imperator across the study period.**

**NOTE** watsa_table.iv1 has F52 & F53, but this table has F51. Not sure
why F52 & F53 aren't included?

```{r}
watsa_table.vi3 <- data.frame(
  dissID = c("F12",
             "F13" ,
             "F14",
             "F15",
             "F23",
             "F24",
             "M22",
             "M32",
             "M33",
             "M43",
             "F43",
             "M44",
             
             "M45",
             "M51",
             "F53",
             "F60",
             "M71",
             "M72",
             
             # SIMP
             "M12",
             "M13",
             "F21",
             "M23",
             "F22",
             "F23",
             "F32",
             "M33",
             "F40",
             "F43",
             "F51"),
  birthdate_est = c("2009-Nov",
                    "2009-Nov",
                    "2011-Sep",
                    "2011-Oct",
                    "2010-Jan",
                    "2010-Jan",
                    "2012-Jan",
                    "2009-Dec",
                    "2009-Dec",
                    "2010-Oct",
                    "2010-Oct",
                    "2011-Sep",
                    
                    "2011-Sep",
                    "2010-Jan",
                    "2011-Nov",
                    "2011-Sep",
                    "2011-Sep",
                    "2011-Jan",
                    
                    # SIMP
                    "2011-Nov",
                    "2011-Nov",
                    "2011-Mar",
                    "2011-Mar",
                    "2011-Nov",
                    "2011-Nov",
                    "2011-Nov",
                    "2011-Nov",
                    "2010-Nov",
                    "2010-Nov",
                    "2010-Nov"),
  age_mon = c("7.25",
              "7.25",
              "7.25",
              "8",
              "3",
              "3",
              "5.75",
              "4.5",
              "4.5",
              "5.75",
              "5.75",
              "9.75",
              
              "9.75",
              "5.75",
              "7.25",
              "9.5",
              "9.75",
              "5.75",
              
              #SIMP
              "7.25",
              "7.25",
              "1.5",
              "1.5",
              "7.25",
              "7.25",
              "7.25",
              "7.25",
              "5.25",
              "5.25",
              "5.75"),
  survival_1yr = c("yes",
                   "yes",
                   "tbd",
                   "tbd",
                   "yes",
                   "dead",
                   "tbd",
                   "dead",
                   "dead",
                   "yes",
                   "yes",
                   "tbd",
                   
                   "tbd",
                   "yes",
                   "tbd",
                   "tbd",
                   "tbd",
                   "tbd",
                   
                   # SIMP
                   "tbd",
                   "tbd",
                   "yes",
                   "dead",
                   "tbd",
                   "tbd",
                   "unk",
                   "tbd",
                   "dead",
                   "yes",
                   "yes"),
  comments = c("Dispersing by 30 mo of age",
               "SBF in natal group at 30 mo",
               "F14 and F15 display unequal development (F14 slightly older than F15), survived to ca. 10 mo",
               "F14 and F15 display unequal development (F14 slightly older than F15), survived to ca. 10 mo",
               "In natal group at 30 mo of age",
               "Disappeared from group by 2011",
               "Survived to minimum of 7 mo",
               "Died during July 2010 friaje",
               "Died during July 2010 friaje",
               "In natal group at 21 mo of age",
               "In natal group at 21 mo of age",
               "Survived to minimum of 10 mo",
               
               "Survived to minimum of 10 mo",
               "In natal group at 30 mo of age",
               "Survived to minimum of 8 mo",
               "Survived to minimum of 10 mo",
               "Survived to minimum of 10 mo",
               "Survived to minimum of 6 mo",
               
               # SIMP
               "Survived to minimum of 8 mo",
               "Survived to minimum of 8 mo",
               "Dispersal attempts at 17 mo of age",
               "Disappeared from natal group",
               "Survived to minimum of 8 mo",
               "Survived to minimum of 8 mo",
               "Disappeared, possibly dispersed",
               "Survived to minimum of 8 mo",
               "Disappeared from group by 2012",
               "In natal group at 20 mo of age",
               "Died soon after second capture"),
  species = c(rep("LWED", 18), rep("SIMP", 11))
) %>%
  # add animalIDs
  merge(., watsaDiss_indivKey[, c("animalID", "dissID", "species")], by = c("dissID", "species"), all.x = T) %>%
  relocate(animalID) %>%
  arrange(species, dissID)
```

### watsa_table.vi4 (p. 205)

Mini's diss on p. 205 has a table w/comments that include deaths - this
table also includes reproductive measures and scores for all primary
breeding females

**Table VI.4: Reproductive measures and scores for all primary breeding
females in groups of Saguinus fuscicollis** PBF = Primary Breeding
Female SBF = Secondary Breeding Female OAd = Older adult Ad = Adult YAd
= Young adult \*\*Measurement not taken ? = Uncertainty as to the number
of primary vs. secondary breeding individuals there are in the group

```{r}
# LWED - primary breeding females
watsa_table.vi4 <- t(as.matrix(read.csv("./paper3_demographics/01_dataOrganization/01_dataOriginal/Watsa_2013_tableVI4.csv", header = F))) %>%
  t() %>%
  as.data.frame() %>%
  mutate(
    temp = rep(1:20, each = 13)
  ) %>%
  mutate(
    colnames = rep(c("PBF", "year", "groupName_diss", "age", "vulvaScore", "glandScore", "vulvaIndex_mm", "glandArea_mm2", "nippleLength", "total_SBFs", "total_maleMates", "repOutput", "comments"), 20)
  ) %>%
  pivot_wider(id_cols = temp,
              values_from = V1,
              names_from = colnames) %>%
  select(-temp) %>%
  # add groupName
  merge(., watsaDiss_groupKey, by = "groupName_diss", all.x = T) %>%
  relocate(c(groupName_diss, groupName), .after = year) %>%
  # add animalID
  merge(., watsaDiss_indivKey[, c("dissID", "groupName_diss", "animalID")], by.x = c("PBF", "groupName_diss"), by.y = c("dissID", "groupName_diss"), all.x = T) %>%
  relocate(animalID) %>%
  arrange(PBF, year)
```

### watsa_table.vi5 (p. 206)

**Table VI.5: Reproductive measures and scores for all secondary
breeding females in groups of Saguinus fuscicollis** SBF = Secondary
Breeding Female; PBF = Primary Breeding Female Fertility = Likely if
vulvar index is \> or close to 19 Parity = Nulliparous if nipple length
is  3.0 mm

```{r}
# LWED - secondary breeding females
watsa_table.vi5 <-  t(as.matrix(read.csv("./paper3_demographics/01_dataOrganization/01_dataOriginal/Watsa_2013_tableVI5.csv", header = F))) %>%
  t() %>%
  as.data.frame() %>%
  mutate(
    temp = rep(1:4, each = 13)
  ) %>%
  mutate(
    colnames = rep(c("SBF", "year", "groupName_diss", "age", "vulvaScore", "glandScore", "vulvaIndex_mm", "glandArea_mm2", "nippleLength", "PBF", "fertility", "parity", "comments"), 4)
  ) %>%
  pivot_wider(id_cols = temp,
              values_from = V1,
              names_from = colnames) %>%
  select(-temp) %>%
  # add groupName
  merge(., watsaDiss_groupKey, by = "groupName_diss", all.x = T) %>%
  relocate(c(groupName_diss, groupName), .after = year) %>%
  # add animalID
  merge(., watsaDiss_indivKey[, c("dissID", "groupName_diss", "animalID")], by.x = c("SBF", "groupName_diss"), by.y = c("dissID", "groupName_diss"), all.x = T) %>%
  relocate(animalID) %>%
  arrange(SBF, year)
```

### watsa_table.vi6 (p. 207)

**Table VI.6: Reproductive measures and scores for all primary breeding
males in groups of Saguinus fuscicollis** PBM = Primary Breeding Male
Grp = Group Name Scrot Score = Scrotal Score (chapter V) Glnd Score =
Suprapubic gland score (chapter V) TVol. = Testicular volume (mm3) Gld
Area = suprapubic gland area (mm3) Tot \# mates = Total number of
fertile females (primary or secondary breeding females) available to
mate with

Mated with = The IDs of females observed mating with the male in
question. Note: Mating is a rare behavior so the absence of evidence
here is not evidence of nonbreeding status Shared mates with = The IDs
of reproductively active males that share access to the fertile females
in a group, with whom mating opportunities must be shared or competed
for \* Measures not available because animals were either not captured
that season (as is the case with Group SF5 in 2011) or specific
measurements were not recorded due to time constraints during capture

```{r}
# LWED - primary breeding males
watsa_table.vi6 <-  t(as.matrix(read.csv("./paper3_demographics/01_dataOrganization/01_dataOriginal/Watsa_2013_tableVI6.csv", header = F))) %>%
  t() %>%
  as.data.frame() %>%
  mutate(
    temp = rep(1:28, each = 12)
  ) %>%
  mutate(
    colnames = rep(c("PBM", "year", "group", "age", "scrotScore", "glandScore", "tVol_mm3", "glandArea_mm2", "total_mates", "matedWith", "shared_matesWith", "comments/paternity"), 28)
  ) %>%
  pivot_wider(id_cols = temp,
              values_from = V1,
              names_from = colnames) %>%
  select(-temp)
```

### watsa_table.vi10 (p. 212)

Table VI. 10: Reproductive measures and scores for all primary breeding
males in groups of Saguinus imperator

```{r}

```

## 8.2 birthYear_est

For parentage and sibship estimates, I'll be using the program FRANz.
This program can incorporate birth and death years to improve estimates
-- death years will be tricky (aside from the individual who died during
capture), but I should be able to add birth years for a decent set of
individuals.

For the sake of time, for now I'm only going to work with my tamRun5
individuals - I can go back and do the others later.

In tamRun5, I have n = 244 individuals.

### 8.2.1 Background info

#### CICRA mating/birth seasons

((all info is from Mini's dissertation unless otherwise noted))

MATING SEASON

-   April-Sep = dry season = most likely mating season

BIRTH SEASON

-   LWED = Aug-Feb (most in Oct, Dec, Jan)
-   SIMP = Nov-March (most in Nov, Dec)

According to Mini's dissertation:

-   LWED cheek patches are present up to \~7 months; fully adult facial
    coloration at 10 months
-   LWED body mass = \~154 g by 3 months; \~230 g by 6 months; \~320 g
    by 12 months
-   SIMP body mass = \~200 g by 3 months; \~290 g by 6 months; \~563 g
    by 12 months
-   SEE PAGE 95 FOR ADAPTATION OF GLASSMAN + SOINI DENTITION/AGE
    ESTIMATES (mini says she used Glassman's estimates for indivs in her
    study \<1 year old); p.99 Table IV.1D has info on canine length vs.
    months of age
-   p\. 113 says that ages of twins 7/101 (whose birthdate is known)
    "were routinely overestimated based on published schedule for
    captive-raised animals, with the actual age falling at or just below
    the lower end of the age-bracket provided by Glassman (1983)
    (Appendix IV.1A) **[[maybe this is b/c Mini converted Glassman's
    weeks to months by taking weeks/4, while I think it's more accurate
    to do (weeks\*7)/30, which gives a lower number]]**

#### Teeth eruption schedule

Mini uses Glassman's (1983) teeth eruption schedule for her ageing
estimates. In comparing estimates obtained via this schedule vs. data
from two individuals (animalIDs 7 & 101) with a known birth date,
however, she notes that their ages "were routinely overestimated based
on published schedule for captive-raised animals, with the actual age
falling at or just below the lower end of the age-bracket provided by
Glassman (1983) (Appendix IV.1A)" (p. 113). **However, I think this may
be because she converted Glassman's weeks to months by taking (weeks/4)
-- I think it's more accurate to do ((weeks x 7)/30), which gives a
lower number.**

------------------------------------------------------------------------

According to Glassman (1983), saddleback tamarin teeth erupt along the
following schedule:

|            | I1    | I2    | C     | M1      | M2  | M3   |
|------------|-------|-------|-------|---------|-----|------|
| maxillary  | birth | birth | birth | 2       | 2-5 | 6-12 |
| mandibular | birth | birth | birth | birth-2 | 2-5 | 5-8  |

: Table II. Age of eruption of deciduous teeth in Saguinus fuscicollis
in weeks

|            | I1    | I2    | C     | P2    | P3    | P4    | M1    | M2    |
|------------|-------|-------|-------|-------|-------|-------|-------|-------|
| maxillary  | 21-23 | 23-29 | 39-45 | 32-39 | 38-39 | 29-39 | 18-23 | 29-39 |
| mandibular | 21-23 | 23-29 | 39-45 | 32-39 | 37-39 | 29-39 | 16-23 | 29-31 |

: Table III. Age of eruption of permanent teeth in Saguinus fuscicollis
in weeks

Week-day-month conversions:

-   2 weeks = 14 days
-   5 weeks = 35 days; 1.2 months
-   12 weeks = 84 days; 2.8 months
-   39 weeks = 273 days; 9.1 months [miniDiss = 9.8 months)]
-   45 weeks = 315 days; 10.5 months [miniDiss = 11.3 months]

Other notes:

-   all deciduous teeth were erupted by 12 weeks (84 days; 2.8 months)
-   first permanent tooth = M1, erupted b/t 16-23 weeks (112-161 days)
-   permanent dentition fully erupted by 45 weeks (315 days; 10.5
    months)
-   permanent canines erupted b/t 39-45 weeks (273-315 days; 9.1-10.5
    months)
-   no premolars when juv; only i1/i2/c/m1/m2/m3 (earliest premolar at
    6.8 months)
-   p2 erupts 32-39 weeks (224-273 days; 7.5-9.1 months)
-   p3 erupts 37-39 weeks (259-273 days; 8.6-9.1 months)
-   p4 erupts 29-39 weeks (203-273 days; 6.8-9.1 months)
-   deciduous M1 maxillary erupts at 2 weeks, mandibular at birth-2
    weeks
-   deciduous M2 erupts 2-5 weeks
-   deciduous M3 max erupts 6-12 weeks; M3 mand erupts 5-8 weeks
-   permanent M1 erupts maxillary 18-23 weeks; mandibular 16-23 weeks
    (126-161 days; 4.2-5.4 months)
-   permanent M2 erupts maxillary 29-39 weeks; mandibular 29-31 weeks
    (203-273 days)

Which means that:

-   any individual with all permanent: minAge = captureDate - 315 days
    (date at which permanent dentition is fully erupted)
-   any individual with all deciduous: maxAge = captureDate - 161 days
    (latest date for eruption of first permanent tooth M1)

### 8.2.2 Data

#### md_tamRun5

Latest version of md_tamRun5 (from metadataReconciliation.Rmd file)

```{r}
# latest updated version of md_tamRun5 from metadataReconciliation.Rmd
md_tamRun5_v5 <- read.csv("./metadataReconciliation/tamRun5_metadata_v5.csv")
```

#### capData_byIndiv

Latest version of capData_byIndiv (from current Rmd file) 1) filter to
first capture for each animalID 2) filter again to animalIDs in tamRun5

```{r}
# latest updated version of capData_byIndiv from current rmd
capData_byIndiv_v5 <- read.csv("./paper3_demographics/01_dataOrganization/captureData_byIndividual_v5.csv")

# filter to first capture for each animalID
capData_byIndiv_firstEntry <- capData_byIndiv_v5[match(unique(capData_byIndiv_v5$animalID), capData_byIndiv_v5$animalID),] %>%
  select(rowID, captureDate, animalID, ageClass, animalName1, animalName2, groupName, species, sex, notes_MD, notes_RV)

# filter animalIDs in tamRun5
capData_byIndiv_firstEntry_tamRun5 <- capData_byIndiv_firstEntry %>%
  filter(animalID %in% md_tamRun5_v5$animalID)
```

#### capData_dentAgeDoc

I found the document 'Saguinus dentition and ageing.doc' from Google
Drive /01_dataOrganization/dataFiles_original/2009-2010_trapping/animal
Data/Saguinus dentition and ageing.doc. This document contains age info
based on dentition for individuals captured in 2009 and 2010.

To make this document more easily useable in the present context, I
created a csv file from the original doc and manually separated out the
group and animal names, adding group names when missing
(capData_saguinusDentAgeDoc_2009to2010_rvUpdates.csv). Below I'm
creating "v2" of this csv file by adding animalIDs and reformatting
slightly. I'm also creating a separate dataframe that filters out the
first entry per animalID.

```{r}
# import 'Saguinus dentition and ageing.doc', add animalIDs & reformat
capData_dentAgeDoc <- read.csv("./paper3_demographics/01_dataOrganization/capData_saguinusDentAgeDoc_2009to2010_rvUpdates.csv", na.strings = "") %>%
  # format date as date
  mutate(
    captureDate = mdy(Date)
  ) %>%
  relocate(captureDate, .after = animalName) %>%
  # add animalIDs by animalName1
  merge(., capData_byIndiv_v5[, c("captureDate", "animalID", "animalName1")], by.x = c("captureDate", "animalName"), by.y = c("captureDate", "animalName1"), all.x = T) %>%
  # add animalIDs by animalName2
  merge(., capData_byIndiv_v5[, c("captureDate", "animalID", "animalName2")], by.x = c("captureDate", "animalName"), by.y = c("captureDate", "animalName2"), all.x = T) %>%
  # coalesce animalIDs
  mutate(
    animalID = coalesce(animalID.x, animalID.y),
    .keep = "unused"
    ) %>%
  # reformat things
  select(-Name, -Date) %>%
  relocate(c(animalID, animalName, captureDate, groupName, A, Notes), .before = Microchip) %>%
  dplyr::rename(
    "age" = "A",
    "microchip" = "Microchip",
    "notes" = "Notes") %>%
  arrange(as.numeric(animalID), captureDate)

# export updated copy
write.csv(capData_dentAgeDoc, "./paper3_demographics/01_dataOrganization/capData_saguinusDentAgeDoc_2009to2010_rvUpdates_v2.csv", row.names = F)

# then filter to first entry per animalID
capData_dentAgeDoc_firstEntry <- capData_dentAgeDoc[match(unique(capData_dentAgeDoc$animalID), capData_dentAgeDoc$animalID),]
```

#### watsaDiss_births

**watsa_table.vi1**

In her dissertation, Mini uses Glassman's (1983) teeth eruption schedule
to estimate ages for all individuals in her study set that were \< 1
year old (see pages 120-121). Below I'm creating a dataframe based on
that data to make it more easily useable in the present context. I'm
also adding the animalID to each entry, assigned after checking the date
in Mini's table against capData_byIndiv captureDate records.

Note that Mini has F53 (SIMP) in her table - she notes that "F53 was not
trapped in the first year of her birth, but was captured the next year
and is most likely the twin of F52" (p. 121). Given that only three
individuals from this group were captured the following year (2012), and
animalID 88 (SPW) was the only individual not captured the year prior
(2011), that would suggest that animalID 88 is F53. However, I don't
have any samples for this individual (sampleNotes in xtnMaster_hair say
I couldn't find an envelope for animalID 88/SPW, and longmires weren't
taken before 2013).

```{r}
View(watsa_table.vi1)
```

### 8.2.3 birthYear_est

Maybe should assign birth year for juveniles as like, 1-Jan-xxxx? I'm
thinking here about how the birth season is Aug-Feb (most in Oct, Dec,
Jan) for LWED and Nov-March (most in Nov, Dec) for SIMP. But if FRANz is
just using the year (vs. the date), that might present an issue -- e.g.,
if indiv1 is born late 2010 and indiv2 is born early 2011, FRANz would
say indiv2 is 1 year older than indiv1 even though they're basically the
same age

april-sept = dry season = most likely mating season - indiv1 born late
2010 = birthYear 2010 = age 3 (repMature) in 2013 for FRANz; but in
reality they'd still be immature for 2013's mating season - indiv2 born
early 2011 = birthYear 2011 = age 3 (repMature) in 2014 for FRANz; lines
up better with age relative to mating season/rep maturity

Maybe should just include birth years for juveniles? Specifically,
individuals in capData that are explicitly noted to have deciduous teeth
(or perhaps if permanents are noted as just coming in) -- ageClass is
sometimes noted, but I'm not always confident in its accuracy -
basically, rule would be that if trapping sheet notes something about
deciduous teeth, I would set the estimated birth year to that year
(giving a normalized bday of 1-jan-year).

#### birthYear_v1

Create starting df for birth year estimates

```{r}
# create birth year col & add capData_dentitionAgeing_2009.2010 doc notes
birthYear_capData_tamRun5_v1 <- capData_byIndiv_firstEntry_tamRun5 %>%
  mutate(
    birthYear_est = NA
  ) %>%
  relocate(birthYear_est, .after = ageClass) %>%
  dplyr::rename("age_capData" = "ageClass") %>%
  # merge animalName1/2 into one col
  mutate(
    animalName = case_when(
      is.na(animalName2) ~ animalName1,
      .default = str_c(animalName1, animalName2, sep = "/")
    )
  ) %>%
  
  # add capData_dentAgeDoc_firstEntry
  merge(., capData_dentAgeDoc_firstEntry[, c("animalID", "age", "notes")], by = "animalID", all.x = T) %>%
  dplyr::rename("age_dentAgeDoc" = "age",
                "notes_dentAgeDoc" = "notes") %>%
  
  # add watsa_table.vi1 (birthdate/age estimates)
  merge(., watsa_table.vi1[, c("animalID", "date", "ageEst_months")], by.x = c("animalID", "captureDate"), by.y = c("animalID", "date"), all.x = T) %>%
  dplyr::rename("age_watsaDiss_months" = "ageEst_months") %>%

  # reformat a bit
  select(rowID,
         groupName,
         species,
         animalID,
         animalName,
         captureDate,
         birthYear_est,
         age_capData,
         age_dentAgeDoc,
         age_watsaDiss_months,
         notes_RV, 
         notes_dentAgeDoc,
         notes_MD) %>%
    arrange(rowID)
```

```{r}
# export for records
write.csv(birthYear_capData_tamRun5_v1, "./paper3_demographics/01_dataOrganization/birthAssignments_capData_tamRun5_v1.csv", row.names = F)
```

#### birthYear_v2

First I'm going to add birth year estimates based on the following:

1)  For birth dates already assigned in watsaDiss, assign birth year as
    that of 1-Jan for that birth season
2)  For entries in which notes_RV mention "deciduous" or "baby", assign
    birth year as 1-Jan of their captureDate (any indiv that still has
    deciduous teeth would have to have been born in that year's birth
    season (vs. the one prior); as such, their birthDate_est can be set
    to Jan 1st of their captureDate); also note that I checked to see if
    any captures occurred after august (bc then the birthYear would need
    to be that of the following year), but all good

This leaves us with 39 entries that have not been assigned a
birthYear_est, but are noted as "juvenile" in capData - I'm going to go
through these manually in excel

```{r}
birthYear_capData_tamRun5_v2 <- birthYear_capData_tamRun5_v1 %>%
  # add birthYear_est based on miniDiss
  mutate(
    birthDate_est = NA,
    age_watsaDiss_months = as.numeric(age_watsaDiss_months)
  ) %>%
  relocate(birthDate_est, .before = birthYear_est) %>%
  mutate(
    birthDate_est = as.Date(captureDate) - (age_watsaDiss_months*30)
  ) %>%
  mutate(
    # round to nearest year (Jan 1st of whatever year)
    birthYear_est = case_when(
      !is.na(age_watsaDiss_months) ~ round_date(as.Date(birthDate_est), "year")
    ),
    # convert to character & subset string to year only
    birthYear_est = substr(as.character(birthYear_est), 1, 4)
  ) %>%
  
  # add birthYear_est based on "deciduous" or "baby" in notes_RV
  mutate(
    birthYear_est = case_when(
      is.na(age_watsaDiss_months) & str_detect(notes_RV, "decid") ~ substr(as.character(captureDate), 1, 4),
      is.na(age_watsaDiss_months) & str_detect(notes_RV, "baby") ~ substr(as.character(captureDate), 1, 4),
      .default = birthYear_est
    )
  )

birthYear_capData_tamRun5_v2 %>%
  filter(age_capData == "juvenile") %>%
  filter(is.na(birthYear_est)) %>%
  nrow()
```

```{r}
# export to work w/this in excel
library(xlsx)
#write.xlsx(birthYear_capData_tamRun5_v2, "./paper3_demographics/01_dataOrganization/birthDeathAssignments_capData_tamRun5_v2.xlsx", row.names = F)
```

#### birthYear_v3

Below I'm going through the 39 entries that are designated as "juvenile"
in capData, but could not be confirmed as such through Mini's
dissertation or via notes_RV confirming the presence of "deciduous" or
"baby" teeth.

For each entry, I'm doing the following checks to confirm their juvenile
designation: 1) Check notes_RV for dentition notes that confirm juvenile
dentition outside of "deciduous" or "baby" 2) Double check trapping
sheets to ensure that there werent dentition notes that I had missed
(and fill in on google sheet if I did) 3) Check notes_RV for
non-dentition confirmation of juvenile status 4) Checking trapping
reports for confirmation of juvenile status

In doing so, I was able to confirm juvenile status (and thus assign
birthYear_est) for 38/39 individuals. The only individual whose juvenile
designation is likely incorrect is rowID 1/GBR/animalID 100 - despite
being listed as juvenile, Animal Pic Log_7-21-10 and notes_dentAgeDoc
suggest subadult to young adult.

This gives a total of n = 121 juveniles with birthYear_est confirmed.

```{r}
# rowIDs for entries whose notes_RV don't mention "decid"/"baby", but can be otherwise confirmed as juveniles
rowIDs_capData_manualChecks_forJuvs <- c(
  # notes_RV make other mention of juvenile dentition (besides decid/baby)
  "185",
  "227",
  "242",
  "266",
  "325",
  "424",
  "426",
  "585",
  # trapSheet confirms juv dentention, but missing from notes_RV (now added to google sheet)
  "180",
  "196",
  "203",
  "280",
  "492",
  # notes_RV otherwise confirms juvenile (aside from dentition)
  "452",
  "474",
  "500",
  # trapReport confirms juvenile
  "166",
  "168",
  "190",
  "197",
  "205",
  "218",
  "353",
  "354", # 354 confirmed w/weight & context clues in report
  "360",
  "365",
  "370",
  "371", # 371 confirmed w/weight & context clues in report
  "373", # 373 based on weight only
  "376", # 375 confirmed w/weight & context clues in report
  "392",
  "393",
  "449",
  "465",
  "570",
  "580",
  # trapSheets & trapReports missing; going to assume "juv" designation is correct
  "530",
  "533"
)

birthYear_capData_tamRun5_v3 <- birthYear_capData_tamRun5_v2 %>%
  mutate(
    birthYear_est = case_when(
      is.na(age_watsaDiss_months) & as.character(rowID) %in% rowIDs_capData_manualChecks_forJuvs ~ substr(as.character(captureDate), 1, 4),
      .default = birthYear_est
    )
  )

# n = 121 individuals w/birthYear assigned
View(birthYear_capData_tamRun5_v3 %>%
  filter(!is.na(birthYear_est))) %>%
  select(animalID) %>%
  distinct() %>%
  nrow()

# only indiv marked as juv but likely not a juve = rowID 1/animalID 100
birthYear_capData_tamRun5_v3 %>%
       filter(age_capData == "juvenile") %>%
  filter(is.na(birthYear_est))
```

##### Export

```{r}
write.csv(birthYear_capData_tamRun5_v3, "./paper3_demographics/01_dataOrganization/birthAssignments_capData_tamRun5_v3.csv", row.names = F)
```

#### birthYear_v4 [NOT FINISHED- necessary?]

According to Mini's dissertation:

-   LWED cheek patches are present up to \~7 months; fully adult facial
    coloration at 10 months
-   LWED body mass = \~154 g by 3 months; \~230 g by 6 months; \~320 g
    by 12 months
-   SIMP body mass = \~200 g by 3 months; \~290 g by 6 months; \~563 g
    by 12 months

For checks, I'm doing the following:

-   LWED: ((320-230)/2)+230 = 275 cutoff
-   SIMP: ((563-290)/2)+290 = 426.5 \>\> 427 cutoff

Check weights

```{r}
birthYear_capData_tamRun5_v4 <- birthYear_capData_tamRun5_v3 %>%
  merge(., capData_byIndiv_v5[, c("rowID", "weightTotal", "weightBag", "weightAnimal")], by = "rowID", all.x = T) %>%
  mutate(
    weightTotal = as.numeric(weightTotal),
    weightBag = as.numeric(weightBag),
    weightAnimal = weightTotal - weightBag
  )

lwedJuvs_byWeight <- birthYear_capData_tamRun5_v4 %>%
  filter(species == "LWED") %>%
  filter(weightAnimal < 275)

simpJuvs_byWeight <- birthYear_capData_tamRun5_v4 %>%
  filter(species == "SIMP") %>%
  filter(weightAnimal < 427)

View(simpJuvs_byWeight %>%
       filter(age_capData != "juvenile"))

# rowIDs & notes
simpJuvs_byWeight_nonJuvChecks <- c(
  "56 - trapReport says fully matured",
  "231 - trapReport says has all perm teeth, but weight of 390 seems low for an adult simp...",
  "514 - trapReport only refers to him as adult male, no good details on teeth or anything else, but weight of 350 seems v low for adult simp"
)
```

## 8.3 deathYear_est

### 8.3.1 Data

#### capData

One individual died during trapping in 2012; rowID 118, animalID 87 -
this individual is present in the tamRun5 dataset

```{r}
View(capData_byIndiv_v5 %>%
       filter(str_detect(notes_RV, "(?i)death", )))

View(md_tamRun5_v3 %>%
       filter(animalID %in% 87))
```

#### animalPicLog

(on google drive 2009-2010 trapping folder: Animal Pic Log_7-21-10)

-   In Animal Pic Log_7-21-10, GBW [animalID 118] noted as "deceased?
    Was a major player because he refused to be trapped for a long
    while. He watched the twins while others would enter traps Went
    missing 01/18/10" (p. 5)
-   animalPicLog notes that BBO [animalID 119] was hella old, age listed
    as "estimate 6-8 years or older, now dead) -- can't find a date for
    death though, maybe 2010? \>\> go with 2010

#### watsaDiss_deaths

**watsa_table.vi2_deaths (p. 196)**

F10 from group SF1 listed as dead as of 2011 (confirmed in-text p.
220) - F10 = animalID 117

**watsa_table.vi3_deaths**

111 - dead by 2011 125 - dead july 2010 126 - dead july 2010 109 -
dead/disappeared from group by 2012 89 - dead soon after second capture
[in 2012] 102 - dead/disappeared from natal group [in 2011?]

```{r}
watsa_table.vi3_deaths <- watsa_table.vi3 %>%
  mutate(
    temp = case_when(
      str_detect(comments, "(?i)die") ~ "dead",
      survival_1yr == "dead" ~ "dead",
      .default = NA
    )
  ) %>%
  filter(temp == "dead")
```

**watsa_table.vi4_deaths**

Subset to entries mentioning deaths in notes

-   F21 = "Both females die after a friaje" - I don't know what this
    means, is F21 dead? \>\> yes; both F20 and F21 are dead ((F20 =
    animalID 120, F21 = animalID 121))
-   F31 = "Group dies after a friaje" - does this mean that all of
    Perro6 is dead?? \>\> yes, looks like Perro6 only has captureDate
    entries in 2010, so I guess that does indeed mean that all of those
    individuals died EXCEPT for F30/115 - found her w/additional entries
    -   put deathYear_est as 2011

Note that this info on deaths is confirmed by **table_vi12 (p. 221)**;
column "demographic events" notes:

-   LWED F20 & F21 from SF2 (Jf) BOTH die during friaje
-   All of SF3 (Perro6) killed by friaje

Other notes of interest from table_vi12:

-   Both females in SF1 (FC) (F10 & F11) nursed infants
-   Multiple primary females in SF5, unable to identify mother

```{r}
watsa_table.vi4_deaths <- watsa_table.vi4 %>%
  filter(str_detect(comments, "(?i)die"))

# all of Perro6 really died? yes, appears so - only captureDate entries in 2010 >> EDIT: all *except* F30/animalID 115, who disperses to Angels/Loners
View(capData_byIndiv_v5 %>%
       filter(groupName == "Perro6"))
View(capData_byIndiv_v5 %>%
       filter(as.character(animalID) %in% c("122", "124", "123", "125", "126", "115")))
```

**watsa_table.vi13_deaths (p. 223)**

Notes from "demographic events" column:

-   F52_SI5 died post-trapping \>\> animalID 87 (see miniDiss_indivKey)
-   F60_SI6 gives birth to twins and then dies \>\> animalID 113 (see
    miniDiss_indivKey)
    -   notes on death are listed w/year2 (2011); table.vi10 notes that
        group splinters in year2 after PBF death; seems like 2012 is the
        year of death?

Other notes here might also come in handy (dispersal events, etc.)

### 8.3.2 deathYear_v1

```{r}
deathYear_capData_tamRun5_v1 <- capData_byIndiv_firstEntry_tamRun5 %>%
  mutate(
    deathYear_est = NA
  ) %>%
  relocate(deathYear_est, .after = ageClass) %>%
  mutate(
    deathYear_est = case_when(
      # watsa_table.vi2_deaths
      as.character(animalID) == "117" ~ 2011, # listed as dead in table as of 2011
      
      # watsa_table.vi3_deaths
      as.character(animalID) == "111" ~ 2011, # disappeared from group by 2011
      as.character(animalID) == "125" ~ 2010, # died during july 2010 friaje
      as.character(animalID) == "126" ~ 2010, # died during july 2010 friaje
      as.character(animalID) == "109" ~ 2012, #  disappeared from group by 2012
      as.character(animalID) == "89" ~ 2012, # died soon after second capture
      as.character(animalID) == "102" ~ 2011, # disappeared from natal group
      
      # watsa_table.vi4_deaths (confirmed w/table.vi12)
      groupName == "Perro6" & as.character(animalID) != "115" ~ 2011, # all Perro6 (EXCEPT F30/115) died during 2010 friaje
      as.character(animalID) == "120" ~ 2010, # died during 2010 friaje
      as.character(animalID) == "121" ~ 2010, # died during 2010 friaje
      
      # watsa_table.vi13_deaths
      as.character(animalID) == "87" ~ 2012, # died during 2012 trapping
      as.character(animalID) == "113" ~ 2012, # died after giving birth to twins [twins = F32/M33] (twins born late 2011, but survive to 2012 so assign death as 2012)
      
      # animalPicLog
      as.character(animalID) == "119" ~ 2010, # noted as dead, only trapped in 2009 so assume death by 2010
      
      .default = deathYear_est
    )
  )
```

#### Export

```{r}
write.csv(deathYear_capData_tamRun5_v1, "./paper3_demographics/01_dataOrganization/deathAssignments_capData_tamRun5_v1.csv", row.names = F)
```

## 8.4 Reproduction data

Per Watsa et al. (2017), a female was considered parous if nipple length
\> 3 mm (LWED) or \> 4 mm (SIMP) \>\> in Watsa 2013, specifies that it's
greater or EQUAL to 3 or 4, and that it's the average nipple length (p.
203)

-   study period 2010-2015
-   LWED primary female avg nipple length = 3.41 +/- 0.79 (range
    2.15-5.60)
-   SIMP primary female avg nipple length = 5.15 +/- 0.94 (range
    3.65-7.45)

Watsa (2013) p. 203 has "Recommended Guidelines for Breeding Status"
which is v helpful, then on pages 205-206 has tables w/rep measurements
and scores for all primary breeding females... let's bring that in here
**check miniDiss_ageAssignments to find group, then assign animalID**

### miniDiss_tables

watsa_table.vi4 from above is useful here, as well as tables VI.5
through VI.11

```{r}
watsa_table.vi4
```

## 8.x Fill in bioData

```{r}

```

# Likely twins

Find likely twin pairs

```{r}
twinList <- censusData %>%
  filter(!is.na(animalID)) %>%
  filter(ageClass == "juvenile") %>%
  select(c("obsDate", "groupName", "animalID")) %>%
  group_by(obsDate, groupName) %>%
  summarise(twinPairs = toString(sort(unique(animalID)))) %>%
  filter(str_detect(twinPairs, ",")) %>%
  separate_wider_delim(twinPairs, delim = ",", names = c("twin1", "twin2", "twin3"), too_few = "align_start") %>%
  as.data.frame() %>%
  select(-obsDate) %>%
  distinct() %>%
  arrange(groupName)
```

Export

```{r}
write.csv(twinList, "./paper3_demographics/01_dataOrganization/twinList.csv", row.names = F)
```

# SCRAPS

```{r}
# keep this for now
capData_animalID.microchip1 <- capData_animalID.microchip %>%
  select(c(rowID, animalID, microchip1)) %>%
  dplyr::rename("microchip" = "microchip1") %>%
  # rename NA for animalID/microchip to tbd (makes things easier later)
  mutate(animalID = as.character(animalID)) %>%
  mutate(
    animalID = case_when(
      is.na(animalID) ~ "tbd",
      .default = animalID
    ),
    microchip = case_when(
      is.na(microchip) ~ "tbd",
      .default = microchip
    )
  )

capData_animalID.microchip2 <- capData_animalID.microchip %>%
  select(c(rowID, animalID, microchip2)) %>%
  dplyr::rename("microchip" = "microchip2") %>%
  na.omit()

capData_animalID.microchip3 <- capData_animalID.microchip %>%
  select(c(rowID, animalID, microchip3)) %>%
  dplyr::rename("microchip" = "microchip3") %>%
  na.omit()

capData_animalID.microchip_unique <- rbind(capData_animalID.microchip1, capData_animalID.microchip2, capData_animalID.microchip3) %>%
  mutate(
    idChip = str_c(animalID, microchip, sep = "_")
  ) %>%
  mutate(
    ID = data.table::rowid(idChip)
  ) %>%
  filter(ID == "1") %>%
  select(c(rowID, animalID, microchip)) %>%
  mutate(
    animalID = case_when(
      animalID == "tbd" ~ NA,
      .default = animalID
    ),
    microchip = case_when(
      microchip == "tbd" ~ NA,
      .default = microchip
    )
  ) %>%
  dplyr::rename(
    "rowID_cap" = "rowID",
    "animalID_cap" = "animalID",
    "microchip_cap" = "microchip"
  ) %>%
  arrange(rowID_cap) %>%
  mutate(rowID_here = row_number()) %>%
  relocate(rowID_here)

capData_animalID.microchip_fillIDs <- capData_animalID.microchip_unique %>%
  # add fpi microchips by animalID
  merge(., fpiData_animalID.microchip_clean, by.x = "animalID_cap", by.y = "animalID_fpi", all.x = T) %>%
  # add fpi animalIDs by microchip
  merge(., fpiData_animalID.microchip_clean, by.x = "microchip_cap", by.y = "microchip_fpi", all.x = T) %>%
  replace(is.na(.), "tbd") %>%
  mutate(
    idChip_cap = str_c(animalID_cap, microchip_cap, sep = "_"),
    idChip_fpi = str_c(animalID_fpi, microchip_fpi, sep = "_")
  ) %>%
  select(c(rowID_here, rowID_cap, idChip_cap, idChip_fpi)) %>%
  arrange(rowID_here) %>%
  mutate(
    match = case_when(
      idChip_cap == idChip_fpi ~ "yes",
      .default = "no"
    )
  )

# going about this the wrong way I think...
```
